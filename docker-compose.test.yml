services:
  api:
    environment:
      - DISABLE_RATE_LIMIT=${DISABLE_RATE_LIMIT}
      - ADMIN_EMAIL=e2e-admin@example.com
      - WEBAUTHN_RP_ID=localhost
      - WEBAUTHN_ORIGIN=http://localhost:5173
      # Document storage (CI/E2E): MinIO
      - DOC_STORAGE_ENDPOINT=${DOC_STORAGE_ENDPOINT:-http://minio:9000}
      - DOC_STORAGE_REGION=${DOC_STORAGE_REGION:-fr-par-1}
      - DOC_STORAGE_BUCKET=${DOC_STORAGE_BUCKET:-top-ai-ideas-test}
      # IMPORTANT: avoid leaking real Scaleway creds from host env into test MinIO.
      - DOC_STORAGE_ACCESS_KEY=${DOC_STORAGE_ACCESS_KEY:-minioadmin}
      - DOC_STORAGE_SECRET_KEY=${DOC_STORAGE_SECRET_KEY:-minioadmin}
  e2e:
    network_mode: host
    image: ${REGISTRY}/${E2E_IMAGE_NAME:-top-ai-ideas-e2e}:${E2E_VERSION:-latest}
    build:
      context: ./e2e
      dockerfile: Dockerfile
    volumes:
      - ./e2e/tests:/app/tests
      - ./e2e/.auth:/app/.auth
      - ./e2e/test-results:/app/test-results
    depends_on:
      - postgres
      - api
      - ui
    command: sleep 1800

  ui:
    depends_on:
      api:
        condition: service_healthy

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}

  minio-init:
    image: minio/mc:latest
    profiles: ["init"]
    depends_on:
      minio:
        condition: service_started
    entrypoint: ["/bin/sh", "-c"]
    command: >
      until mc alias set local http://minio:9000 ${MINIO_ROOT_USER:-minioadmin} ${MINIO_ROOT_PASSWORD:-minioadmin}; do
        echo "waiting for minio..." && sleep 1;
      done;
      mc mb --ignore-existing local/${DOC_STORAGE_BUCKET:-top-ai-ideas-test} || true;
      mc anonymous set none local/${DOC_STORAGE_BUCKET:-top-ai-ideas-test} || true;
      exit 0
    restart: "no"
