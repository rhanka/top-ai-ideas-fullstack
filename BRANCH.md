# Feature: Minor UI and Tooling Evolutions

## Objective
Deliver a compact set of UX and tool behavior improvements around chat feedback, editable inputs, and automatic comments.

## Scope / Guardrails
- Scope limited to chat/toaster positioning, EditableInput behavior, impacted views (matrix and sector sizing), generation agents default comments, and modification-tool comments on changed fields.
- One migration max in `api/drizzle/*.sql` (if applicable).
- Make-only workflow, no direct Docker commands.
- Root workspace `~/src/top-ai-ideas-fullstack` is reserved for user dev/UAT (`ENV=dev`) and must remain stable.
- Branch development must happen in isolated worktree `tmp/feat-minor-evols-ui`.
- Automated test campaigns must run on dedicated environments (`ENV=test` / `ENV=e2e`), never on root `dev`.
- In every `make` command, `ENV=<env>` must be passed as the last argument.
- All new text in English.

## Environment Mapping
- Branch workspace: `tmp/feat-minor-evols-ui`
- Branch name: `feat/minor-evols-ui`
- Dedicated env vars:
  - `ENV=feat-minor-evols-ui`
  - `API_PORT=8788`
  - `UI_PORT=5179`
  - `MAILDEV_UI_PORT=1083`
  - `VITE_API_BASE_URL=http://localhost:8788`

## Questions / Notes
- Workflow note: this TODO item groups multiple needs; mono-branch is explicitly approved by user.
- Default comment proposal for generation agents (English, field-level): `Field "<field>" was generated by AI assistant. Please review and adjust if needed.`
- Modification tool comment granularity: one comment per modified field (explicitly requested by user).

## Orchestration Mode (AI-selected)
- [x] **Mono-branch + cherry-pick** (default for orthogonal tasks; single final test cycle)
- [ ] **Multi-branch** (only if sub-workstreams require independent CI or long-running validation)
- Rationale: user explicitly requested one isolated mini-branch for this grouped evolution.

## UAT Management (in orchestration context)
- **Mono-branch**: UAT is performed on the integrated branch only (after each lot, when UI changes exist).
- UAT checkpoints must be listed as checkboxes inside each relevant lot (no separate UAT section).
- Execution flow (mandatory):
  - Develop and run tests in `tmp/feat-minor-evols-ui`.
  - Push branch before UAT.
  - Run user UAT from root workspace (`~/src/top-ai-ideas-fullstack`, `ENV=dev`).
  - Switch back to `tmp/feat-minor-evols-ui` after UAT.

## Plan / Todo (lot-based)
- [x] **Lot 0 — Baseline & constraints**
  - [x] Read relevant `.mdc` files.
  - [x] Create/confirm isolated worktree `tmp/feat-minor-evols-ui` and run development there.
  - [x] Define environment mapping (`dev`, `test`, `e2e`) and dedicated ports for this branch.
  - [x] Confirm command style: `make ... <vars> ENV=<env>` with `ENV` last.
  - [x] Read `README.md` and extract impacted make targets for this feature.
  - [x] Extracted make targets for this branch:
    - [x] `make typecheck-ui ENV=test`
    - [x] `make lint-ui ENV=test`
    - [x] `make test-ui ENV=test` (if UI tests are changed)
    - [x] `make typecheck-api ENV=test` + `make lint-api ENV=test` (Lot 3 and beyond)
    - [x] `make test-api ENV=test` (Lot 3 and beyond)
    - [x] `make build-api build-ui-image API_PORT=8788 UI_PORT=5178 MAILDEV_UI_PORT=1082 ENV=e2e` (final E2E prep)
    - [x] `make clean test-e2e API_PORT=8788 UI_PORT=5178 MAILDEV_UI_PORT=1082 ENV=e2e` (final E2E gate)
  - [x] Scan impacted files and refine exact implementation/test file list.
  - [x] Initial impacted files list (Lot 1):
    - [x] `ui/src/lib/components/Toast.svelte` (toaster placement)
    - [x] `ui/src/lib/components/EditableInput.svelte` (save latency behavior)
  - [x] Initial test focus list (to refine after implementation):
    - [x] `e2e/tests/03-chat.spec.ts` (chat bubble + toast coexistence smoke check)
    - [x] `e2e/tests/06-settings.spec.ts` and `e2e/tests/02-organizations.spec.ts` (EditableInput save behavior smoke)

- [ ] **Lot 1 — Chat feedback & EditableInput latency**
  - [x] Move toaster to the bottom near the chat icon.
  - [x] Change EditableInput behavior from 5-second wait to immediate feedback.
  - [x] Lot gate: `make typecheck-ui ENV=test` + `make lint-ui ENV=test`.
  - [x] `make lint-ui ENV=test` passed.
  - [x] `make typecheck-ui ENV=test` passed.
  - [ ] UAT checklist (UI):
    - [x] Open a page with chat bubble and trigger one toast.
    - [!] Verify toast is no longer rendered in top-right (base position changed to bottom area). (pb on docker mode)
    - [x] Verify toast remains readable/clickable in all chat states.
    - [!] Open chat panel and trigger a toast again; ensure no blocking overlap with chat critical controls. (pb on docker mode)
    - [!] Edit one standard `EditableInput` field (single-line), stop typing, and verify consistent immediate save behavior across views. (ok for other, but loop back pb on org)
    - [!] Edit one markdown `EditableInput` field and verify the same immediate save behavior. (ok for other, but loop back pb on org)
    - [!] Confirm no duplicate save-error/success regressions in console and visible UX. (ok for other, but loop back pb on org)
  - [x] UAT findings to resolve before closing Lot 1:
    - [x] Toast can be hidden when chat is docked/open (bottom-right collision with chat UI). (ok, but UX not good)
    - [x] Save/update behavior is heterogeneous by view:
      - [!] `organizations/[id]`: immediate `PUT` + one immediate `GET` (acceptable baseline for now). (still ko)
      - [x] `folders/[id]`: `PUT` + delayed `GET`, repeated per keystroke sequence. (ok but no update in second user viewing the view)
      - [x] `dashboard` (executive summary / folder context): `PUT` + extra `GET` calls (observed double `GET` on folder id). (ok but no update in second user viewing the view)
      - [x] `matrix`: `PUT` only for tested EditableInput paths.
    - [x] User observed instability/loop behavior when returning to app in some scenarios (investigation required). (ok but no update in second user viewing the view) (ok but no update in second user viewing the view)

- [ ] **Lot 1B — Save/refresh stabilization after UAT findings**
  - [x] Define toast placement strategy compatible with chat dock:
    - [x] Keep toast visible when chat is open/docked (shift toast stack left of docked chat panel).
    - [x] Keep a single responsive rule that works for desktop + mobile and avoids overlap with bubble/chat panel.
    - [x] Refine anchor rules per chat state:
      - [x] chat closed: toast stack immediately left of bubble button, near bottom.
      - [x] chat floating open: toast stack left of floating chat panel, near bottom.
      - [x] chat docked open: toast stack left of docked panel, near bottom.
  - [x] Analyze and normalize post-`PUT` refresh behavior:
    - [x] Map each `EditableInput` flow (`organizations`, `folders`, `dashboard`, `matrix`) to identify who triggers extra `GET` (component handlers, store reloads, route effects, SSE listeners).
    - [x] Define a shared contract: immediate optimistic local update + SSE reconciliation; avoid redundant immediate `GET` where not required.
    - [x] Reduce duplicate `GET` bursts after typing/saving in `folders/[id]` and `dashboard` by removing forced post-save reloads.
    - [x] Ensure collaborative usecase updates are pushed via SSE on UI `PUT /use-cases/:id` (`NOTIFY usecase_events`).
  - [!] Investigate instability/loop symptoms:
    - [!] Reproduce loop scenario with deterministic steps.
    - [x] Isolate likely trigger path (organization markdown newline normalization + fast autosave churn).
    - [x] Mitigate likely trigger by removing line-break amplification in organization editable payloads (`organizations/new` and `organizations/[id]`).
    - [x] Add first guardrails to reduce self-triggered churn (short save debounce + no forced GET after each PUT).
    - [x] Delay saving spinner visibility to >1s to avoid per-keystroke flicker.
  - [x] Lot gate: `make typecheck-ui API_PORT=8789 UI_PORT=5180 MAILDEV_UI_PORT=1084 ENV=test` + `make lint-ui API_PORT=8789 UI_PORT=5180 MAILDEV_UI_PORT=1084 ENV=test`.
  - [x] API gate for collaboration change: `make typecheck-api API_PORT=8789 UI_PORT=5180 MAILDEV_UI_PORT=1084 ENV=test` + `make lint-api API_PORT=8789 UI_PORT=5180 MAILDEV_UI_PORT=1084 ENV=test`.
  - [x] UAT checklist (Lot 1B):
    - [x] Toast stays visible and actionable with chat closed, open, and docked.
    - [x] Toast vertical anchor is near bottom and aligned with bubble center when chat is closed.
    - [!] On `organizations/[id]`, `folders/[id]`, and `dashboard`, one user edit does not trigger redundant `GET` bursts. (ok except Org still KO)
    - [x] On `usecase/[id]`, collaborative edits from another session appear in real-time without manual refresh.
    - [!] No loop/freeze when leaving and returning to impacted pages. (org is freezing)
    - [x] Saving spinner appears only when a save actually lasts more than ~1s.

- [x] **Lot 1C — Orga loop deep-fix + executive summary collaboration hardening**
  - [x] Rebuild `organizations/[id]` EditableInput flow with field-scoped payloads (usecase-style buffers/originals), not full-object writes on each field save.
  - [x] Add deterministic diagnostics for orga save/SSE churn to isolate exact loop trigger in runtime.
  - [x] Add lock/presence UX to executive summary editing area (dashboard) to match collaborative object locking model.
  - [x] Validate executive summary live updates in collaborative scenario (2 sessions) and document expected stream behavior.
    - [x] Documented expected behavior: folder SSE (`folder_update`) remains source of truth for executive summary fields; local save is optimistic and reconciled by stream.
    - [x] Dual-session UAT validation completed on root workspace.
  - [x] Lot gate: `make typecheck-ui API_PORT=8789 UI_PORT=5180 MAILDEV_UI_PORT=1084 ENV=test` + `make lint-ui API_PORT=8789 UI_PORT=5180 MAILDEV_UI_PORT=1084 ENV=test`.
  - [x] UAT checklist (Lot 1C):
    - [x] On `organizations/[id]`, typing/editing does not create runaway save/render loop.
    - [x] Concurrent orga editing across two sessions remains stable and convergent.
    - [x] Executive summary shows lock state and prevents silent conflicting edits.
    - [x] Executive summary updates stream live between sessions.

- [ ] **Lot 2 — Editable inputs in views (matrix/sector sizing)**
  - [x] Matrix: switch axes EditableInput to text/markdown input mode.
  - [x] Fix sector view/input sizing issue (currently too small).
  - [x] Inspect and fix similar sizing issues on related views.
    - [x] Applied `fullWidth` and markdown editing to matrix axis fields (table + level-description modal) to avoid narrow inline inputs.
    - [x] Expanded organization industry field layout in header area to avoid compressed inline rendering.
  - [x] Lot gate: `make typecheck-ui API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui` + `make lint-ui API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`.
  - [x] UAT checklist (UI):
    - [x] In matrix view, edit both axes with text/markdown mode and verify save behavior + rendering.
    - [x] Confirm axis fields keep expected width/height and no clipping while editing.
    - [x] Validate sector-related field now has readable size (no compressed input).
    - [x] Spot-check at least two other similar inputs to confirm no remaining tiny-field regression.
    - [x] Validate desktop and mobile viewport behavior for edited inputs.

- [x] **Lot 3 — Automatic comments behavior**
  - [x] Generation agents: create a default comment.
  - [x] Modification tool: add a comment on modified fields.
  - [x] Fix usecase auto-comment `section_key` normalization (`data.*` -> canonical key) for generated and tool-updated comments. (`4abeae5`)
  - [x] Fix missing FR/EN labels in comment menu for resolved threads toggle. (`1298ec8`)
  - [ ] **Lot 3A — Locale-aware auto comments (Option 2.1, explicit app locale)**
    - [x] Add backend locale resolver utility (priority: `X-App-Locale` -> `Accept-Language` -> `fr` fallback).
    - [x] UI API client: send `X-App-Locale` from application-selected locale (`localStorage` app setting), not browser default locale.
    - [x] Propagate locale from API routes to queued generation jobs:
      - [x] `POST /use-cases/generate`
      - [x] `POST /use-cases/:id/detail`
      - [x] `POST /organizations/:id/enrich`
      - [x] `POST /analytics/executive-summary`
      - [x] `POST /chat/messages` and `POST /chat/messages/:id/retry`
    - [x] Extend queue job payload types and propagation chain so locale is preserved across nested jobs (e.g. `usecase_list` -> `usecase_detail` -> `executive_summary`).
    - [x] Localize auto-comment content at write time in:
      - [x] `ToolService.createAutoFieldComments` (tool updates)
      - [x] `QueueManager.createAutoGenerationFieldComments` (generation jobs)
    - [x] Keep usecase `section_key` normalization behavior intact while localizing message text.
    - [x] Lot gate: `make typecheck-api API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui` + `make lint-api API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`.
    - [x] UI gate for header injection changes: `make typecheck-ui API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui` + `make lint-ui API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`.
  - [x] Lot gate: `make typecheck-api ENV=test` + `make lint-api ENV=test` (+ UI gates if needed).
  - [x] UAT checklist:
    - [x] Trigger a generation flow and verify comments are created for each generated field.
    - [x] Verify generated comment text matches expected field-level template.
    - [x] Trigger a tool-based update changing multiple fields.
    - [x] Verify one comment is created per modified field (not one global comment).
    - [x] Verify comment linkage (object/section/field context) is correct for each created comment.
    - [x] With app locale explicitly set to `fr`, trigger one generation and one tool update; verify created auto-comments are in French.
    - [x] With app locale explicitly set to `en`, trigger one generation and one tool update; verify created auto-comments are in English.
    - [x] Locale source validation: keep browser locale opposite to app locale and verify auto-comment language follows app locale (`X-App-Locale`), not browser default.
    - [x] Usecase header bubble validation: generated/updated comments on usecase fields appear on canonical section keys (no new `data.*` keys created).

- [ ] **Lot 4 — Comment review UX and field label localization**
  - [x] Switch comment badge visual to design-system primary color (icon + count pill).
  - [x] Add missing comment bubbles on usecase score headers:
    - [x] `valueScores`
    - [x] `complexityScores`
  - [x] Localize field labels in auto-generated/auto-modified comments (backend write-time):
    - [x] QueueManager generation comments
    - [x] ToolService field-modification comments
  - [x] Move comment review actions from chat top header into comment sub-header:
    - [x] `chat.comments.chooseThread` => comments list action in sub-header
    - [x] `chat.comments.newThread` => new comment action in sub-header
    - [x] `chat.comments.resolve` => resolve/reopen action in sub-header
  - [x] Localize sub-header section target labels (avoid technical keys like `constraints`).
  - [x] Add review flow helpers in sub-header:
    - [x] Auto-switch to next open comment after resolving current one.
    - [x] Add previous/next comment navigation buttons with arrows.
  - [x] UAT-driven header refinements (4B):
    - [x] Comments hint text now depends on thread availability:
      - [x] FR/EN copy for "select existing comment or write one" when threads exist.
      - [x] FR/EN copy for "no comment yet, you can write one" when no thread exists.
    - [x] Add `Chat IA` sub-header with session title and move session actions there (`list` / `new` / `delete`).
    - [x] Add `Jobs` sub-header and move jobs actions there.
    - [x] Remove duplicated jobs minus action (`-`) and keep single clear purge action in jobs sub-header.
    - [x] Keep top header contextual actions hidden for comments mode; top header remains global controls (tabs + panel/close).
  - [x] Executive summary comments parity (4D):
    - [x] Dashboard now loads comment counts for `context_type=executive_summary` (folder-scoped id).
    - [x] Add comment badges on executive summary section headers:
      - [x] `Synthèse exécutive` (`synthese_executive`)
      - [x] `Introduction`
      - [x] `Analyse`
      - [x] `Recommandations`
      - [x] `Références`
    - [x] Clicking a badge opens comment panel on `executive_summary` context + matching `sectionKey`.
    - [x] Dashboard SSE listener now refreshes counts on `comment_update` for `executive_summary`.
    - [x] Route-level comments context alignment: `/dashboard` defaults to `executive_summary` in chat widget.
    - [x] Normalize executive summary section-key mappings (`synthese_executive`, `analysis`, `recommendations`, `references`) in:
      - [x] UI section-label maps (`ChatWidget`, `ChatPanel`)
      - [x] Auto-comment field label localization (`QueueManager`, `ToolService`)
      - [x] i18n labels (`chat.sections.executiveSummary.references`)
  - [x] Update FR/EN labels:
    - [x] `chat.comments.chooseThread` ("Liste des commentaires" / "Comments list")
    - [x] `chat.comments.newThread` ("Nouveau commentaire" / "New comment")
    - [x] `chat.comments.resolve` ("Résoudre le commentaire" / "Resolve comment")
    - [x] `chat.comments.previous` + `chat.comments.next`
    - [x] Add missing `chat.sections.usecase.*` keys for constraints + score groups.
  - [x] Lot 4E — Field coverage alignment (name/domain) + generation payload sanitization:
    - [x] Prompt cleanup committed separately: remove `prerequisites` from `use_case_detail` default prompt schema.
    - [x] Add missing `name/title` comment badges in UI headers:
      - [x] `/folders/[id]` folder title
      - [x] `/usecase/[id]` usecase title
      - [x] `/dashboard` folder title
    - [x] Usecase information block realigned to field labels + per-field badges:
      - [x] `Contact` as label + `EditableInput` + `CommentBadge`
      - [x] `Domaine/Domain` as label + `EditableInput` + `CommentBadge`
    - [x] Domain localization alignment:
      - [x] `chat.sections.usecase.domain` added in FR/EN locales
      - [x] `usecase.info.domain` added in FR/EN locales
      - [x] Chat section label maps updated (`ChatWidget`, `ChatPanel`)
      - [x] Auto-comment label maps updated (`QueueManager`, `ToolService`)
    - [x] Filter unsupported generated detail fields before persistence in `use_cases.data`:
      - [x] Remove `process` mapping from queue detail generation writes.
      - [x] Remove `prerequisites` mapping from queue detail generation writes.
    - [x] Organization detail parity:
      - [x] Add comment badge on organization title (`name`) in `/organizations/[id]`.
      - [x] Add comment badge on sector field (`industry`) in `/organizations/[id]`.
    - [x] Template update:
      - [x] `api/templates/usecase-onepage.docx` amended to include `domain`.
  - [x] Lot gate:
    - [x] `make typecheck-ui API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
    - [x] `make lint-ui API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
    - [x] `make typecheck-api API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
    - [x] `make lint-api API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
  - [ ] **Lot 4C — Primary color harmonization (analysis only, no code change yet)**
    - [x] Exhaustive inventory completed for `.svelte` occurrences of:
      - [x] `bg-slate-900` / `bg-slate-900/40`
      - [x] `bg-indigo-600` + `hover:bg-indigo-700`
      - [x] `bg-blue-600` + `hover:bg-blue-700`
    - [x] Inventory summary: `28` occurrences across `14` `.svelte` files:
      - [x] `ui/src/lib/components/AdminUsersPanel.svelte`
      - [x] `ui/src/lib/components/ChatPanel.svelte`
      - [x] `ui/src/lib/components/ChatWidget.svelte`
      - [x] `ui/src/lib/components/Header.svelte`
      - [x] `ui/src/lib/components/ImportExportDialog.svelte`
      - [x] `ui/src/lib/components/NavigationGuard.svelte`
      - [x] `ui/src/lib/components/QueueMonitor.svelte`
      - [x] `ui/src/lib/components/WorkspaceSettingsPanel.svelte`
      - [x] `ui/src/routes/auth/devices/+page.svelte`
      - [x] `ui/src/routes/auth/login/+page.svelte`
      - [x] `ui/src/routes/auth/register/+page.svelte`
      - [x] `ui/src/routes/dashboard/+page.svelte`
      - [x] `ui/src/routes/matrix/+page.svelte`
      - [x] `ui/src/routes/settings/+page.svelte`
    - [x] Token counts (global):
      - [x] `bg-blue-600`: `11`
      - [x] `hover:bg-blue-700`: `9`
      - [x] `bg-indigo-600`: `10`
      - [x] `hover:bg-indigo-700`: `8`
      - [x] `bg-slate-900`: `6`
      - [x] `bg-slate-900/40`: `1`
    - [x] Execution applied:
      - [x] Replaced all `bg-blue-600` + `bg-indigo-600` + `bg-slate-900` by `bg-primary` (buttons/badges/messages).
      - [x] Replaced all hover variants `hover:bg-blue-700` + `hover:bg-indigo-700` by `hover:bg-primary/90`.
      - [x] Normalized mobile widget backdrop to the modal pattern `bg-black bg-opacity-40` (overlay semantics), and aligned explicit chat `close` button styling with existing header action buttons.
      - [x] Post-change grep gate: no remaining targeted tokens (`bg-blue-600`, `bg-indigo-600`, `bg-slate-900`, hover variants) in `.svelte`.
  - [x] UAT checklist:
    - [x] In usecase view, comment bubble is primary-colored (not black) on cards and score headers.
    - [x] Bubbles are visible/clickable on `Axes de Valeur` and `Axes de Complexité` headers.
    - [x] In comments tab sub-header, actions appear there (not in top widget header): list, new comment, resolve/reopen.
    - [x] Sub-header shows localized section name (e.g. `Contraintes` / `Constraints`), never technical key.
    - [x] Resolve one open comment and verify automatic selection jumps to next open comment.
    - [x] Previous/next arrow buttons navigate between available comment threads.
    - [x] Auto-generated comments use localized field labels in FR and EN.
    - [x] AI marker parity: comments created by generation and by tool-based updates both display the AI marker (brain icon / Assistant IA) in comment threads.
    - [x] Name/title comment badges appear (with count when comments exist) on `/folders/[id]`, `/usecase/[id]`, and `/dashboard`.
    - [x] Clicking each `name/title` badge opens the matching comments context and `sectionKey=name`.
    - [x] On `/organizations/[id]`, title (`name`) and sector (`industry`) show comment badges with counts and open their exact section keys when clicked.
    - [x] Export/render path using `api/templates/usecase-onepage.docx` includes `domain` where expected.
    - [x] In usecase "Informations", `Contact` and `Domaine/Domain` are displayed as label + editable field, each with its own comment badge next to the label.
    - [x] After usecase detail generation, `data.domain` is persisted when generated, and unsupported fields (`data.process`, `data.prerequisites`) are not written by queue generation.
    - [x] On `/dashboard`, each executive summary header shows the comment badge with count.
    - [x] On `/dashboard`, clicking each badge opens comments in `executive_summary` context with the expected section preselected.
    - [x] After generating executive summary, auto-comments appear for generated fields (`introduction`, `analyse`, `recommandation`, `synthese_executive`) and badges update without full refresh.

- [x] **Lot N-1 — Docs consolidation**
  - [x] Branch-wide implementation inventory completed (Lots 1 -> 4):
    - [x] Save/live-update stabilization aligned across `organizations/[id]`, `usecase/[id]`, `folder/[id]`, `dashboard`, and matrix main/modals.
    - [x] Matrix/Lot 2 UI refinements delivered (axis editing UX + modal spacing + sector label copy update).
    - [x] Auto-comment engine delivered for generation/tool updates with app-locale sourcing (`X-App-Locale`) and AI marker parity.
    - [x] Comment review UX delivered (sub-headers, localized labels, next/previous navigation, auto-jump after resolve).
    - [x] Executive summary parity delivered (`dashboard` badges + section routing + SSE refresh).
    - [x] Field coverage completed for comment badges: `name/title` (folder/usecase/dashboard/organization), `industry`, `domain`.
    - [x] Generation payload hardening delivered: unsupported detail fields (`process`, `prerequisites`) filtered before persistence.
  - [x] Add a short spec addendum documenting canonical section-key conventions and comment-context routing per view (`usecase`, `organization`, `folder`, `executive_summary`).
      - [x] Added in `spec/SPEC.md` section `12.1`.

- [x] **Lot N — Final validation**
  - [x] **API tests**
    - [x] Static gates (API):
      - [x] `make -C tmp/feat-minor-evols-ui typecheck-api API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
      - [x] `make -C tmp/feat-minor-evols-ui lint-api API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
    - [x] Identify/update impacted API tests:
      - [x] `api/tests/api/comments.test.ts`
      - [x] `api/tests/api/use-cases-generate-matrix.test.ts`
      - [x] `api/tests/unit/context-usecase-detail-contract.test.ts`
      - [x] `api/tests/unit/queue-manager-contract.test.ts`
    - [x] Scoped runs while evolving:
      - [x] `make -C tmp/feat-minor-evols-ui test-api SCOPE=tests/api/comments.test.ts API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
      - [x] `make -C tmp/feat-minor-evols-ui test-api SCOPE=tests/api/use-cases-generate-matrix.test.ts API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
      - [x] `make -C tmp/feat-minor-evols-ui test-api SCOPE=tests/unit/context-usecase-detail-contract.test.ts API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
      - [x] `make -C tmp/feat-minor-evols-ui test-api SCOPE=tests/unit/queue-manager-contract.test.ts API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
      - [x] `make -C tmp/feat-minor-evols-ui test-api-endpoints SCOPE=tests/api/auth/session.test.ts API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
      - [x] `make -C tmp/feat-minor-evols-ui test-api-endpoints SCOPE=tests/api/locks.test.ts API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
    - [x] Remaining API assertions:
      - [x] auto-comment section-key mapping (`name`, `industry`, `domain`, `executive_summary.*`)
      - [x] generation payload sanitization (`process`/`prerequisites` not persisted)
    - [x] Sub-lot gate: `make test-api ENV=test`.
      - [x] `make -C tmp/feat-minor-evols-ui test-api API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui DISABLE_RATE_LIMIT=true`
  - [x] **UI tests (TypeScript only)**
    - [x] Static gates (UI):
      - [x] `make -C tmp/feat-minor-evols-ui typecheck-ui API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
      - [x] `make -C tmp/feat-minor-evols-ui lint-ui API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
    - [x] Identify/update impacted UI tests:
      - [x] `ui/tests/utils/comments.test.ts`
      - [x] `ui/tests/utils/api.test.ts`
      - [x] `ui/tests/utils/comment-counts.test.ts`
    - [x] Scoped runs while evolving:
      - [x] `make -C tmp/feat-minor-evols-ui test-ui SCOPE=tests/utils/comments.test.ts API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
      - [x] `make -C tmp/feat-minor-evols-ui test-ui SCOPE=tests/utils/api.test.ts API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
      - [x] `make -C tmp/feat-minor-evols-ui test-ui SCOPE=tests/utils/comment-counts.test.ts API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
    - [x] Remaining UI assertions:
      - [x] comment badge count visibility logic on section headers
    - [x] Sub-lot gate: `make test-ui ENV=test`.
      - [x] `make -C tmp/feat-minor-evols-ui test-ui API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
  - [x] **E2E tests**
    - [x] Prepare E2E build: `make build-api build-ui-image API_PORT=8788 UI_PORT=5178 MAILDEV_UI_PORT=1082 ENV=e2e-feat-minor-evols-ui`.
      - [x] Build now passes for API + UI images on branch CI path.
    - [x] Identify/update impacted E2E tests:
      - [x] `e2e/tests/05-usecase-detail.spec.ts` (header badges / comments flow)
      - [x] `e2e/tests/01-organizations-detail.spec.ts` (organization detail comments/header)
      - [x] `e2e/tests/03-dashboard.spec.ts` (executive summary/dashboard flows)
      - [x] `e2e/tests/07_comment_assistant.spec.ts` (AI comment badge behavior)
      - [x] comment badge counters visible and clickable on headers (`/usecase/[id]`, `/organizations/[id]`, `/dashboard`).
      - [x] generated usecase detail persists `domain` and excludes unsupported fields (`process`, `prerequisites`) in effective payload.
    - [x] Scoped runs while evolving:
      - [x] `make -C tmp/feat-minor-evols-ui test-e2e E2E_SPEC=tests/03-dashboard.spec.ts WORKERS=1 RETRIES=0 MAX_FAILURES=1 API_PORT=8788 UI_PORT=5178 MAILDEV_UI_PORT=1082 ENV=e2e-feat-minor-evols-ui`
      - [x] `make -C tmp/feat-minor-evols-ui test-e2e E2E_SPEC=tests/05-usecase-detail.spec.ts WORKERS=1 RETRIES=0 MAX_FAILURES=1 API_PORT=8788 UI_PORT=5178 MAILDEV_UI_PORT=1082 ENV=e2e-feat-minor-evols-ui`
      - [x] `make -C tmp/feat-minor-evols-ui test-e2e E2E_SPEC=tests/07-matrix.spec.ts WORKERS=1 RETRIES=0 MAX_FAILURES=1 API_PORT=8788 UI_PORT=5178 MAILDEV_UI_PORT=1082 ENV=e2e-feat-minor-evols-ui`
      - [x] `make -C tmp/feat-minor-evols-ui test-e2e E2E_GROUPS="03 04 05" WORKERS=1 RETRIES=0 MAX_FAILURES=1 API_PORT=8788 UI_PORT=5178 MAILDEV_UI_PORT=1082 ENV=e2e-feat-minor-evols-ui`
      - [x] `make -C tmp/feat-minor-evols-ui test-e2e E2E_GROUPS="06 07" WORKERS=1 RETRIES=0 MAX_FAILURES=1 API_PORT=8788 UI_PORT=5178 MAILDEV_UI_PORT=1082 ENV=e2e-feat-minor-evols-ui`
    - [x] CI final gate: `test-e2e (group-a, 00 01 02)`, `test-e2e (group-b, 03 04 05)`, and `test-e2e (group-c, 06 07)` all green on run `22198601064` (SHA `5de2863`).
    - [x] Sub-lot gate: `make clean test-e2e API_PORT=8788 UI_PORT=5178 MAILDEV_UI_PORT=1082 ENV=e2e-feat-minor-evols-ui` (CI equivalent green).
  - [x] Final gate: PR created (`#60`) with branch CI fully green.
  - [x] Final wrap-up: `TODO.md` updated; `BRANCH.md` intentionally kept in branch (per explicit user request).

- [ ] **Lot Rebase — Integration on top of `main` (post `feat/chrome-plugin` merge)**
  - [x] Inputs and constraints
    - [x] Rebase target confirmed: `origin/main` after `feat/chrome-plugin` merge.
    - [x] Conflict inventory confirmed via merge simulation: 8 files (`BRANCH.md`, `api/src/routes/api/chat.ts`, `api/src/services/chat-service.ts`, `api/src/services/queue-manager.ts`, `ui/src/lib/components/ChatPanel.svelte`, `ui/src/lib/components/ChatWidget.svelte`, `ui/src/lib/components/EditableInput.svelte`, `ui/src/lib/utils/api.ts`).
    - [x] Detailed divergence analysis written in non-committed `/tmp/ANALYSE_REBASE.md` with conflict hunks + proposed action.
  - [x] Rebase A — API contract merge (`chat.ts`, `chat-service.ts`, `queue-manager.ts`, `ui/src/lib/utils/api.ts`)
    - [x] Kept `main` extension API/runtime flows (`localToolDefinitions`, `/chat/messages/:id/tool-results`, tool-permissions lifecycle).
    - [x] Re-applied minor evols API behavior:
      - [x] locale propagation (`X-App-Locale` -> queue jobs -> tool update comments),
      - [x] auto-comment section-key normalization,
      - [x] usecase detail payload sanitization (`domain` kept, `process`/`prerequisites` excluded).
    - [x] Tech gates executed:
      - [x] `make typecheck-api API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
      - [x] `make lint-api API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
      - [x] Scoped API tests:
        - [x] `make test-api-endpoints SCOPE=tests/api/chat.test.ts API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
        - [x] `make test-api-endpoints SCOPE=tests/api/chat-permissions.test.ts API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
        - [x] `make test-api-endpoints SCOPE=tests/api/comments.test.ts API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
        - [x] `make test-api-endpoints SCOPE=tests/api/use-cases-generate-matrix.test.ts API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
        - [x] `make test-api-unit SCOPE=tests/unit/chat-service-tools.test.ts API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
        - [x] `make test-api-unit SCOPE=tests/unit/queue-manager-contract.test.ts API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
        - [x] `make test-api-unit SCOPE=tests/unit/context-usecase-detail-contract.test.ts API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
  - [x] Rebase B — Chat UI merge (`ChatPanel.svelte`, `ChatWidget.svelte`)
    - [x] Kept `main` extension UX/runtime blocks (side panel, auth menu, endpoint health, permissions cards, local tool prompts).
    - [x] Kept minor evols comment-review UX:
      - [x] sub-header actions for comments,
      - [x] localized section labels in comment header,
      - [x] previous/next + auto-jump after resolve,
      - [x] badge visual token (`bg-primary`) and count behavior parity.
    - [x] Tech gates executed:
      - [x] `make typecheck-ui API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
      - [x] `make lint-ui API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
      - [x] Scoped UI tests:
        - [x] `make test-ui SCOPE=tests/utils/api.test.ts API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
        - [x] `make test-ui SCOPE=tests/utils/comments.test.ts API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
        - [x] `make test-ui SCOPE=tests/utils/comment-counts.test.ts API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
        - [x] `make test-ui SCOPE=tests/utils/chat-tool-scope.test.ts API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
        - [x] `make test-ui SCOPE=tests/chrome-ext/tool-permissions.test.ts API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
        - [x] `make test-ui SCOPE=tests/chrome-ext/tool-executor.test.ts API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
      - [x] E2E test fixes aligned with merged UI:
        - [x] `e2e/tests/00-access-control.spec.ts` comment-tab/thread selection locators and role assertions updated.
        - [x] `e2e/tests/04-tenancy-workspaces.spec.ts` comment-tab selector updated.
  - [x] Rebase C — EditableInput merge (`EditableInput.svelte`)
    - [x] Immediate autosave / delayed saving indicator behavior preserved.
    - [x] Non-reg reference navigation behavior from `main` preserved (no full-page reload on reference click).
    - [x] Coverage validated in E2E flows (`01-organizations-detail`, `03-dashboard`, `05-usecase-detail`, `07-matrix`).
  - [x] Rebase technical final gates (one-pass)
    - [x] E2E CI-equivalent groups executed:
      - [x] `make test-e2e E2E_GROUPS="00 01 02" WORKERS=1 RETRIES=0 MAX_FAILURES=1 API_PORT=8788 UI_PORT=5178 MAILDEV_UI_PORT=1082 ENV=e2e-feat-minor-evols-ui`
      - [x] `make test-e2e E2E_GROUPS="03 04 05" WORKERS=1 RETRIES=0 MAX_FAILURES=1 API_PORT=8788 UI_PORT=5178 MAILDEV_UI_PORT=1082 ENV=e2e-feat-minor-evols-ui`
      - [x] `make test-e2e E2E_GROUPS="06 07" WORKERS=1 RETRIES=0 MAX_FAILURES=1 API_PORT=8788 UI_PORT=5178 MAILDEV_UI_PORT=1082 ENV=e2e-feat-minor-evols-ui`
    - [x] Targeted reruns for merged-selector regressions:
      - [x] `make test-e2e E2E_SPEC=tests/00-access-control.spec.ts WORKERS=1 RETRIES=0 MAX_FAILURES=1 API_PORT=8788 UI_PORT=5178 MAILDEV_UI_PORT=1082 ENV=e2e-feat-minor-evols-ui`
      - [x] `make test-e2e E2E_SPEC=tests/04-tenancy-workspaces.spec.ts WORKERS=1 RETRIES=0 MAX_FAILURES=1 API_PORT=8788 UI_PORT=5178 MAILDEV_UI_PORT=1082 ENV=e2e-feat-minor-evols-ui`
  - [x] Single UAT (root workspace `~/src/top-ai-ideas-fullstack`, one pass, conflict-focused)
    - [x] UAT Web app
      - [x] `api/src/services/queue-manager.ts`: run one generation (`usecase detail`) and verify persisted payload keeps `domain` and excludes `process`/`prerequisites`.
      - [x] `ui/src/lib/utils/api.ts`: switch app locale (`FR`/`EN`) and verify auto-comments language follows app locale (not browser locale).
      - [x] `ui/src/lib/components/ChatPanel.svelte`: in Comments tab, verify sub-header actions (list/new/resolve/prev/next), and confirm those actions are no longer duplicated in top chat header while on comments tab.
      - [x] `ui/src/lib/components/ChatWidget.svelte`: in web app mode, verify `Chat IA` and `Jobs` actions are in their own sub-headers (not in top header), with regular icon spacing.
      - [x] `ui/src/lib/components/Toast.svelte`: verify toast placement in all three states:
        - [x] chat closed: toast bottom-aligned, just left of bubble button (not above).
        - [x] chat docked open: toast bottom-aligned, left of docked panel.
        - [x] chat floating open: toast bottom-aligned, left of floating widget, no overlap.
      - [x] `ui/src/lib/components/ChatPanel.svelte`: verify localized comment hint text:
        - [x] when at least one thread exists: "Sélectionne un commentaire ou écris un commentaire" / "Select a comment or write a comment".
        - [x] when no thread exists: "Il n'y a pas de commentaire, tu peux en écrire un" / "There are no comments yet, you can write one".
      - [x] `ui/src/lib/components/ChatPanel.svelte`: verify localized section label in comment sub-header (no technical key like `constraints`/`data.constraints`).
      - [x] `ui/src/lib/components/ChatPanel.svelte`: resolve one open comment and verify auto-jump to next comment works; verify previous/next navigation buttons work.
      - [x] `ui/src/lib/components/CommentBadge.svelte` + route headers: verify badge icon and counter use primary token (no black/slate badge), and counters are visible without hover when comments exist.
      - [x] Header badge parity checks:
        - [x] `/usecase/[id]`: badges visible/clickable on title, constraints, value/complexity score headers.
        - [x] `/organizations/[id]`: badges visible/clickable on name and industry.
        - [x] `/dashboard`: badges visible/clickable on folder title and executive summary section headers (`synthese_executive`, `introduction`, `analysis`, `recommendations`, `references`).
      - [x] `ui/src/lib/components/EditableInput.svelte`: type on `/organizations/[id]`, `/usecase/[id]`, `/dashboard`, `/matrix` with no full reload/flicker and immediate save feedback.
      - [x] `ui/src/lib/components/EditableInput.svelte`: verify saving indicator does not flash at each keystroke; it should only appear on slower saves (>~1s).
      - [x] Collaboration non-reg:
        - [x] `/usecase/[id]` and `/organizations/[id]`: second user sees live update without manual refresh.
        - [x] `/dashboard` and `/matrix` (main + modal edited fields): second user sees live update without manual refresh.
    - [ ] UAT Plugin Chrome
      - [x] `api/src/routes/api/chat.ts`: send one chat message with local tools enabled and verify `tool-results` resume keeps same conversation stream.
      - [x] `api/src/services/chat-service.ts`: run one `tab_read` + one `tab_action` from extension and verify assistant resumes without manual retry.
      - [x] `ui/src/lib/components/ChatWidget.svelte`: extension non-reg (floating + side panel, explicit auth/connect, endpoint health menu, permission cards).
      - [x] `ui/src/lib/components/ChatWidget.svelte`: verify comments tab remains hidden/disabled in plugin mode as specified, while Chat IA / Jobs stay functional.
      - [x] `ui/src/lib/components/ChatPanel.svelte`: verify chat/jobs actions are in sub-header (not duplicated in top header) and spacing/layout remain aligned with main style.
      - [x] `ui/src/lib/components/Toast.svelte`: extension overlay/docked parity for toast placement (left of bubble/panel, bottom aligned, no overlap in floating mode).
      - [x] Local tools permission flow:
        - [x] one-time allow prompts again next call.
        - [x] always allow persists after extension reload.
        - [x] never allow persists after extension reload and blocks execution.
      - [x] Local tools toggles:
        - [x] disabling `tab_read` removes it from `localToolDefinitions`.
        - [x] disabling `tab_action` removes it from `localToolDefinitions`.
      - [ ] Minor Fix (already there before merge)
        - [x] Enable web_search and web_extract in chrome plugin
        - [x] In dashboard view (webapp) comments on "name" (folder) are not localized and comment can't be closed
  - [ ] Push & gh CI
  - [ ] rm BRANCH.md then merge