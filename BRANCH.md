# Feature: Use case constraints (data + UI/print)

## Objective
Add constraints to use cases in the data model and surface them in UI/print.

## Scope / Guardrails
- Scope limited to use case constraints in data model, UI, and print.
- One migration max in `api/drizzle/*.sql` (avoid — JSONB, no migration needed).
- Make-only workflow, no direct Docker commands.
- All new text in English.

## Scoping Decisions
- **AI-generated**: Yes, constraints must be generated by the AI (modify prompt).
- **Color**: Same color as risks (red).
- **UI layout**: 2x2 grid: Benefits | Constraints / Success Metrics | Risks.
- **Constraint types**: All types (technical, business, regulatory, etc.).
- **No migration needed**: `data` is JSONB, adding `constraints?: string[]` to TypeScript type is sufficient.

## Orchestration Mode (AI-selected)
- [ ] **Mono-branch + cherry-pick**
- [x] **Multi-branch**
- Rationale: Grouped data + UI/print to keep waves at four branches.

## UAT Management (in orchestration context)
- **Multi-branch**: no UAT on sub-branches; UAT happens only after integration on the main branch.

## Plan / Todo (lot-based)
- [ ] **Lot 0 — Baseline & constraints**
  - [x] Read the relevant `.mdc` files and `README.md`.
  - [x] Capture Makefile targets needed for debug/testing.
  - [x] Confirm scope and guardrails.
  - [x] Scoping decisions confirmed by user.

- [x] **Lot 1 — Data model + API + AI prompt**
  - [x] Add `constraints?: string[]` to `UseCaseData` type in `api/src/types/usecase.ts`.
  - [x] Add `constraints` to Zod validation in `api/src/routes/api/use-cases.ts`.
  - [x] Update `buildUseCaseData()` to handle constraints.
  - [x] Add `constraints` to AI prompt in `api/src/config/default-prompts.ts`.
  - [x] Add `constraints` to OpenAI structured output schema in `api/src/services/context-usecase.ts`.
  - [x] Add `constraints` to UI type in `ui/src/lib/stores/useCases.ts`.
  - [ ] Lot gate: `make typecheck-api` + `make lint-api`

- [x] **Lot 2 — UI display + print**
  - [x] Add `parsedConstraints` reactive variable in `UseCaseDetail.svelte`.
  - [x] Restructure UI grid to 2x2: Benefits | Constraints / Success Metrics | Risks.
  - [x] Use same red color as risks for constraints.
  - [x] Use `EditableInput` pattern for editing (same as other lists).
  - [x] Update print CSS if needed for the new 2x2 layout.
  - [ ] Lot gate: `make typecheck-ui` + `make lint-ui`
  - [x] UAT: Use case detail shows 2x2 grid with constraints (edit + print preview)
  - [x] UAT: Chat IA update bullet list fields live in UI (benefits, constraints, ...)

- [ ] **Lot N — Final validation**
  - [x] E2E: chat met a jour un champ liste (SSE)
  - [ ] Sub-lot gate: `make test-api`
  - [ ] Sub-lot gate: `make test-ui`
  - [ ] Prepare E2E build: `make build-api build-ui-image`
  - [ ] Sub-lot gate: `make clean test-e2e`
  - [ ] Final gate: Create PR with BRANCH.md content & verify CI
  - [ ] Final commit removes `BRANCH.md` and checks `TODO.md`
