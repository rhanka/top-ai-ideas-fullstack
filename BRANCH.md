# Feature: Minor UI and Tooling Evolutions

## Objective
Deliver a compact set of UX and tool behavior improvements around chat feedback, editable inputs, and automatic comments.

## Scope / Guardrails
- Scope limited to chat/toaster positioning, EditableInput behavior, impacted views (matrix and sector sizing), generation agents default comments, and modification-tool comments on changed fields.
- One migration max in `api/drizzle/*.sql` (if applicable).
- Make-only workflow, no direct Docker commands.
- Root workspace `~/src/top-ai-ideas-fullstack` is reserved for user dev/UAT (`ENV=dev`) and must remain stable.
- Branch development must happen in isolated worktree `tmp/feat-minor-evols-ui`.
- Automated test campaigns must run on dedicated environments (`ENV=test` / `ENV=e2e`), never on root `dev`.
- In every `make` command, `ENV=<env>` must be passed as the last argument.
- All new text in English.

## Environment Mapping
- Branch workspace: `tmp/feat-minor-evols-ui`
- Branch name: `feat/minor-evols-ui`
- Dedicated env vars:
  - `ENV=feat-minor-evols-ui`
  - `API_PORT=8788`
  - `UI_PORT=5179`
  - `MAILDEV_UI_PORT=1083`
  - `VITE_API_BASE_URL=http://localhost:8788`

## Questions / Notes
- Workflow note: this TODO item groups multiple needs; mono-branch is explicitly approved by user.
- Default comment proposal for generation agents (English, field-level): `Field "<field>" was generated by AI assistant. Please review and adjust if needed.`
- Modification tool comment granularity: one comment per modified field (explicitly requested by user).

## Orchestration Mode (AI-selected)
- [x] **Mono-branch + cherry-pick** (default for orthogonal tasks; single final test cycle)
- [ ] **Multi-branch** (only if sub-workstreams require independent CI or long-running validation)
- Rationale: user explicitly requested one isolated mini-branch for this grouped evolution.

## UAT Management (in orchestration context)
- **Mono-branch**: UAT is performed on the integrated branch only (after each lot, when UI changes exist).
- UAT checkpoints must be listed as checkboxes inside each relevant lot (no separate UAT section).
- Execution flow (mandatory):
  - Develop and run tests in `tmp/feat-minor-evols-ui`.
  - Push branch before UAT.
  - Run user UAT from root workspace (`~/src/top-ai-ideas-fullstack`, `ENV=dev`).
  - Switch back to `tmp/feat-minor-evols-ui` after UAT.

## Plan / Todo (lot-based)
- [x] **Lot 0 — Baseline & constraints**
  - [x] Read relevant `.mdc` files.
  - [x] Create/confirm isolated worktree `tmp/feat-minor-evols-ui` and run development there.
  - [x] Define environment mapping (`dev`, `test`, `e2e`) and dedicated ports for this branch.
  - [x] Confirm command style: `make ... <vars> ENV=<env>` with `ENV` last.
  - [x] Read `README.md` and extract impacted make targets for this feature.
  - [x] Extracted make targets for this branch:
    - [x] `make typecheck-ui ENV=test`
    - [x] `make lint-ui ENV=test`
    - [x] `make test-ui ENV=test` (if UI tests are changed)
    - [x] `make typecheck-api ENV=test` + `make lint-api ENV=test` (Lot 3 and beyond)
    - [x] `make test-api ENV=test` (Lot 3 and beyond)
    - [x] `make build-api build-ui-image API_PORT=8788 UI_PORT=5178 MAILDEV_UI_PORT=1082 ENV=e2e` (final E2E prep)
    - [x] `make clean test-e2e API_PORT=8788 UI_PORT=5178 MAILDEV_UI_PORT=1082 ENV=e2e` (final E2E gate)
  - [x] Scan impacted files and refine exact implementation/test file list.
  - [x] Initial impacted files list (Lot 1):
    - [x] `ui/src/lib/components/Toast.svelte` (toaster placement)
    - [x] `ui/src/lib/components/EditableInput.svelte` (save latency behavior)
  - [x] Initial test focus list (to refine after implementation):
    - [x] `e2e/tests/03-chat.spec.ts` (chat bubble + toast coexistence smoke check)
    - [x] `e2e/tests/06-settings.spec.ts` and `e2e/tests/02-organizations.spec.ts` (EditableInput save behavior smoke)

- [ ] **Lot 1 — Chat feedback & EditableInput latency**
  - [x] Move toaster to the bottom near the chat icon.
  - [x] Change EditableInput behavior from 5-second wait to immediate feedback.
  - [x] Lot gate: `make typecheck-ui ENV=test` + `make lint-ui ENV=test`.
  - [x] `make lint-ui ENV=test` passed.
  - [x] `make typecheck-ui ENV=test` passed.
  - [ ] UAT checklist (UI):
    - [x] Open a page with chat bubble and trigger one toast.
    - [!] Verify toast is no longer rendered in top-right (base position changed to bottom area). (pb on docker mode)
    - [x] Verify toast remains readable/clickable in all chat states.
    - [!] Open chat panel and trigger a toast again; ensure no blocking overlap with chat critical controls. (pb on docker mode)
    - [!] Edit one standard `EditableInput` field (single-line), stop typing, and verify consistent immediate save behavior across views. (ok for other, but loop back pb on org)
    - [!] Edit one markdown `EditableInput` field and verify the same immediate save behavior. (ok for other, but loop back pb on org)
    - [!] Confirm no duplicate save-error/success regressions in console and visible UX. (ok for other, but loop back pb on org)
  - [x] UAT findings to resolve before closing Lot 1:
    - [x] Toast can be hidden when chat is docked/open (bottom-right collision with chat UI). (ok, but UX not good)
    - [x] Save/update behavior is heterogeneous by view:
      - [!] `organizations/[id]`: immediate `PUT` + one immediate `GET` (acceptable baseline for now). (still ko)
      - [x] `folders/[id]`: `PUT` + delayed `GET`, repeated per keystroke sequence. (ok but no update in second user viewing the view)
      - [x] `dashboard` (executive summary / folder context): `PUT` + extra `GET` calls (observed double `GET` on folder id). (ok but no update in second user viewing the view)
      - [x] `matrix`: `PUT` only for tested EditableInput paths.
    - [x] User observed instability/loop behavior when returning to app in some scenarios (investigation required). (ok but no update in second user viewing the view) (ok but no update in second user viewing the view)

- [ ] **Lot 1B — Save/refresh stabilization after UAT findings**
  - [x] Define toast placement strategy compatible with chat dock:
    - [x] Keep toast visible when chat is open/docked (shift toast stack left of docked chat panel).
    - [x] Keep a single responsive rule that works for desktop + mobile and avoids overlap with bubble/chat panel.
    - [x] Refine anchor rules per chat state:
      - [x] chat closed: toast stack immediately left of bubble button, near bottom.
      - [x] chat floating open: toast stack left of floating chat panel, near bottom.
      - [x] chat docked open: toast stack left of docked panel, near bottom.
  - [x] Analyze and normalize post-`PUT` refresh behavior:
    - [x] Map each `EditableInput` flow (`organizations`, `folders`, `dashboard`, `matrix`) to identify who triggers extra `GET` (component handlers, store reloads, route effects, SSE listeners).
    - [x] Define a shared contract: immediate optimistic local update + SSE reconciliation; avoid redundant immediate `GET` where not required.
    - [x] Reduce duplicate `GET` bursts after typing/saving in `folders/[id]` and `dashboard` by removing forced post-save reloads.
    - [x] Ensure collaborative usecase updates are pushed via SSE on UI `PUT /use-cases/:id` (`NOTIFY usecase_events`).
  - [!] Investigate instability/loop symptoms:
    - [!] Reproduce loop scenario with deterministic steps.
    - [x] Isolate likely trigger path (organization markdown newline normalization + fast autosave churn).
    - [x] Mitigate likely trigger by removing line-break amplification in organization editable payloads (`organizations/new` and `organizations/[id]`).
    - [x] Add first guardrails to reduce self-triggered churn (short save debounce + no forced GET after each PUT).
    - [x] Delay saving spinner visibility to >1s to avoid per-keystroke flicker.
  - [x] Lot gate: `make typecheck-ui API_PORT=8789 UI_PORT=5180 MAILDEV_UI_PORT=1084 ENV=test` + `make lint-ui API_PORT=8789 UI_PORT=5180 MAILDEV_UI_PORT=1084 ENV=test`.
  - [x] API gate for collaboration change: `make typecheck-api API_PORT=8789 UI_PORT=5180 MAILDEV_UI_PORT=1084 ENV=test` + `make lint-api API_PORT=8789 UI_PORT=5180 MAILDEV_UI_PORT=1084 ENV=test`.
  - [x] UAT checklist (Lot 1B):
    - [x] Toast stays visible and actionable with chat closed, open, and docked.
    - [x] Toast vertical anchor is near bottom and aligned with bubble center when chat is closed.
    - [!] On `organizations/[id]`, `folders/[id]`, and `dashboard`, one user edit does not trigger redundant `GET` bursts. (ok except Org still KO)
    - [x] On `usecase/[id]`, collaborative edits from another session appear in real-time without manual refresh.
    - [!] No loop/freeze when leaving and returning to impacted pages. (org is freezing)
    - [x] Saving spinner appears only when a save actually lasts more than ~1s.

- [x] **Lot 1C — Orga loop deep-fix + executive summary collaboration hardening**
  - [x] Rebuild `organizations/[id]` EditableInput flow with field-scoped payloads (usecase-style buffers/originals), not full-object writes on each field save.
  - [x] Add deterministic diagnostics for orga save/SSE churn to isolate exact loop trigger in runtime.
  - [x] Add lock/presence UX to executive summary editing area (dashboard) to match collaborative object locking model.
  - [x] Validate executive summary live updates in collaborative scenario (2 sessions) and document expected stream behavior.
    - [x] Documented expected behavior: folder SSE (`folder_update`) remains source of truth for executive summary fields; local save is optimistic and reconciled by stream.
    - [x] Dual-session UAT validation completed on root workspace.
  - [x] Lot gate: `make typecheck-ui API_PORT=8789 UI_PORT=5180 MAILDEV_UI_PORT=1084 ENV=test` + `make lint-ui API_PORT=8789 UI_PORT=5180 MAILDEV_UI_PORT=1084 ENV=test`.
  - [x] UAT checklist (Lot 1C):
    - [x] On `organizations/[id]`, typing/editing does not create runaway save/render loop.
    - [x] Concurrent orga editing across two sessions remains stable and convergent.
    - [x] Executive summary shows lock state and prevents silent conflicting edits.
    - [x] Executive summary updates stream live between sessions.

- [ ] **Lot 2 — Editable inputs in views (matrix/sector sizing)**
  - [x] Matrix: switch axes EditableInput to text/markdown input mode.
  - [x] Fix sector view/input sizing issue (currently too small).
  - [x] Inspect and fix similar sizing issues on related views.
    - [x] Applied `fullWidth` and markdown editing to matrix axis fields (table + level-description modal) to avoid narrow inline inputs.
    - [x] Expanded organization industry field layout in header area to avoid compressed inline rendering.
  - [x] Lot gate: `make typecheck-ui API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui` + `make lint-ui API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`.
  - [x] UAT checklist (UI):
    - [x] In matrix view, edit both axes with text/markdown mode and verify save behavior + rendering.
    - [x] Confirm axis fields keep expected width/height and no clipping while editing.
    - [x] Validate sector-related field now has readable size (no compressed input).
    - [x] Spot-check at least two other similar inputs to confirm no remaining tiny-field regression.
    - [x] Validate desktop and mobile viewport behavior for edited inputs.

- [x] **Lot 3 — Automatic comments behavior**
  - [x] Generation agents: create a default comment.
  - [x] Modification tool: add a comment on modified fields.
  - [x] Fix usecase auto-comment `section_key` normalization (`data.*` -> canonical key) for generated and tool-updated comments. (`4abeae5`)
  - [x] Fix missing FR/EN labels in comment menu for resolved threads toggle. (`1298ec8`)
  - [ ] **Lot 3A — Locale-aware auto comments (Option 2.1, explicit app locale)**
    - [x] Add backend locale resolver utility (priority: `X-App-Locale` -> `Accept-Language` -> `fr` fallback).
    - [x] UI API client: send `X-App-Locale` from application-selected locale (`localStorage` app setting), not browser default locale.
    - [x] Propagate locale from API routes to queued generation jobs:
      - [x] `POST /use-cases/generate`
      - [x] `POST /use-cases/:id/detail`
      - [x] `POST /organizations/:id/enrich`
      - [x] `POST /analytics/executive-summary`
      - [x] `POST /chat/messages` and `POST /chat/messages/:id/retry`
    - [x] Extend queue job payload types and propagation chain so locale is preserved across nested jobs (e.g. `usecase_list` -> `usecase_detail` -> `executive_summary`).
    - [x] Localize auto-comment content at write time in:
      - [x] `ToolService.createAutoFieldComments` (tool updates)
      - [x] `QueueManager.createAutoGenerationFieldComments` (generation jobs)
    - [x] Keep usecase `section_key` normalization behavior intact while localizing message text.
    - [x] Lot gate: `make typecheck-api API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui` + `make lint-api API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`.
    - [x] UI gate for header injection changes: `make typecheck-ui API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui` + `make lint-ui API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`.
  - [x] Lot gate: `make typecheck-api ENV=test` + `make lint-api ENV=test` (+ UI gates if needed).
  - [x] UAT checklist:
    - [x] Trigger a generation flow and verify comments are created for each generated field.
    - [x] Verify generated comment text matches expected field-level template.
    - [x] Trigger a tool-based update changing multiple fields.
    - [x] Verify one comment is created per modified field (not one global comment).
    - [x] Verify comment linkage (object/section/field context) is correct for each created comment.
    - [x] With app locale explicitly set to `fr`, trigger one generation and one tool update; verify created auto-comments are in French.
    - [x] With app locale explicitly set to `en`, trigger one generation and one tool update; verify created auto-comments are in English.
    - [x] Locale source validation: keep browser locale opposite to app locale and verify auto-comment language follows app locale (`X-App-Locale`), not browser default.
    - [x] Usecase header bubble validation: generated/updated comments on usecase fields appear on canonical section keys (no new `data.*` keys created).

- [ ] **Lot 4 — Comment review UX and field label localization**
  - [x] Switch comment badge visual to design-system primary color (icon + count pill).
  - [x] Add missing comment bubbles on usecase score headers:
    - [x] `valueScores`
    - [x] `complexityScores`
  - [x] Localize field labels in auto-generated/auto-modified comments (backend write-time):
    - [x] QueueManager generation comments
    - [x] ToolService field-modification comments
  - [x] Move comment review actions from chat top header into comment sub-header:
    - [x] `chat.comments.chooseThread` => comments list action in sub-header
    - [x] `chat.comments.newThread` => new comment action in sub-header
    - [x] `chat.comments.resolve` => resolve/reopen action in sub-header
  - [x] Localize sub-header section target labels (avoid technical keys like `constraints`).
  - [x] Add review flow helpers in sub-header:
    - [x] Auto-switch to next open comment after resolving current one.
    - [x] Add previous/next comment navigation buttons with arrows.
  - [x] UAT-driven header refinements (4B):
    - [x] Comments hint text now depends on thread availability:
      - [x] FR/EN copy for "select existing comment or write one" when threads exist.
      - [x] FR/EN copy for "no comment yet, you can write one" when no thread exists.
    - [x] Add `Chat IA` sub-header with session title and move session actions there (`list` / `new` / `delete`).
    - [x] Add `Jobs` sub-header and move jobs actions there.
    - [x] Remove duplicated jobs minus action (`-`) and keep single clear purge action in jobs sub-header.
    - [x] Keep top header contextual actions hidden for comments mode; top header remains global controls (tabs + panel/close).
  - [x] Update FR/EN labels:
    - [x] `chat.comments.chooseThread` ("Liste des commentaires" / "Comments list")
    - [x] `chat.comments.newThread` ("Nouveau commentaire" / "New comment")
    - [x] `chat.comments.resolve` ("Résoudre le commentaire" / "Resolve comment")
    - [x] `chat.comments.previous` + `chat.comments.next`
    - [x] Add missing `chat.sections.usecase.*` keys for constraints + score groups.
  - [x] Lot gate:
    - [x] `make typecheck-ui API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
    - [x] `make lint-ui API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
    - [x] `make typecheck-api API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
    - [x] `make lint-api API_PORT=8793 UI_PORT=5182 MAILDEV_UI_PORT=1086 ENV=test-feat-minor-evols-ui`
  - [ ] UAT checklist:
    - [ ] In usecase view, comment bubble is primary-colored (not black) on cards and score headers.
    - [ ] Bubbles are visible/clickable on `Axes de Valeur` and `Axes de Complexité` headers.
    - [ ] In comments tab sub-header, actions appear there (not in top widget header): list, new comment, resolve/reopen.
    - [ ] Sub-header shows localized section name (e.g. `Contraintes` / `Constraints`), never technical key.
    - [ ] Resolve one open comment and verify automatic selection jumps to next open comment.
    - [ ] Previous/next arrow buttons navigate between available comment threads.
    - [ ] Auto-generated comments use localized field labels in FR and EN.

- [ ] **Lot N-1 — Docs consolidation**
  - [ ] Update impacted specs/docs if behavior contracts changed.
  - [ ] Update `TODO.md` status for this item when feature is complete.

- [ ] **Lot N — Final validation**
  - [ ] **API tests**
    - [ ] Identify and update impacted API tests (exact files listed after Lot 0 scan).
    - [ ] Scoped runs while evolving: `make test-api SCOPE=tests/your-file.spec.ts ENV=test`.
    - [ ] Sub-lot gate: `make test-api ENV=test`.
  - [ ] **UI tests (TypeScript only)**
    - [ ] Identify and update impacted UI tests (exact files listed after Lot 0 scan).
    - [ ] Scoped runs while evolving: `make test-ui SCOPE=tests/your-file.spec.ts ENV=test`.
    - [ ] Sub-lot gate: `make test-ui ENV=test`.
  - [ ] **E2E tests**
    - [ ] Prepare E2E build: `make build-api build-ui-image API_PORT=8788 UI_PORT=5178 MAILDEV_UI_PORT=1082 ENV=e2e`.
    - [ ] Identify and update impacted E2E tests (exact files listed after Lot 0 scan).
    - [ ] Scoped runs while evolving: `make test-e2e E2E_SPEC=tests/your-file.spec.ts API_PORT=8788 UI_PORT=5178 MAILDEV_UI_PORT=1082 ENV=e2e`.
    - [ ] Sub-lot gate: `make clean test-e2e API_PORT=8788 UI_PORT=5178 MAILDEV_UI_PORT=1082 ENV=e2e`.
  - [ ] Final gate: create PR with `BRANCH.md` content as initial message and verify CI for the branch.
  - [ ] Final commit removes `BRANCH.md` and checks `TODO.md`.
