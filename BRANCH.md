# Feature: Chrome Extension Plugin

## Objective
Build a Chrome extension (Manifest V3) that embeds the ChatWidget into any web page via Shadow DOM, allowing users to chat with the Top AI Ideas assistant and leverage local Chrome tools (tab reading, screenshots, click automation) alongside server-side tools.

## Scope / Guardrails
- Scope limited to: abstraction layer (`ui/src/lib/core/`), ChatWidget/ChatPanel refactoring, Chrome extension skeleton (`ui/chrome-ext/`), local Chrome tools, minimal API evolution for local tool support.
- One migration max in `api/drizzle/*.sql` (if applicable).
- Make-only workflow, no direct Docker commands.
- Root workspace `~/src/top-ai-ideas-fullstack` is reserved for user dev/UAT (`ENV=dev`) and must remain stable.
- Branch development must happen in isolated worktree `tmp/feat-chrome-plugin` (even for one active branch).
- Automated test campaigns must run on dedicated environments (`ENV=test` / `ENV=e2e`), never on root `dev`.
- In every `make` command, `ENV=<env>` must be passed as the last argument.
- All new text in English.

## Questions / Notes
- Shadow DOM + Svelte 5: portals and modals may need workarounds. Handle with `{ target: document.body }` fallback if needed.
- API evolution for `localToolDefinitions` and `tool-results` endpoint: keep backward-compatible (optional fields only).
- The `git worktree` approach is used instead of `git clone` for the isolated workspace (faster, shared objects).

## Orchestration Mode (AI-selected)
- [x] **Mono-branch + cherry-pick** (default for orthogonal tasks; single final test cycle)
- [ ] **Multi-branch** (only if sub-workstreams require independent CI or long-running validation)
- Rationale: Single feature (Chrome extension), all changes are interdependent (abstraction layer required for the extension), single branch is sufficient.

## UAT Management (in orchestration context)
- **Mono-branch**: UAT is performed on the integrated branch only (after each lot, when UI changes exist).
- UAT checkpoints must be listed as checkboxes inside each relevant lot (no separate UAT section).
- Execution flow (mandatory):
  - Develop and run tests in `tmp/feat-chrome-plugin`.
  - Push branch before UAT.
  - Run user UAT from root workspace (`~/src/top-ai-ideas-fullstack`, `ENV=dev`).
  - Switch back to `tmp/feat-chrome-plugin` after UAT.

## Plan / Todo (lot-based)

- [x] **Lot 0 — Baseline & constraints**
  - [x] Read the relevant `.mdc` files and `README.md`.
  - [x] Create/confirm isolated worktree `tmp/feat-chrome-plugin` and run development there.
  - [x] Capture Makefile targets needed for debug/testing.
  - [x] Define environment mapping (`dev`, `test`, `e2e`) and ports for this branch.
  - [x] Confirm command style: `make ... <vars> ENV=<env>` with `ENV` last.
  - [x] Confirm scope and guardrails.
  - [x] Add `spec/SPEC_CHROME_PLUGIN.md` (initial draft).

- [x] **Lot 1 — Abstraction layer (ui/src/lib/core/)**
  - [x] Create `ui/src/lib/core/context-provider.ts` (ContextProvider interface + SvelteKit impl + Extension impl)
  - [x] Create `ui/src/lib/core/api-client.ts` (configurable ApiClient without `$app` deps)
  - [x] Create `ui/src/lib/core/auth-bridge.ts` (AuthBridge interface)
  - [x] Create `ui/src/lib/core/navigation-adapter.ts` (NavigationAdapter interface)
  - [x] Lot gate: `make typecheck-ui ENV=test` + `make lint-ui ENV=test` (passed, zero new errors)

- [x] **Lot 2 — ChatWidget & ChatPanel refactoring**
  - [x] Refactor `ChatWidget.svelte`: replace `$app/stores` (page) and `$app/environment` (browser) with `ContextProvider`
  - [x] Refactor `ChatPanel.svelte`: N/A — no `$app` imports found (already decoupled)
  - [x] Refactor `session.ts`: decouple `goto` via `NavigationAdapter`
  - [x] Refactor `streamHub.ts`: accept injected `baseUrl` via `getApiBaseUrl()` fallback
  - [x] Verify non-regression: typecheck + lint gates pass (existing web app behavior preserved via fallbacks)
  - [x] Lot gate: `make typecheck-ui ENV=test` + `make lint-ui ENV=test` (passed)
  - [x] **UAT planning update**: defer Web App non-regression UAT from Lot 2 to Lot 3 integrated UAT (plugin + app in the same cycle).

- [x] **Lot 3 — Chrome extension skeleton + behavior parity**
  - [x] Create `ui/chrome-ext/manifest.json` (Manifest V3)
  - [x] Create `ui/chrome-ext/content.ts` (Shadow DOM bootstrap + ChatWidget mount)
  - [x] Create `ui/chrome-ext/background.ts` (service worker skeleton)
  - [x] Create `ui/chrome-ext/popup.html` + `popup.ts` (API URL config)
  - [x] Create `ui/chrome-ext/sidepanel.html` + `sidepanel.ts` (side panel placeholder)
  - [x] Create `ui/chrome-ext/vite.config.ext.ts` (multi-entry Vite build)
  - [x] Create `ui/chrome-ext/chatwidget-entry.ts` (Svelte mount with extension providers)
  - [x] Add Makefile targets: `build-ext`, `dev-ext`, `package-ext`
  - [x] Add `package.json` scripts: `build:ext`, `dev:ext`
  - [x] Create extension icons (placeholder) (via copy script)
  - [x] Lot gate: `make build-ext ENV=test` succeeds
  - [x] **Lot 3A — Extension loading/packaging (validated)**
    - [x] Fix manifest popup/sidepanel paths to built files (`chrome-ext/popup.html`, `chrome-ext/sidepanel.html`)
    - [x] Ensure `make build-ext` produces a directly loadable `ui/chrome-ext/dist` output
    - [x] Add build checks in `make build-ext` for required files (`manifest.json`, `content.js`, popup/sidepanel html)
    - [x] Add ownership normalization in `make build-ext` so unpacked load does not fail on file permissions
    - [x] Ignore extension build artifacts in Git (`ui/chrome-ext/dist/`) and stop tracking `dist` files
    - [x] **Partial UAT Lot 3A (root workspace)**
      - [x] **Build**: Run `make build-ext`. Verification: `✅ Extension built` and files in `ui/chrome-ext/dist/`.
      - [x] **Install**: Open `chrome://extensions`, enable "Developer mode", click "Load unpacked", select `ui/chrome-ext/dist` folder.
      - [x] **Verify loadability**: Manifest is accepted by Chrome (no load blocker on manifest/content script).
  - [x] **Lot 3B — ChatWidget/ChatPanel exact UX parity (mandatory before Lot 4A)**
    - [x] Remove temporary fallback UI from `ui/chrome-ext/content.ts` (no custom `AI` button, no ad-hoc popup panel)
    - [x] Mount the existing ChatWidget implementation only (same bubble icon/component and same UI contract as web app)
    - [x] Keep same opening/closing behavior and anchoring (no unexpected move/jump when opening panel)
    - [x] Keep same visual style/tokens as existing components (no custom inline style system for widget/panel)
    - [x] Keep same toasts behavior and placement as existing ChatWidget/ChatPanel flow
    - [x] Preserve context + streaming behavior through existing stores/adapters (no UX regression introduced by extension mount)
    - [x] Fix dynamic import mount contract: `chatwidget.js` now registers a global mount fallback and `content.ts` resolves `mount` from export/default/global.
    - [x] Lot gate: `make typecheck-ui ENV=test` + `make lint-ui ENV=test`
    - [x] Ready for partial UAT Lot 3B on root workspace (`.`) with current branch state.
    - [x] **Partial UAT Lot 3B — Chrome Extension parity (execute on root workspace `~/src/top-ai-ideas-fullstack`)**
      - [x] **Prepare extension build**: Run `make build-ext` from root workspace (`.`).
      - [x] **Reload extension**: In `chrome://extensions`, click "Reload" on unpacked extension (or load `ui/chrome-ext/dist` again if needed).
      - [x] **Bubble parity (Chrome page)**: Same chat bubble icon as web app (not text `AI`), same default collapsed state.
      - [x] **Open parity (Chrome page)**: Clicking bubble opens the same panel structure/actions as existing widget.
      - [x] **Close parity (Chrome page)**: Closing/minimizing restores same collapsed behavior and button placement.
      - [x] **Position parity (Chrome page)**: Bubble remains anchored in expected corner before/after toggles (no drift/jump).
      - [x] **Style parity (Chrome page)**: Header/body/input/actions/toasts match existing ChatWidget/ChatPanel visual system, except font-family parity.
      - [x] **Font parity (Chrome page)**: Same font-family token as web app in extension context (tracked in Lot 3C).
      - [x] **Behavior parity (Chrome page)**: Send one message and verify streaming response behavior remains consistent.
      - [x] **No runtime errors (Chrome page)**: No extension content-script error in extension page/console during open-close-send flow.
    - [x] **Partial UAT Lot 3B — Web App non-regression (execute on root workspace `~/src/top-ai-ideas-fullstack`)**
      - [x] **Auth**: Logout and login back in (session navigation behavior unchanged).
      - [x] **Chat open**: Open the global chat in web app and verify initial collapsed/expanded behavior.
      - [x] **Context**: Navigate to folder/usecase and verify chat context is still correct.
      - [x] **Streaming**: Send a message and verify streaming response behavior is unchanged.
      - [x] **Toasts**: Trigger one success/error feedback path and verify toast style/placement unchanged in web app.
  - [x] **UAT: Integrated App + Chrome Extension (close Lot 3, root workspace only)**
    - [x] Confirm both partial checklists are completed: `3B Chrome Extension parity` + `3B Web App non-regression`.
    - [x] Confirm no cross-regression between extension behavior and web app behavior in the same UAT cycle.
    - [x] Close Lot 3 only after Lot 3C font parity is validated.

- [x] **Lot 3C — Runtime parity hardening (font, side panel, host exclusion)**
  - [x] Define a single shared font token (e.g. `--chat-font-family`) used by both web app and extension widget.
  - [x] Apply the shared font token at ChatWidget root level to avoid host page font override in Shadow DOM.
  - [x] Replace extension in-page docked behavior with official Chrome Side Panel behavior for docked mode.
  - [x] Implement state handoff between floating bubble and side panel (active tab, draft, current session, open/close state).
  - [x] Re-enable floating/docked switch both ways (bubble overlay ↔ Chrome side panel) from the same existing ChatWidget control.
  - [x] Hide empty burger action in side panel host (no orphan menu entry).
  - [x] Fix side panel chat layout parity (`min-h-0` + flex column) to restore bottom composer behavior and internal scroll.
  - [x] Initialize auth session in extension mount path and allow `chrome-extension://*` CORS origin for API/SSE calls.
  - [x] Add extension activation guard on Top AI Ideas app domains:
    - [x] `manifest.json` `exclude_matches` for localhost/prod app domains.
    - [x] Runtime hostname denylist fallback in `content.ts`.
  - [x] Lot gate: `make typecheck-ui API_PORT=8792 UI_PORT=5177 MAILDEV_UI_PORT=1082 ENV=feat-chrome-plugin` + `make lint-ui API_PORT=8792 UI_PORT=5177 MAILDEV_UI_PORT=1082 ENV=feat-chrome-plugin` + `make typecheck-api API_PORT=8792 UI_PORT=5177 MAILDEV_UI_PORT=1082 ENV=feat-chrome-plugin` + `make lint-api API_PORT=8792 UI_PORT=5177 MAILDEV_UI_PORT=1082 ENV=feat-chrome-plugin` + `make build-ext API_PORT=8792 UI_PORT=5177 MAILDEV_UI_PORT=1082 ENV=feat-chrome-plugin`
  - [x] Ready for partial UAT Lot 3C on root workspace (`.`).
  - [x] **Partial UAT Lot 3C (root workspace `~/src/top-ai-ideas-fullstack`)**
    - [x] Run `make build-ext`, reload unpacked extension.
    - [x] Validate font parity between web app widget and extension widget.
    - [x] Validate side panel mode keeps same component style/behavior as floating mode.
    - [x] Validate side panel critical regressions are fixed: overlay/panel switch button visible and functional, streaming works, composer stays at bottom, messages list is scrollable, no empty burger action.
    - [x] Validate no content-script injection on Top AI Ideas app domains (`localhost`, `127.0.0.1`, prod domain list).

- [x] **Lot 4A — Extension configuration and mandatory API connectivity (UAT/PROD)**
  - [x] Fix floating overlay ChatWidget API connectivity (`initializeSession` + send/stream) so behavior matches side panel and no `Failed to fetch` remains. (implemented via background proxy + overlay stream polling fallback)
  - [x] Add extension runtime profiles: `UAT`, `PROD` (API base URL mandatory, app base URL, optional WS base URL).
  - [x] Add profile/config UI (popup or options page) with validation and persistence.
  - [x] Implement extension background fetch proxy for overlay API calls to avoid page-origin CORS/mixed-content failures.
  - [x] Ensure both `UAT` and `PROD` profiles are API-connected (no disconnected mock-only flow).
  - [x] Add API connectivity test action (`/api/v1/health`) and visible status in extension UI.
  - [x] Wire ChatWidget API client to extension profile config with clear error states when config is invalid.
  - [x] Lot gate: `make typecheck-ui API_PORT=8892 UI_PORT=5187 MAILDEV_UI_PORT=1092 ENV=test-chrome-plugin` + `make lint-ui API_PORT=8892 UI_PORT=5187 MAILDEV_UI_PORT=1092 ENV=test-chrome-plugin`
  - [x] **Partial UAT Lot 4A (root workspace `~/src/top-ai-ideas-fullstack`, validated with accepted 4B follow-ups)**
    - [x] Switch profile `UAT`/`PROD` and verify endpoint persistence. (execution deferred by decision; covered by dedicated 4B config-menu UAT)
    - [x] Validate connectivity status and chat send/streaming in both profiles.
    - [x] Validate floating overlay widget can initialize session and chat send/stream without `Failed to initialize session` / `Failed to fetch`.
    - [x] Validate failure mode when endpoint is invalid (clear error feedback confirmed; UI placement refinement deferred to 4B)

- [ ] **Lot 4B — Extension auth model (dedicated token, no passive WebAuthn prompts)**
  - [x] Add an in-app configuration menu for extension endpoint/profile selection (UAT/PROD) and persist it as the primary user-facing config surface. (implemented in ChatWidget header)
  - [x] Move chat connectivity/runtime errors to the end of the conversation flow (bottom, latest message area), not at top. (implemented in ChatPanel flow)
  - [x] Design and implement a dedicated extension auth token flow (access token + renewal strategy). (new `/auth/session/extension-token` issue + background token refresh strategy)
  - [x] Ensure auth is started only from explicit extension user action (never passive bootstrap from content script). (`Connect` action only; passive bootstrap removed)
  - [x] Prevent third-party-page WebAuthn side effects (no unexpected local-device permission prompts). (no passive auth ceremony from content script; explicit connect/login only)
  - [x] Add secure token storage and logout/revoke path in extension context. (`chrome.storage.local/session` + revoke on logout)
  - [x] Document compatibility path with future local/remote WS delegation. (`spec/SPEC_CHROME_PLUGIN.md` sections 3.5 and 3.6)
  - [x] Lot gate: `make typecheck-ui API_PORT=8892 UI_PORT=5187 MAILDEV_UI_PORT=1092 ENV=test-chrome-plugin` + `make lint-ui API_PORT=8892 UI_PORT=5187 MAILDEV_UI_PORT=1092 ENV=test-chrome-plugin` + `make typecheck-api API_PORT=8892 UI_PORT=5187 MAILDEV_UI_PORT=1092 ENV=test-chrome-plugin` + `make lint-api API_PORT=8892 UI_PORT=5187 MAILDEV_UI_PORT=1092 ENV=test-chrome-plugin` + `make build-ext API_PORT=8892 UI_PORT=5187 MAILDEV_UI_PORT=1092 ENV=test-chrome-plugin`
  - [ ] **Partial UAT Lot 4B (root workspace `~/src/top-ai-ideas-fullstack`)**
    - [x] Validate in-chat endpoint configuration menu (overlay + side panel): endpoint save, API health test, persistence after extension reload.
    - [x] Validate chat API failure feedback appears at the bottom/latest message area (not at the top of conversation).
    - [x] Validate extension login without unexpected local-network/WebAuthn prompts.
    - [x] Validate token renewal and expired-session recovery path.
    - [x] Validate logout/revoke and blocked access after logout.
    - [x] Validate chat streaming

- [ ] **Lot 5 — Local Chrome tools (service worker)**
  - [x] Create `ui/chrome-ext/tool-executor.ts` with implementations:
    - [x] `tab_read_dom` (extract DOM text via `chrome.scripting.executeScript`)
    - [x] `tab_screenshot` (capture via `chrome.tabs.captureVisibleTab`)
    - [x] `tab_click` (click by selector or coordinates)
    - [x] `tab_type` (type text into input element)
    - [x] `tab_scroll` (scroll page by direction/pixels)
    - [x] `tab_info` (page metadata: URL, title, headings, links)
  - [x] Create `ui/src/lib/stores/localTools.ts` (LocalToolStore + execution bridge)
  - [x] Wire service worker message listener to tool executor
  - [x] Wire ChatPanel to intercept local tool calls from SSE stream
  - [x] Quality gate: `make typecheck-ui API_PORT=8892 UI_PORT=5187 MAILDEV_UI_PORT=1092 ENV=test-chrome-plugin` + `make lint-ui API_PORT=8892 UI_PORT=5187 MAILDEV_UI_PORT=1092 ENV=test-chrome-plugin` + `make build-ext API_PORT=8892 UI_PORT=5187 MAILDEV_UI_PORT=1092 ENV=test-chrome-plugin`
  - [x] **Validation technique Lot 5A — interne dev (hors UAT utilisateur)**
    - [x] Réalisée par l’agent sur environnement dev/test (service worker + resolver d’onglet + exécuteurs locaux).
    - [x] Vérifier exécution locale des tools (`tab_info`, `tab_read_dom`, `tab_scroll`, `tab_click`, `tab_type`, `tab_screenshot`) et garde-fous URL non injectables.
  - [!] **UAT utilisateur Lot 5A**
    - [x] Aucun script manuel requis côté utilisateur pour Lot 5A.
    - [x] Covered by Lot 6A UAT (local-tool execution + API resume validated in side panel and floating widget).
  - [x] Lot gate: tools execute correctly from the extension context (validated via scoped `make test-ui` suites + `make typecheck-ui` + `make lint-ui` + `make build-ext` on `ENV=test-chrome-plugin`)

- [x] **Lot 6 — API evolution for local tools**
  - [x] Add `localToolDefinitions` optional field to `POST /chat/messages` input
  - [x] Merge local tool definitions with server tools in `chat-service.ts`
  - [x] Add `POST /api/v1/chat/messages/:id/tool-results` endpoint
  - [x] Implement generation resume after receiving local tool result
  - [x] Lot gate: `make typecheck-api API_PORT=8892 UI_PORT=5187 MAILDEV_UI_PORT=1092 ENV=test-chrome-plugin` + `make lint-api API_PORT=8892 UI_PORT=5187 MAILDEV_UI_PORT=1092 ENV=test-chrome-plugin` + `make typecheck-ui API_PORT=8892 UI_PORT=5187 MAILDEV_UI_PORT=1092 ENV=test-chrome-plugin` + `make lint-ui API_PORT=8892 UI_PORT=5187 MAILDEV_UI_PORT=1092 ENV=test-chrome-plugin` + `make build-ext API_PORT=8892 UI_PORT=5187 MAILDEV_UI_PORT=1092 ENV=test-chrome-plugin`
  - [x] Validation technique: `make test-api SCOPE=tests/unit/chat-service-tools.test.ts API_PORT=8892 UI_PORT=5187 MAILDEV_UI_PORT=1092 ENV=test-chrome-plugin` + `make test-api SCOPE=tests/api/chat.test.ts API_PORT=8892 UI_PORT=5187 MAILDEV_UI_PORT=1092 ENV=test-chrome-plugin`
  - [x] Temporary UAT unblock: set extension `host_permissions` to `<all_urls>` so Lot 6A local-tool UAT can run on arbitrary domains.
  - [x] **UAT utilisateur Lot 6A (root workspace `~/src/top-ai-ideas-fullstack`)**
    - [x] Build extension from root: `make build-ext`.
    - [x] Reload unpacked extension from root `ui/chrome-ext/dist`.
    - [x] Side panel: local-tool roundtrip (`tab_info`/`tab_read_dom`/`tab_scroll`/`tab_click`/`tab_type`) resumes assistant automatically in same stream.
    - [x] Floating widget: same local-tool roundtrip parity as side panel.
    - [x] No manual refresh/re-send required after tool execution.
    - [x] Failure path remains conversational (tool error surfaced, generation not stuck).
    - [x] Stability fixes integrated from UAT feedback: local-tool argument buffering (`tool_call_start`/`tool_call_delta`), `tab_type` fallback targeting, `tab_click` text-based targeting, and reasoning-effort navigation heuristic (`chat_reasoning_effort_eval` context enrichment + medium floor).

- [ ] **Lot 6B — Runtime permissions + unified local tools (`tab_read` / `tab_action`)**
  - [x] Replace current `tab_*` surface by 2 unified tools:
    - [x] `tab_read`:
      - [x] `mode=info|dom|screenshot|elements`
      - [x] `info`: url/title/meta/headings
      - [x] `dom`: text/html extract (selector optional)
      - [x] `screenshot`: visible capture
      - [x] `elements`: pre-parsed list of clickable elements and editable inputs (selector/label/role/bounds/index hints)
    - [x] `tab_action`:
      - [x] Execute one or multiple actions in sequence (`scroll|click|type|wait`)
      - [x] Support chain payload with per-step delays (`waitMs`) and global timeout
      - [x] Return per-step status + final summary result
  - [x] Runtime permission UX in chat (localized decision card):
    - [x] `Oui (une fois)` / `Non (une fois)` / `Toujours` / `Jamais`
    - [x] Prompt appears only when needed by tool + origin.
  - [x] Persist `Toujours/Jamais` policies in backend DB (user/workspace/tool/origin), with extension sync:
    - [x] bootstrap fetch
    - [x] push updates on decision
    - [x] conflict-safe reconciliation (timestamp/version)
    - [x] offline queue replay
  - [x] Settings split in extension UI (same visual style as `Commentaires/Chat IA/Jobs`):
    - [x] `Endpoint serveur`
    - [x] `Permissions outils` (allow/deny entries by tool + origin)
  - [x] Permissions rule engine hardening (tool + origin patterns):
    - [x] Tool patterns: `tab_read:*`, `tab_action:*`, `tab_action:click|input|scroll|wait`.
    - [x] Origin patterns: `*`, `https://*`, `*.domain.tld`, `https://*.domain.tld`, exact host, exact URL origin.
    - [x] Matching precedence: most specific pattern wins, then most recent update.
    - [x] Keep runtime-origin normalization separate from stored pattern normalization (fixes wildcard inputs in settings).
  - [x] Screenshot readability improvement:
    - [x] `tab_read(mode=screenshot)` / `tab_screenshot` default to `png` capture (text readability first).
    - [x] Keep optional `jpeg` capture with stronger default quality (`95`).
  - [x] Extension settings menu UX fixes (floating chatwidget):
    - [x] Compute exact menu height to align menu bottom with chatwidget bottom.
    - [x] Remove double scroll: keep single scroll region under settings tabs.
  - [x] Queue header cleanup:
    - [x] Remove duplicate admin purge icon (`-`) and keep single trash action in Jobs tab header.
  - [x] Tool visibility/context UX:
    - [x] For new extension sessions, hide non-activable business tools when relevant folder/org/usecase context is absent.
    - [x] Keep extension restricted toolset enforced for extension runtime (including existing sessions with persisted prefs), so business tools do not reappear after tab/session switches.
    - [x] Add explicit active tab context entry.
    - [x] Disable `Commentaires` tab in plugin mode (side panel + floating widget) until dedicated plugin comment flow is delivered.
    - [x] Show local tools (`tab_read`, `tab_action`) with the same visual style/behavior as remote tool toggles (no dedicated `EXT` badge), including per-tool enable/disable toggles in composer menu.
  - [ ] Lot gate:
    - [x] `make typecheck-ui API_PORT=8892 UI_PORT=5187 MAILDEV_UI_PORT=1092 ENV=test-chrome-plugin`
    - [x] `make lint-ui API_PORT=8892 UI_PORT=5187 MAILDEV_UI_PORT=1092 ENV=test-chrome-plugin`
    - [x] `make typecheck-api API_PORT=8892 UI_PORT=5187 MAILDEV_UI_PORT=1092 ENV=test-chrome-plugin`
    - [x] `make lint-api API_PORT=8892 UI_PORT=5187 MAILDEV_UI_PORT=1092 ENV=test-chrome-plugin`
    - [!] `make test-api SCOPE=tests/api/chat-permissions.test.ts API_PORT=8892 UI_PORT=5187 MAILDEV_UI_PORT=1092 ENV=test-chrome-plugin` (scoped tests pass via `make test-api-unit ...`; aggregate wrapper is flaky in this env due transient `up-api-test` health timeout).
    - [x] `make build-ext API_PORT=8892 UI_PORT=5187 MAILDEV_UI_PORT=1092 ENV=test-chrome-plugin`
  - [ ] **UAT utilisateur Lot 6B (root workspace `~/src/top-ai-ideas-fullstack`)**
    - [x] Validate `tab_read` modes (`info|dom|screenshot|elements`) on external page.
    - [x] Validate screenshot readability with default capture (`tab_read` screenshot mode, default PNG) on small-text UI.
    - [x] Validate optional JPEG path (`tab_read` screenshot mode + `format=jpeg`) remains functional.
    - [x] Validate `tab_action` single-step and multi-step chains with delays.
    - [x] Validate runtime permission prompt decisions:
      - [x] `Oui (une fois)`: one execution allowed, next execution prompts again.
      - [x] `Toujours`: execution allowed and policy persists after extension reload.
      - [x] `Jamais`: execution denied and policy persists after extension reload.
    - [x] Validate permissions settings wildcard inputs are accepted and stored as expected:
      - [x] `*` accepted (no validation error).
      - [x] `https://*` accepted and stored without `%2a` encoding artifact.
      - [x] `*.example.com` and `https://*.example.com` accepted and applied.
    - [x] Validate permission precedence behavior:
      - [x] Specific allow rule can override broader deny rule when specificity is higher.
      - [x] Tie-break for same specificity follows latest update.
    - [x] Validate settings tabs (`Endpoint serveur` / `Permissions outils`) and policy edit.
    - [x] Validate floating chatwidget settings menu no longer clips/truncates and uses single content scroll area.
    - [x] Validate tool visibility rules for no-context new sessions.
    - [x] Validate `Commentaires` tab is hidden in plugin mode and web app behavior is unchanged.
    - [x] Validate local tool toggles in composer menu:
      - [x] `tab_read` and `tab_action` are visible with standard tool row style (icon + label, no `EXT` badge).
      - [x] Disabling `tab_read` prevents it from being sent in `localToolDefinitions` for new chat requests.
      - [x] Disabling `tab_action` prevents it from being sent in `localToolDefinitions` for new chat requests.
    - [x] Validate extension restricted toolset persistence:
      - [x] In extension runtime, after tab switch and reopening an existing chat session, business tools (`documents`, `organisation`, `dossier`, etc.) do not reappear in composer list.

- [x] **Lot N-1 — Docs consolidation**
  - [x] Identify impacted specs to update:
    - [x] `spec/SPEC.md` (global functional map + extension runtime behavior).
    - [x] `spec/DATA_MODEL.md` (tenancy/chat model + extension tool-permission persistence).
    - [x] `spec/SPEC_CHROME_PLUGIN.md` (current architecture, unified local tools, auth/permission model).
  - [x] Update `spec/SPEC.md` with current Chrome extension behavior (`tab_read`/`tab_action`, runtime permission gate, plugin UX scope).
  - [x] Update `spec/DATA_MODEL.md` with `extension_tool_permissions` and local-tool chat runtime notes.
  - [x] Refactor `spec/SPEC_CHROME_PLUGIN.md` to remove legacy `tab_*` split contract and document current `tab_read`/`tab_action` + `/chat/tool-permissions`.
  - [x] Update `TODO.md` to reflect completed Chrome extension 6B delivery.

- [ ] **Lot N — Final validation**
  - [x] **Revue exhaustive de couverture (régression + évolution)**
    - [x] API: audit des suites existantes (`chat-service-tools`, `chat`, `chat-permissions`) et identification des trous sur wildcards/patterns + garde-fous `tool-results`.
    - [x] UI: audit des suites existantes (`localTools`, `chat-tool-scope`, `tool-executor`) et identification des trous sur filtrage extension + matching permission runtime.
    - [x] E2E: audit des specs chat existantes et définition d’un scénario non-régression ciblé/rapide.
  - [ ] **API tests (régression + évolution)**
    - [ ] `api/tests/api/chat-permissions.test.ts`: couvrir normalisation et validation des patterns `toolName`/`origin` (`*`, `https://*`, `*.domain`, host, invalides).
    - [ ] `api/tests/api/chat.test.ts`: couvrir forwarding de `localToolDefinitions` dans le job `chat_message`.
    - [ ] `api/tests/api/chat.test.ts`: couvrir garde-fous `POST /chat/messages/:id/tool-results` (`404` message inconnu, `400` si message non assistant).
    - [ ] Scoped runs:
      - [ ] `make test-api SCOPE=tests/api/chat-permissions.test.ts API_PORT=8892 UI_PORT=5187 MAILDEV_UI_PORT=1092 ENV=test-chrome-plugin`
      - [ ] `make test-api SCOPE=tests/api/chat.test.ts API_PORT=8892 UI_PORT=5187 MAILDEV_UI_PORT=1092 ENV=test-chrome-plugin`
  - [ ] **UI tests (TypeScript, régression + évolution)**
    - [ ] `ui/tests/utils/chat-tool-scope.test.ts`: couvrir explicitement visibilité/activation `tab_read` + `tab_action` en mode extension restreint.
    - [ ] `ui/tests/chrome-ext/tool-permissions.test.ts`: ajouter tests de normalisation/matching/priorité (wildcards tool+origin, tie-break `updatedAt`).
    - [ ] Scoped runs:
      - [ ] `make test-ui SCOPE=tests/utils/chat-tool-scope.test.ts API_PORT=8892 UI_PORT=5187 MAILDEV_UI_PORT=1092 ENV=test-chrome-plugin`
      - [ ] `make test-ui SCOPE=tests/chrome-ext/tool-permissions.test.ts API_PORT=8892 UI_PORT=5187 MAILDEV_UI_PORT=1092 ENV=test-chrome-plugin`
      - [ ] `make test-ui SCOPE=tests/chrome-ext/tool-executor.test.ts API_PORT=8892 UI_PORT=5187 MAILDEV_UI_PORT=1092 ENV=test-chrome-plugin`
  - [ ] **E2E tests (non-régression)**
    - [ ] `e2e/tests/03-chat.spec.ts`: ajouter scénario de non-régression menu outils (ouverture widget, affichage outil, envoi message) sans dépendance plugin runtime.
    - [ ] Scoped run:
      - [ ] `make test-e2e E2E_SPEC=tests/03-chat.spec.ts API_PORT=8788 UI_PORT=5174 MAILDEV_UI_PORT=1084 ENV=e2e-chrome-plugin`
  - [ ] **Lot gate final (technique)**
    - [ ] `make test-api API_PORT=8892 UI_PORT=5187 MAILDEV_UI_PORT=1092 ENV=test-chrome-plugin`
    - [ ] `make test-ui API_PORT=8892 UI_PORT=5187 MAILDEV_UI_PORT=1092 ENV=test-chrome-plugin`
    - [ ] `make clean test-e2e API_PORT=8788 UI_PORT=5174 MAILDEV_UI_PORT=1084 ENV=e2e-chrome-plugin`
  - [ ] Final gate: Create PR with BRANCH.md content as initial message & Verify CI for the branch
  - [ ] Final commit removes `BRANCH.md` and checks `TODO.md`
