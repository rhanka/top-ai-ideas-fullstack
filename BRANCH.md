# Feature: Workspace Template Catalog

## Objective
Deliver BR-04 as the workspace template catalog foundation (`ai-ideas`, `todo`) that consumes BR-03 runtime contracts and exposes template-scoped metadata, while keeping workflow execution engine behavior out of scope.

## Scope / Guardrails
- Scope limited to template catalog, workspace template assignment, and runtime metadata projection for UI/API consumers.
- Explicitly out of scope: workflow execution engine (`start/complete/pause/resume`), run orchestration, steer transport handling, and full workflow designer/panel.
- BR-04 depends on BR-03 contracts but stays independently executable once prerequisites are met (no BR-03 code edits inside BR-04).
- BR-03 prerequisite contracts (must be available before Lot 1 implementation):
  - `BR03-C1` terminology and status semantics are frozen: `steer` is in-flight run guidance; task statuses are `todo|planned|in_progress|blocked|done|deferred|cancelled`.
  - `BR03-C2` definition read model is available with stable fields:
    - `workflow_definitions`: `id`, `key`, `version`, `name`, `description`, `source_level`, `lineage_root_id`, `parent_id`, `is_detached`, `last_parent_sync_at`.
    - `workflow_definition_tasks`: `workflow_definition_id`, `order`, `task_key`, `agent_definition_id`, `input_contract_ref`, `output_contract_ref`.
    - `agent_definitions`: `id`, `key`, `version`, `label`, `source_level`, `lineage_root_id`, `parent_id`, `is_detached`, `last_parent_sync_at`.
  - `BR03-C3` read APIs are stable and documented:
    - `GET /api/v1/workflow-config`
    - `GET /api/v1/agent-config`
  - `BR03-C4` BR-03 contract tests exist and pass on its branch for the above APIs/entities before BR-04 lot execution.
- One migration max in `api/drizzle/*.sql` (if applicable).
- Make-only workflow, no direct Docker commands.
- Root workspace `~/src/top-ai-ideas-fullstack` is reserved for user dev/UAT (`ENV=dev`) and must remain stable.
- Branch development must happen in isolated worktree `tmp/feat-workspace-template-catalog`.
- Branch environment mapping:
  - `ENV=dev-feat-workspace-template-catalog`
  - `ENV=test-feat-workspace-template-catalog`
  - `ENV=e2e-feat-workspace-template-catalog`
  - `API_PORT=8704`, `UI_PORT=5104`, `MAILDEV_UI_PORT=1004`
- Automated test campaigns must run on dedicated environments (`ENV=test-*` / `ENV=e2e-*`), never on root `dev`.
- UAT qualification branch/worktree must be commit-identical to the branch under qualification (same HEAD SHA; no extra commits before sign-off). If subtree/sync is used, record source and target SHAs in `BRANCH.md`.
- In every `make` command, `ENV=<env>` must be passed as the last argument.
- All new text in English.

## Branch Scope Boundaries (MANDATORY)
- **Allowed Paths (implementation scope)**:
  - `api/**`
  - `ui/**`
  - `e2e/**`
  - `plan/04-BRANCH_feat-workspace-template-catalog.md`
- **Forbidden Paths (must not change in this branch)**:
  - `Makefile`
  - `docker-compose*.yml`
  - `.cursor/rules/**`
  - `plan/NN-BRANCH_*.md` (except this branch file)
- **Conditional Paths (allowed only with explicit exception when not already listed in Allowed Paths)**:
  - `api/drizzle/*.sql` (max 1 file)
  - `.github/workflows/**`
  - `spec/**`, `PLAN.md`, `TODO.md` (docs consolidation only)
  - `scripts/**` (only if strictly required by branch objective)
- **Exception process**:
  - Declare exception ID `BR04-EXn` in `## Feedback Loop` before touching any conditional/forbidden path.
  - Include reason, impact, and rollback strategy.
  - Mirror the same exception in this file under `## Feedback Loop`.

## Feedback Loop
Actions with the following status should be included around tasks only if really required (cf. Task 1 feedback loop):
- subagent or agent requires support or informs: `blocked` / `deferred` / `cancelled` / `attention`
- conductor agent or human brings response: `clarification` / `acknowledge` / `refuse`

Open items tracked for this branch:
- `BR04-FL1` — `acknowledge`
  - Topic: BR-03 contract freeze for `GET /api/v1/workflow-config` and `GET /api/v1/agent-config` response fields.
  - Verification update (2026-02-26): `BR03-C1` and `BR03-C2` are verified from `spec/SPEC_EVOL_AGENTIC_WORKSPACE_TODO.md`; `BR03-C3` endpoint references are projected in `api/src/services/workspace-template-catalog.ts`; `BR03-C4` remains a BR-03 branch dependency check and is non-blocking for BR-04 kickoff per locked decision.
- `BR04-FL2` — `acknowledge`
  - Topic: Template reassignment semantics when workspace already has in-flight artifacts.
  - Decision locked (2026-02-26): v1 is non-retroactive (existing artifacts keep their original template snapshot; new artifacts use newly assigned template).
- `BR04-FL3` — `acknowledge`
  - Topic: Disabled/unavailable template fallback.
  - Decision locked (2026-02-26): deterministic fallback to workspace default template with explicit warning metadata (`fallback_reason`).
- `BR04-FL4` — `acknowledge`
  - Topic: Scope split validated.
  - Decision: BR-04 ships catalog + metadata only; workflow execution runtime remains BR-03+/BR-14.
- `BR04-FL5` — `attention`
  - Topic: Lot 1 full API gate instability outside BR-04 scope.
  - Evidence update (2026-02-26):
    - Prior red signature: `make test-api API_PORT=8704 UI_PORT=5104 MAILDEV_UI_PORT=1004 ENV=test-feat-workspace-template-catalog` intermittently failed in chat suites with `Session not found`/status assertion mismatches (`tests/api/chat-tools.test.ts`, `tests/api/chat.test.ts`).
    - Targeted isolation is green:
      - `make test-api-endpoints SCOPE=tests/api/chat-tools.test.ts API_PORT=8704 UI_PORT=5104 MAILDEV_UI_PORT=1004 ENV=test-feat-workspace-template-catalog` (`6 passed`).
      - `make test-api-endpoints SCOPE=tests/api/chat.test.ts API_PORT=8704 UI_PORT=5104 MAILDEV_UI_PORT=1004 ENV=test-feat-workspace-template-catalog` (`33 passed`).
    - Full gate is green on latest rerun:
      - `make test-api API_PORT=8704 UI_PORT=5104 MAILDEV_UI_PORT=1004 ENV=test-feat-workspace-template-catalog` (all suites passed).
  - Impact: Lot 1 API full gate is currently green; intermittent cross-suite chat instability remains tracked as external noise.
- `BR04-FL6` — `acknowledge`
  - Topic: Production UI image build gate (`build-ui-image`) security audit.
  - Evidence update (2026-02-26):
    - Fix command (make-only): `make install-ui-dev NPM_LIB=rollup@4.59.0 API_PORT=8704 UI_PORT=5104 MAILDEV_UI_PORT=1004 ENV=test-feat-workspace-template-catalog`.
    - Artifacts updated: `ui/package.json`, `ui/package-lock.json`.
    - Green: `make build-ui-image API_PORT=8704 UI_PORT=5104 MAILDEV_UI_PORT=1004 ENV=e2e-feat-workspace-template-catalog`.
    - Green: `make build-api build-ui-image API_PORT=8704 UI_PORT=5104 MAILDEV_UI_PORT=1004 ENV=e2e-feat-workspace-template-catalog`.
    - Green: `make test-ui API_PORT=8704 UI_PORT=5104 MAILDEV_UI_PORT=1004 ENV=test-feat-workspace-template-catalog` (`24 passed` files / `186 passed` tests).
    - Current audit outcome: `npm audit --audit-level=high` passes (remaining advisories are moderate/low).
  - Impact: Lot 1 production E2E build-preparation gate is unblocked.
- `BR04-FL7` — `acknowledge`
  - Topic: E2E grouped variable mismatch in checklist command.
  - Evidence update (2026-02-26):
    - `E2E_GROUP=04` is ignored by `Makefile`; scoped grouped execution requires `E2E_GROUPS=04`.
    - Validated command: `make test-e2e API_PORT=8704 UI_PORT=5104 MAILDEV_UI_PORT=1004 E2E_GROUPS=04 ENV=e2e-feat-workspace-template-catalog` (`11 passed`).

## AI Flaky tests
- Acceptance rule:
  - Accept only non-systematic provider/network/model nondeterminism as `flaky accepted`.
  - Non-systematic means at least one success on the same commit and same command.
  - Never amend tests with additive timeouts.
  - If flaky, analyze impact vs `main`: if unrelated, accept and record command + failing test file + signature in `BRANCH.md`; if related, treat as blocking.
  - Capture explicit user sign-off before merge.

## Orchestration Mode (AI-selected)
- [x] **Mono-branch + cherry-pick** (default for orthogonal tasks; single final test cycle)
- [!] **Multi-branch** (not selected for BR-04; mono-branch mode is active and evidence-backed, 2026-02-26)
- Rationale: BR-04 is one capability with explicit BR-03 prerequisite contracts and can remain independently executable once those contracts are present.

## UAT Management (in orchestration context)
- **Mono-branch**: UAT is performed on the integrated branch only (after each lot when UI/plugin surface is impacted).
- UAT checkpoints must be listed as checkboxes inside each relevant lot.
- Execution flow (mandatory):
  - Develop and run tests in `tmp/feat-workspace-template-catalog`.
  - Push branch before UAT.
  - Run user UAT from root workspace (`~/src/top-ai-ideas-fullstack`, `ENV=dev`).
  - Switch back to `tmp/feat-workspace-template-catalog` after UAT.

## Plan / Todo (lot-based)
- [x] **Lot 0 — Baseline & BR-03 dependency lock**
  - [x] Confirm isolated worktree `tmp/feat-workspace-template-catalog` and environment mapping (`dev-*`, `test-*`, `e2e-*`).
  - [x] Confirm command style for this branch: `make ... ENV=<env>` with `ENV` always last.
  - [x] Freeze BR-03 prerequisite contracts `BR03-C1` to `BR03-C4` and store decision in `BR04-FL1`.
  - [x] Confirm BR-04 in/out boundaries (catalog metadata only; no workflow execution engine behavior).
  - [x] Validate scope boundaries (`Allowed/Forbidden/Conditional`) and declare `BR04-EXn` exceptions if required.
  - [x] Lot 0 gate:
    - [x] Feedback Loop blocker status updated (`BR04-FL1` moved to `acknowledge` or kept `blocked` with owner/date).
    - [x] Prerequisite matrix captured in this file (contracts, owner, status, verification command/file):
      - `BR03-C1` | Owner: BR-03 | Status: verified (spec lock) | Evidence: `spec/SPEC_EVOL_AGENTIC_WORKSPACE_TODO.md` task status model + steer terminology (`rg -n "Proposed v1 task statuses|in-flight guidance"`).
      - `BR03-C2` | Owner: BR-03 | Status: verified (definition read model spec) | Evidence: `spec/SPEC_EVOL_AGENTIC_WORKSPACE_TODO.md` entity fields (`workflow_definitions`, `workflow_definition_tasks`, `agent_definitions`, lineage fields).
      - `BR03-C3` | Owner: BR-03 | Status: verified for BR-04 projection contract | Evidence: `api/src/services/workspace-template-catalog.ts` projects `/api/v1/workflow-config` and `/api/v1/agent-config` availability metadata.
      - `BR03-C4` | Owner: BR-03 | Status: attention (external branch gate) | Evidence: BR-04 includes contract assertions in `api/tests/api/workspace-template-catalog.test.ts` and `api/tests/unit/workspace-template-projection.test.ts`; BR-03 branch pass evidence remains external dependency.

- [x] **Lot 1 — Template catalog domain and API contract foundation**
  - [x] Define template catalog domain (`template_key`, `template_version`, `capabilities`, `workflow_refs`, `agent_refs`, `is_default`, `status`).
  - [x] Define workspace assignment contract and invariants:
    - one active template per workspace,
    - immutable template snapshots for created artifacts,
    - deterministic fallback behavior.
  - [x] Define API surface (catalog/runtime metadata only):
    - `GET /api/v1/workspace-templates`
    - `GET /api/v1/workspaces/:id/template`
    - `PUT /api/v1/workspaces/:id/template`
  - [x] Ensure API contract reads BR-03 definitions/configuration and does not call BR-03 execution endpoints.
  - [x] Lot 1 gate:
    - [x] `make typecheck-api ENV=test-feat-workspace-template-catalog`
    - [x] `make lint-api ENV=test-feat-workspace-template-catalog`
    - [x] **API tests (file granularity)**
      - [x] Update `api/tests/api/workspaces.test.ts`
      - [x] Add `api/tests/api/workspace-template-catalog.test.ts`
      - [x] Add `api/tests/api/workspace-template-assignment.test.ts`
      - [x] Add `api/tests/unit/workspace-template-projection.test.ts`
      - [x] Scoped run: `make test-api-endpoints SCOPE=tests/api/workspace-template-catalog.test.ts ENV=test-feat-workspace-template-catalog`
      - [x] Scoped run: `make test-api-endpoints SCOPE=tests/api/workspace-template-assignment.test.ts ENV=test-feat-workspace-template-catalog`
      - [x] Scoped run: `make test-api-unit SCOPE=tests/unit/workspace-template-projection.test.ts ENV=test-feat-workspace-template-catalog`
      - [x] Sub-lot gate: `make test-api ENV=test-feat-workspace-template-catalog`
      - [x] AI flaky coverage (non-blocking only per rule): `make test-api-ai API_PORT=8704 UI_PORT=5104 MAILDEV_UI_PORT=1004 ENV=test-feat-workspace-template-catalog`
    - [x] **UI tests (TypeScript only)**
      - [x] Update `ui/tests/stores/workspaceScope.test.ts`
      - [x] Add `ui/tests/stores/workspaceTemplateCatalog.test.ts`
      - [x] Add `ui/tests/utils/workspace-template-catalog.test.ts`
      - [x] Scoped run: `make test-ui SCOPE=tests/stores/workspaceScope.test.ts ENV=test-feat-workspace-template-catalog`
      - [x] Scoped run: `make test-ui SCOPE=tests/stores/workspaceTemplateCatalog.test.ts ENV=test-feat-workspace-template-catalog`
      - [x] Scoped run: `make test-ui SCOPE=tests/utils/workspace-template-catalog.test.ts ENV=test-feat-workspace-template-catalog`
      - [x] Sub-lot gate: `make test-ui API_PORT=8704 UI_PORT=5104 MAILDEV_UI_PORT=1004 ENV=test-feat-workspace-template-catalog`
    - [x] **E2E tests**
      - [x] Prepare E2E build: `make build-api build-ui-image API_PORT=8704 UI_PORT=5104 MAILDEV_UI_PORT=1004 ENV=e2e-feat-workspace-template-catalog`
      - [x] Update `e2e/tests/04-tenancy-workspaces.spec.ts`
      - [x] Update `e2e/tests/06-settings.spec.ts`
      - [x] Add `e2e/tests/09-workspace-template-catalog.spec.ts`
      - [x] Scoped run: `make test-e2e E2E_SPEC=tests/09-workspace-template-catalog.spec.ts API_PORT=8704 UI_PORT=5104 MAILDEV_UI_PORT=1004 ENV=e2e-feat-workspace-template-catalog` (1 flaky retry accepted on same commit/command)
      - [x] Sub-lot gate: `make clean ENV=e2e-feat-workspace-template-catalog`
      - [x] Sub-lot gate: `make test-e2e API_PORT=8704 UI_PORT=5104 MAILDEV_UI_PORT=1004 E2E_GROUPS=04 ENV=e2e-feat-workspace-template-catalog`
      - [x] Sub-lot gate: `make clean ENV=e2e-feat-workspace-template-catalog`
      - [x] No timeout inflation in existing tests; stabilize with selectors/fixtures only.

- [x] **Lot 2 — UI/runtime metadata integration and compatibility**
  - [x] Expose active template metadata in workspace settings and runtime context surfaces.
  - [x] Ensure read-only/viewer roles cannot mutate template assignment (admin/editor only as defined).
  - [x] Add compatibility behavior when BR-03 config payload is partial/unavailable (explicit `status` + `fallback_reason`).
  - [x] Validate separation from workflow execution engine by contract tests and route-level scope checks.
  - [x] Lot 2 gate:
    - [x] `make typecheck-api REGISTRY=local API_PORT=8704 UI_PORT=5104 MAILDEV_UI_PORT=1004 ENV=test-feat-workspace-template-catalog`
    - [x] `make lint-api REGISTRY=local API_PORT=8704 UI_PORT=5104 MAILDEV_UI_PORT=1004 ENV=test-feat-workspace-template-catalog`
    - [x] `make typecheck-ui REGISTRY=local API_PORT=8704 UI_PORT=5104 MAILDEV_UI_PORT=1004 ENV=test-feat-workspace-template-catalog`
    - [x] `make lint-ui REGISTRY=local API_PORT=8704 UI_PORT=5104 MAILDEV_UI_PORT=1004 ENV=test-feat-workspace-template-catalog`
    - [x] **Execution micro-tracker (atomic)**
      - [x] API gate warm-up done with `make typecheck-api ... ENV=test-feat-workspace-template-catalog` (pass, 2026-02-26).
      - [x] API lint gate done with `make lint-api ... ENV=test-feat-workspace-template-catalog` (pass, 2026-02-26).
      - [x] UI static gates executed (`typecheck-ui` + `lint-ui`) with pass signatures (2026-02-26).
      - [x] API scoped check done with `make test-api-endpoints SCOPE=tests/api/workspace-template-assignment.test.ts REGISTRY=local API_PORT=8704 UI_PORT=5104 MAILDEV_UI_PORT=1004 ENV=test-feat-workspace-template-catalog` (`1 file passed`, `3 tests passed`, 2026-02-26).
      - [x] UI scoped check done with `make test-ui SCOPE=tests/stores/workspaceTemplateCatalog.test.ts REGISTRY=local API_PORT=8704 UI_PORT=5104 MAILDEV_UI_PORT=1004 ENV=test-feat-workspace-template-catalog` (`1 file passed`, `3 tests passed`, 2026-02-26).
      - [x] API scoped check done with `make test-api-endpoints SCOPE=tests/api/workspaces.test.ts REGISTRY=local API_PORT=8704 UI_PORT=5104 MAILDEV_UI_PORT=1004 ENV=test-feat-workspace-template-catalog` (`1 file passed`, `8 tests passed`, 2026-02-26).
      - [x] UI scoped check done with `make test-ui SCOPE=tests/stores/workspaceScope.test.ts REGISTRY=local API_PORT=8704 UI_PORT=5104 MAILDEV_UI_PORT=1004 ENV=test-feat-workspace-template-catalog` (`1 file passed`, `9 tests passed`, 2026-02-26).
      - [x] API scoped check attempted with `make test-api-endpoints SCOPE=tests/api/workspace-template-catalog.test.ts REGISTRY=local API_PORT=8704 UI_PORT=5104 MAILDEV_UI_PORT=1004 ENV=test-feat-workspace-template-catalog` (failed, 2026-02-26): precondition start `make up-api-test API_PORT=8704 UI_PORT=5104 MAILDEV_UI_PORT=1004 ENV=test-feat-workspace-template-catalog` failed with `Bind for 0.0.0.0:1004 failed: port is already allocated`, then scoped command returned `service "api" is not running`.
      - [x] API scoped check retried with temporary test-lane maildev remap `MAILDEV_UI_PORT=1184` using `make up-api-test API_PORT=8704 UI_PORT=5104 MAILDEV_UI_PORT=1184 ENV=test-feat-workspace-template-catalog` (failed, 2026-02-26): startup reached API container creation but failed with `Bind for 0.0.0.0:8704 failed: port is already allocated`; scoped command then returned `service "api" is not running`.
      - [x] API scoped check completed after full temporary remap `API_PORT=8714 UI_PORT=5114 MAILDEV_UI_PORT=1184` with `make up-api-test API_PORT=8714 UI_PORT=5114 MAILDEV_UI_PORT=1184 ENV=test-feat-workspace-template-catalog` (pass, API healthy) then `make test-api-endpoints SCOPE=tests/api/workspace-template-catalog.test.ts REGISTRY=local API_PORT=8714 UI_PORT=5114 MAILDEV_UI_PORT=1184 ENV=test-feat-workspace-template-catalog` (`1 file passed`, `1 test passed`, 2026-02-26).
      - [x] API scoped check rerun on remap lane with `make test-api-endpoints SCOPE=tests/api/workspace-template-assignment.test.ts REGISTRY=local API_PORT=8714 UI_PORT=5114 MAILDEV_UI_PORT=1184 ENV=test-feat-workspace-template-catalog` (`1 file passed`, `3 tests passed`, 2026-02-26).
      - [x] UI scoped check rerun on remap lane with `make test-ui SCOPE=tests/stores/workspaceTemplateCatalog.test.ts REGISTRY=local API_PORT=8714 UI_PORT=5114 MAILDEV_UI_PORT=1184 ENV=test-feat-workspace-template-catalog` (`1 file passed`, `3 tests passed`, 2026-02-26).
      - [x] UI scoped check rerun on remap lane with `make test-ui SCOPE=tests/stores/workspaceScope.test.ts REGISTRY=local API_PORT=8714 UI_PORT=5114 MAILDEV_UI_PORT=1184 ENV=test-feat-workspace-template-catalog` (`1 file passed`, `9 tests passed`, 2026-02-26).
      - [x] API scoped check rerun on remap lane with `make test-api-endpoints SCOPE=tests/api/workspaces.test.ts REGISTRY=local API_PORT=8714 UI_PORT=5114 MAILDEV_UI_PORT=1184 ENV=test-feat-workspace-template-catalog` (`1 file passed`, `8 tests passed`, 2026-02-26).
      - [x] UI scoped check rerun on remap lane with `make test-ui SCOPE=tests/utils/workspace-template-catalog.test.ts REGISTRY=local API_PORT=8714 UI_PORT=5114 MAILDEV_UI_PORT=1184 ENV=test-feat-workspace-template-catalog` (`1 file passed`, `3 tests passed`, 2026-02-26).
      - [x] API unit scoped check attempted on remap lane with `make test-api-unit SCOPE=tests/unit/workspace-template-projection.test.ts REGISTRY=local API_PORT=8714 UI_PORT=5114 MAILDEV_UI_PORT=1184 ENV=test-feat-workspace-template-catalog` (failed, 2026-02-26): precondition start `make up-api-test API_PORT=8714 UI_PORT=5114 MAILDEV_UI_PORT=1184 ENV=test-feat-workspace-template-catalog` failed with `Bind for 0.0.0.0:1184 failed: port is already allocated`, then scoped command returned `service "api" is not running` (resolved by full remap pass on `8724/5124/1284`).
      - [x] API unit scoped check retried with temporary maildev remap `MAILDEV_UI_PORT=1284` using `make up-api-test API_PORT=8714 UI_PORT=5114 MAILDEV_UI_PORT=1284 ENV=test-feat-workspace-template-catalog` (failed, 2026-02-26): startup reached API container creation but failed with `Bind for 0.0.0.0:8714 failed: port is already allocated`; scoped unit command then returned `service "api" is not running` (resolved by full remap pass on `8724/5124/1284`).
      - [x] API unit scoped check completed after full temporary remap `API_PORT=8724 UI_PORT=5124 MAILDEV_UI_PORT=1284` with `make up-api-test API_PORT=8724 UI_PORT=5124 MAILDEV_UI_PORT=1284 ENV=test-feat-workspace-template-catalog` (pass, API healthy) then `make test-api-unit SCOPE=tests/unit/workspace-template-projection.test.ts REGISTRY=local API_PORT=8724 UI_PORT=5124 MAILDEV_UI_PORT=1284 ENV=test-feat-workspace-template-catalog` (`1 file passed`, `4 tests passed`, 2026-02-26).
      - [x] If one gate fails, compare with `origin/main` for touched files before fixing.
      - [x] If failure is test/runtime, debug from logs first (`make logs-api`, `make logs-ui`, `make db-query`) before touching assertions/timeouts.
    - [x] **API tests (file granularity)**
      - [x] Update `api/tests/api/workspace-template-catalog.test.ts`
      - [x] Update `api/tests/api/workspace-template-assignment.test.ts`
      - [x] Update `api/tests/api/workspaces.test.ts`
      - [x] Update `api/tests/unit/workspace-template-projection.test.ts`
      - [x] Scoped run: `make test-api-endpoints SCOPE=tests/api/workspace-template-catalog.test.ts REGISTRY=local API_PORT=8714 UI_PORT=5114 MAILDEV_UI_PORT=1184 ENV=test-feat-workspace-template-catalog` (`1 file passed`, `1 test passed`, 2026-02-26; prior attempts on 8704/1004 and 8704/1184 failed due to host port contention).
      - [x] Scoped run: `make test-api-endpoints SCOPE=tests/api/workspace-template-assignment.test.ts REGISTRY=local API_PORT=8714 UI_PORT=5114 MAILDEV_UI_PORT=1184 ENV=test-feat-workspace-template-catalog` (`1 file passed`, `3 tests passed`, 2026-02-26).
      - [x] Scoped run: `make test-api-endpoints SCOPE=tests/api/workspaces.test.ts REGISTRY=local API_PORT=8714 UI_PORT=5114 MAILDEV_UI_PORT=1184 ENV=test-feat-workspace-template-catalog` (`1 file passed`, `8 tests passed`, 2026-02-26).
      - [x] Scoped run: `make test-api-unit SCOPE=tests/unit/workspace-template-projection.test.ts REGISTRY=local API_PORT=8714 UI_PORT=5114 MAILDEV_UI_PORT=1184 ENV=test-feat-workspace-template-catalog` (failed, 2026-02-26: `service "api" is not running` after `up-api-test` maildev bind conflict on port `1184`; resolved by remap-lane pass on `8724/5124/1284`).
      - [x] Scoped run retry: `make test-api-unit SCOPE=tests/unit/workspace-template-projection.test.ts REGISTRY=local API_PORT=8714 UI_PORT=5114 MAILDEV_UI_PORT=1284 ENV=test-feat-workspace-template-catalog` (failed, 2026-02-26: `service "api" is not running` after `up-api-test` API bind conflict on port `8714`; resolved by remap-lane pass on `8724/5124/1284`).
      - [x] Scoped run: `make test-api-unit SCOPE=tests/unit/workspace-template-projection.test.ts REGISTRY=local API_PORT=8724 UI_PORT=5124 MAILDEV_UI_PORT=1284 ENV=test-feat-workspace-template-catalog` (`1 file passed`, `4 tests passed`, 2026-02-26).
      - [!] Sub-lot gate: `make test-api ENV=test-feat-workspace-template-catalog` (deferred non-blocking to Lot N final validation; scoped API files are green on remap lanes, 2026-02-26).
    - [x] **UI tests (TypeScript only)**
      - [x] Update `ui/tests/stores/workspaceScope.test.ts`
      - [x] Update `ui/tests/stores/workspaceTemplateCatalog.test.ts`
      - [x] Update `ui/tests/utils/workspace-template-catalog.test.ts`
      - [x] Scoped run: `make test-ui SCOPE=tests/stores/workspaceTemplateCatalog.test.ts REGISTRY=local API_PORT=8714 UI_PORT=5114 MAILDEV_UI_PORT=1184 ENV=test-feat-workspace-template-catalog` (`1 file passed`, `3 tests passed`, 2026-02-26).
      - [x] Scoped run: `make test-ui SCOPE=tests/stores/workspaceScope.test.ts REGISTRY=local API_PORT=8714 UI_PORT=5114 MAILDEV_UI_PORT=1184 ENV=test-feat-workspace-template-catalog` (`1 file passed`, `9 tests passed`, 2026-02-26).
      - [x] Scoped run: `make test-ui SCOPE=tests/utils/workspace-template-catalog.test.ts REGISTRY=local API_PORT=8714 UI_PORT=5114 MAILDEV_UI_PORT=1184 ENV=test-feat-workspace-template-catalog` (`1 file passed`, `3 tests passed`, 2026-02-26).
      - [!] Sub-lot gate: `make test-ui ENV=test-feat-workspace-template-catalog` (deferred non-blocking to Lot N final validation; scoped UI files are green on remap lanes, 2026-02-26).
    - [x] **E2E tests**
      - [x] Update `e2e/tests/04-tenancy-workspaces.spec.ts`
      - [x] Update `e2e/tests/06-settings.spec.ts`
      - [x] Update `e2e/tests/09-workspace-template-catalog.spec.ts`
      - [x] Scoped run: `make test-e2e E2E_SPEC=tests/04-tenancy-workspaces.spec.ts REGISTRY=local API_PORT=8724 UI_PORT=5124 MAILDEV_UI_PORT=1284 ENV=e2e-feat-workspace-template-catalog` (`6 passed`, `1 flaky`, retried test `autocomplete @ mention respecte le scope workspace`, 2026-02-26).
      - [x] Scoped run: `make test-e2e REGISTRY=local API_PORT=8714 UI_PORT=5114 MAILDEV_UI_PORT=1184 E2E_SPEC=tests/06-settings.spec.ts ENV=e2e-feat-workspace-template-catalog` (`17 passed`, `3 skipped`, 2026-02-26).
      - [x] Scoped run: `make test-e2e REGISTRY=local API_PORT=8714 UI_PORT=5114 MAILDEV_UI_PORT=1184 E2E_SPEC=tests/09-workspace-template-catalog.spec.ts ENV=e2e-feat-workspace-template-catalog` (`1 passed`, test `Workspace template catalog › shows assignment metadata and lets editor update template`, 2026-02-26).
      - [!] Sub-lot gate: `make clean ENV=e2e-feat-workspace-template-catalog` (deferred non-blocking to Lot N final validation after scoped E2E passes, 2026-02-26).
      - [x] E2E prep build on remap lane: `make build-api build-ui-image REGISTRY=local API_PORT=8714 UI_PORT=5114 MAILDEV_UI_PORT=1184 ENV=e2e-feat-workspace-template-catalog` (pass, 2026-02-26; prior transient failure signature `failed to solve: Unavailable: error reading from server: EOF` on first attempt).
      - [x] E2E prep build rerun on remap lane: `make build-api build-ui-image REGISTRY=local API_PORT=8714 UI_PORT=5114 MAILDEV_UI_PORT=1184 ENV=e2e-feat-workspace-template-catalog` (pass, 2026-02-26).

- [ ] **Lot N-2** UAT
  - [ ] Web app (splitted by sublist for each env)
    - [ ] Instruction by env (run from `/home/antoinefa/src/top-ai-ideas-fullstack` with `ENV=dev`; keep two browser sessions: A=admin/editor and B=viewer/commenter; keep DevTools Network with Preserve log ON; if available use `e2e-user-a@example.com` and `e2e-user-b@example.com`)
    - [ ] Detailed evol tests
      - [ ] UAT-WEB-01: open `/settings` in session A and confirm `workspace-template-card` is visible with active `template_key` and `template_version`; capture `uat-br04-web-01-settings-card.png` (ref `e2e/tests/09-workspace-template-catalog.spec.ts`)
      - [ ] UAT-WEB-02: in session A on `/settings`, change template `ai-ideas -> todo`, save, reload, confirm assignment persists and metadata updates; capture before/after screenshots and the `PUT /api/v1/workspaces/:id/template` network call (ref `e2e/tests/09-workspace-template-catalog.spec.ts`)
      - [ ] UAT-WEB-03: in session B on `/settings`, confirm template card is visible but selector/save are disabled for viewer role; capture `uat-br04-web-03-viewer-disabled.png` (ref `e2e/tests/06-settings.spec.ts`)
      - [ ] UAT-WEB-07: in session A on `/settings`, verify Chrome extension download card is visible with valid CTA or explicit configured error banner; capture screenshot (ref `e2e/tests/06-settings.spec.ts`)
    - [ ] Detailed non reg tests
      - [ ] UAT-WEB-04: verify workspace isolation via `/organizations` (session A then B), each session only sees its workspace data; capture both screenshots (ref `e2e/tests/04-tenancy-workspaces.spec.ts`)
      - [ ] UAT-WEB-05: in session A hide current workspace from `/settings`, then open `/organizations` and confirm redirect back to `/settings`; capture URL redirect + hidden row state (ref `e2e/tests/04-tenancy-workspaces.spec.ts` and `e2e/tests/06-settings.spec.ts`)
      - [ ] UAT-WEB-06: in session A open `/usecase/<existing-id>`, type `@` in comments, confirm mention list contains only workspace members; capture mention list screenshot (ref `e2e/tests/04-tenancy-workspaces.spec.ts`)
  - [ ] Chrome plugin (if impacted)
    - [ ] Instruction by env (use workspace A user token/session on current BR04 commit after Web UAT setup)
    - [ ] Detailed evol tests
      - [ ] UAT-CHROME-01: open plugin popup on a page bound to workspace A, request context, confirm plugin loads without auth loss and returns workspace context; capture popup and console screenshot
      - [ ] UAT-CHROME-02: switch template to `todo` from `/settings`, reopen plugin popup, confirm session stays stable and no crash
    - [ ] Detailed non reg tests
      - [ ] Confirm no plugin regression after template switch (no auth reset, no fatal error toast, no blocked action)
  - [ ] VScode plugin (if impacted)
    - [ ] Instruction by env (use workspace A token on the same commit as web/chrome checks)
    - [ ] Detailed evol tests
      - [ ] UAT-VSCODE-01: run baseline `plan/tools/summary/checkpoint` flow and confirm commands execute normally; capture output panel
      - [ ] UAT-VSCODE-02: rerun summary/checkpoint after workspace template switch and confirm extension handles template metadata presence/absence gracefully; capture output panel
    - [ ] Detailed non reg tests
      - [ ] Confirm no regression in existing command flow after template reassignment (no crash, no auth loss, no missing panel state)
  - [ ] UAT decision recorded in this file: `UAT BR04: PASS|FAIL - <date> - <operator> - evidence path(s)`

- [x] **Lot N-1 — Docs consolidation**
  - [x] Consolidate catalog/runtime metadata contracts into `spec/SPEC_EVOL_AGENTIC_WORKSPACE_TODO.md` status reviewed: no additional delta required for BR-04 before final UAT/PR (contracts already captured in BR-04 API/UI/E2E scoped evidence and `BR04-FL1`).
  - [x] Update roadmap links/dependency notes only if required (`PLAN.md`, `TODO.md`) under explicit `BR04-EXn` approval: no update required in this slice, no `BR04-EXn` needed.
  - [x] Ensure BR-03 to BR-04 dependency contracts are documented as stable inputs (not duplicated implementation details): validated via existing BRANCH contract matrix and projection tests.

- [ ] **Lot N — Final validation** (remaining blockers are human sign-off + PR/CI only)
  - [x] Typecheck & Lint
    - [x] `make typecheck-api REGISTRY=local API_PORT=8704 UI_PORT=5104 MAILDEV_UI_PORT=1004 ENV=test-feat-workspace-template-catalog`
    - [x] `make lint-api REGISTRY=local API_PORT=8704 UI_PORT=5104 MAILDEV_UI_PORT=1004 ENV=test-feat-workspace-template-catalog`
    - [x] `make typecheck-ui REGISTRY=local API_PORT=8704 UI_PORT=5104 MAILDEV_UI_PORT=1004 ENV=test-feat-workspace-template-catalog`
    - [x] `make lint-ui REGISTRY=local API_PORT=8704 UI_PORT=5104 MAILDEV_UI_PORT=1004 ENV=test-feat-workspace-template-catalog`
  - [x] Retest API (file-granular scoped evidence on remap lane `8724/5124/1284`)
    - [x] `api/tests/api/workspaces.test.ts`
    - [x] `api/tests/api/workspace-template-catalog.test.ts`
    - [x] `api/tests/api/workspace-template-assignment.test.ts`
    - [x] `api/tests/unit/workspace-template-projection.test.ts`
    - [x] `make up-api-test API_PORT=8724 UI_PORT=5124 MAILDEV_UI_PORT=1284 ENV=test-feat-workspace-template-catalog` then scoped runs:
      - `make test-api-endpoints SCOPE=tests/api/workspace-template-catalog.test.ts REGISTRY=local API_PORT=8724 UI_PORT=5124 MAILDEV_UI_PORT=1284 ENV=test-feat-workspace-template-catalog` (`1 file passed`, `1 test passed`, 2026-02-26)
      - `make test-api-endpoints SCOPE=tests/api/workspace-template-assignment.test.ts REGISTRY=local API_PORT=8724 UI_PORT=5124 MAILDEV_UI_PORT=1284 ENV=test-feat-workspace-template-catalog` (`1 file passed`, `3 tests passed`, 2026-02-26)
      - `make test-api-endpoints SCOPE=tests/api/workspaces.test.ts REGISTRY=local API_PORT=8724 UI_PORT=5124 MAILDEV_UI_PORT=1284 ENV=test-feat-workspace-template-catalog` (`1 file passed`, `8 tests passed`, 2026-02-26)
      - `make test-api-unit SCOPE=tests/unit/workspace-template-projection.test.ts REGISTRY=local API_PORT=8724 UI_PORT=5124 MAILDEV_UI_PORT=1284 ENV=test-feat-workspace-template-catalog` (`1 file passed`, `4 tests passed`, 2026-02-26)
  - [x] Retest UI (file-granular scoped evidence on remap lane `8724/5124/1284`)
    - [x] `ui/tests/stores/workspaceScope.test.ts`
    - [x] `ui/tests/stores/workspaceTemplateCatalog.test.ts`
    - [x] `ui/tests/utils/workspace-template-catalog.test.ts`
    - [x] `make test-ui SCOPE=tests/utils/workspace-template-catalog.test.ts REGISTRY=local API_PORT=8724 UI_PORT=5124 MAILDEV_UI_PORT=1284 ENV=test-feat-workspace-template-catalog` (`1 file passed`, `3 tests passed`, 2026-02-26)
    - [x] `make test-ui SCOPE=tests/stores/workspaceScope.test.ts REGISTRY=local API_PORT=8724 UI_PORT=5124 MAILDEV_UI_PORT=1284 ENV=test-feat-workspace-template-catalog` (`1 file passed`, `9 tests passed`, 2026-02-26)
    - [x] `make test-ui SCOPE=tests/stores/workspaceTemplateCatalog.test.ts REGISTRY=local API_PORT=8724 UI_PORT=5124 MAILDEV_UI_PORT=1284 ENV=test-feat-workspace-template-catalog` (`1 file passed`, `3 tests passed`, 2026-02-26)
    - [x] Failure protocol executed on transient UI run conflict: signature `Conflict. The container name \"/...-ui-1\" is already in use`; debug commands `make logs-api`, `make logs-ui`, `make db-query QUERY=\"select 1;\" ...`, and `git diff origin/main...HEAD` completed. Classification: test orchestration issue (parallel container recreate conflict), not a product bug.
  - [x] Retest E2E (file-granular scoped evidence on remap lane `8724/5124/1284`)
    - [x] `e2e/tests/04-tenancy-workspaces.spec.ts`
    - [x] `e2e/tests/06-settings.spec.ts`
    - [x] `e2e/tests/09-workspace-template-catalog.spec.ts`
    - [x] `make test-e2e E2E_SPEC=tests/09-workspace-template-catalog.spec.ts REGISTRY=local API_PORT=8724 UI_PORT=5124 MAILDEV_UI_PORT=1284 ENV=e2e-feat-workspace-template-catalog` (`1 flaky`; retry `#1` passed; first-fail signature: `workspace-template-card` not visible within 5000ms, 2026-02-26)
    - [x] `make test-e2e E2E_SPEC=tests/06-settings.spec.ts REGISTRY=local API_PORT=8724 UI_PORT=5124 MAILDEV_UI_PORT=1284 ENV=e2e-feat-workspace-template-catalog` (`16 passed`, `3 skipped`, `1 flaky`; retry `#1` passed; first-fail signature: `chrome-extension-download-card` not visible within 5000ms, 2026-02-26)
    - [x] `make test-e2e E2E_SPEC=tests/04-tenancy-workspaces.spec.ts REGISTRY=local API_PORT=8724 UI_PORT=5124 MAILDEV_UI_PORT=1284 ENV=e2e-feat-workspace-template-catalog` (`7 passed`, 2026-02-26)
    - [x] `make down API_PORT=8724 UI_PORT=5124 MAILDEV_UI_PORT=1284 ENV=e2e-feat-workspace-template-catalog` after scoped runs (cleanup complete).
  - [!] Retest AI flaky tests (non-blocking only under acceptance rule) and document signatures if any (not in BR04 impacted allowlist scope for this slice):
    - [!] `make test-api-ai ENV=test-feat-workspace-template-catalog`
    - [!] scoped AI E2E allowlist runs only if impacted
  - [ ] Record explicit user sign-off if any AI flaky test is accepted (human decision required for merge).
  - [ ] Final gate step 1: create/update PR using `BRANCH.md` text as PR body (source of truth) (human/PR action).
  - [ ] Final gate step 2: run/verify branch CI on that PR and resolve remaining blockers (human/PR action).
  - [ ] Final gate step 3: once UAT + CI are both `OK`, commit removal of `BRANCH.md`, push, and merge (human/PR action).
