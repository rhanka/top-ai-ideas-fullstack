# Feature: Collaboration (Workspace sharing, object edition locks, comments, import/export)

## Objective
Implement the "Collaboration" scope from `TODO.md` (lines 96–119):
- Workspace sharing (create/delete workspaces, manage member roles)
- Object edition locks (single editor, locked view for others, unlock request flow)
- Live updates for viewers/locked editors via SSE
- Import/export (workspace, folder, use cases, organizations) with dedicated file extensions
- Comments (threaded one-level replies, @mentions, close workflow, export option with/without comments)

Out of scope:
- Any `TODO.md` items outside "Collaboration"
- Broad refactors not required by the feature set

## Constraints / Guardrails (branch-specific)
- **Make-only execution** (Docker-first): do not run `npm/node/docker` directly; use `make` targets only.
- **Single data model evolution** in this branch: plan all schema changes together, then apply once.
- **No destructive DB/system actions without ⚠ approval**.
- **UAT data protection**: do not run `make test-ui`, `make test-api`, `make test-e2e` until the final "Tests" phase (tests are expected to reset/seed DB and may break in-progress UAT data).
- **Quality gates per lot**: run `make typecheck` and `make lint` after each lot (safe checks).
- **Atomic commits**: avoid multiple commits for the same feature/lot; keep changes minimal and scoped.
- **English-only for code/docs** (per `.cursor/rules/MASTER.mdc`); user discussion stays in French.

## Design Decisions (confirmed)

### Workspace Selection & Storage
- **Selection storage**: localStorage for this branch (future: user preference in DB - see `spec/COLLAB.md` / `TODO.md`).
- **Default workspace initialization**: If no localStorage/preference exists, use the most recently created non-hidden workspace.
- **All workspaces hidden**: Redirect to Settings/Paramètres with alert message in workspace section. If user is not admin of these workspaces, user must create a new workspace.

### Migration Strategy
- **Single migration file** for entire branch: all schema changes must be planned together and applied in one migration.
- **Reset strategy**: If migration needs restart during branch development, use:
  ```bash
  make clean db-restore dev BACKUP_FILE=app-2026-01-09T20-27-13.dump SKIP_CONFIRM=true
  ```
- **Existing data migration**: Automatically create `admin` membership for existing workspace owners during migration.

### Lock Management
- **Heartbeat timeout**: 30 seconds.
- **Lock cleanup**: PostgreSQL jobs (to be updated at API startup).
- **Unlock request timeout**: 2 seconds (fixed, but centralize as variable or env param).

### Implementation Notes
- **Documents scoping**: document list/upload/download/delete must include `workspace_id` from the selected scope to avoid cross-workspace misses.
- **User invitations for non-existing users**: Deferred beyond Lot 1 (not urgent).
- **Workspace lifecycle**: replace "soft delete / restore" with "hide / unhide" semantics.
  - Hidden workspaces are accessible from parameters for unhide/final suppression/export.
  - Final suppression (hard delete with cascade) is only possible for hidden workspaces.
- **ShareWithAdmin removal**: the `shareWithAdmin` field will be removed (no longer useful with membership-based access).
- **Workspace selector UI**: replace dropdown selector with a table showing:
  - Selected state (checkmark if selected, empty otherwise).
  - Workspace name.
  - User's role in workspace (`viewer`/`editor`/`admin`).
  - Action buttons (icons only, no text/border, same style as existing icons from `@lucide/svelte`):
    - Hide/unhide button (visible for admin role only).
    - Delete button (visible for admin role only, only when workspace is hidden).
  - Row is clickable to select workspace (hover message: "Click to select workspace"; hover disabled on action buttons). 
- Member invitation model:
  - Add by existing user email only, or allow pending invitations for non-existing users? OK add separate featur for non existing users invite (the mail will be an activation link and new user will be ask for his device)
  - Which roles exactly: `viewer`, `editor`, `admin` (as in TODO)? yes
- Object lock scope:
  - What constitutes a "view/object" (organization page, folder page, use case page, matrix view, executive summary section)? yes all that
  - Lock granularity: object-level only, or section-level within an object ("data part of object")? object level scope for now (you can prepare object level for the future)
- SSE integration:
  - Reuse existing SSE channels/events, or introduce a dedicated "collaboration" stream? reuse the ONLY SSE CHANNEL, but you can creat collab event
  - Expected client behavior when receiving updates while locked (auto-refresh vs toast + manual refresh)? display collab users on top right
- Import/export contents:
  - What is included for each extension:
    - `topw` (workspace) = JSON + optional docs (in a zip with topw ext)
    - `topf` (folder) = folder JSON + use cases JSON + docs? yes, in a zip (with topf ext)
    - `topu` / `topo` = single/multi entities? topu=topusecase(s) topo=toporganization(s)
  - Versioning / backward compatibility strategy for exported archives? use db migration version as meta data in zip. when importing, create a tmp schema for import and apply migrations. then moves the object where it shall
- Comments:
  - Which "data parts" can be commented (matrix cell, executive summary section, use case field, etc.)? ALL parts - let begind with Use case parts
  - Closing rule: "closed by the last attributed user" — should the creator be allowed if no assignee? => AS WRITTEN IN TODO THE CREATOR IS THE DEFAULT ASSIGNEE

- Workspace admin role semantics:
  - Workspace membership role `admin` can manage members and perform workspace lifecycle actions (hide / unhide / final suppression / export), even if not the owner.
  - `admin_app` must NOT be treated as a workspace admin:
    - `admin_app` retains platform user-approval capability (account approvals).
    - `admin_app` can list workspaces and user↔workspace memberships if needed.
    - Workspace-level management (members, hide/unhide, delete) requires workspace membership role `admin` for the target workspace.

## Plan / Lots (implementation order)

### Lot 0 — Branch doc + discovery (no behavioral changes)
- [x] Document scope and constraints in `BRANCH.md` (this file)
- [x] Identify existing "workspace" concepts in DB/API/UI (avoid duplicate concepts)
- [x] Map existing SSE plumbing and event patterns to reuse

**Existing baseline (already in repo):**
- DB already has a `workspaces` table and most business tables are `workspace_id` scoped.
- Current model is effectively **1:1 user ↔ owned workspace** because `workspaces.owner_user_id` is **UNIQUE**.
- Non-admin users always operate on their owned workspace (`ensureWorkspaceForUser()`).
- `admin_app` access is based on workspace memberships (same as any user). No `share_with_admin` bypass.
- UI currently exposes:
  - Workspace name + `shareWithAdmin` toggle (owner-only, via `/me` PATCH) — **this will be removed**.
  - Workspace selector stored as `workspaceScopeId` in `localStorage` for all roles (single scope).
- SSE (`/streams/sse`) uses the same workspace scope for all users (no admin-specific scoping).

**Discovery findings (Lot 0):**
- **Schema gaps (to add in single migration):**
  - `workspaces` table exists but lacks `hidden_at` column (needed for hide/unhide; nullable, timestamp when hidden).
  - `workspaces.share_with_admin` field will be removed (no longer useful with membership-based access).
  - `workspaces.owner_user_id` has UNIQUE constraint (must drop to allow multiple workspaces per user).
  - No `workspace_memberships` table exists (to create: `workspace_id`, `user_id`, `role` ('viewer'|'editor'|'admin'), `created_at`).
  - `object_locks` is required for Lot 2 (TTL-based locks + unlock request metadata).
  - A dedicated `unlock_requests` table is optional (phase 1 stores unlock request fields on `object_locks`).
  - No `comments` table exists (to create: `workspace_id`, `context_type`, `context_id`, `section_key?`, `created_by`, `assigned_to?`, `status`, `parent_comment_id?`).
- **Service layer status:**
  - `workspace-service.ts` exists with `ensureWorkspaceForUser()` (creates 1:1 owned workspace).
  - `workspace-access.ts` exists but references `workspaceMemberships` schema that doesn't exist yet (file created ahead of migration).
  - `workspaces.ts` route exists but is empty (placeholder).
- **SSE channel reuse strategy:**
  - `/streams/sse` is the single SSE channel (confirmed: reuse it).
  - Existing events: `job_update`, `organization_update`, `folder_update`, `usecase_update` (all workspace-scoped).
  - Add collaboration event (phase 1): `lock_update` (object lock snapshot).
- **Write endpoint enforcement:**
  - All mutation endpoints (POST/PUT/DELETE) use `user.workspaceId` from auth middleware (not query param).
  - This is correct and should be preserved for workspace-scoped access control.
  - Need to add membership role checks in: `folders.ts`, `organizations.ts`, `use-cases.ts`, `documents.ts`, `chat.ts`, `tool-service.ts`.
  - Viewer role blocks all mutations (403).
  - Editor/admin roles allow mutations.
  - Admin role additionally allows member management + workspace lifecycle (hide/unhide/final suppression/export).
- **No hide/unhide exists:** `workspaces` table has no `hidden_at` column; need to add for hide/unhide flow. Final suppression (hard delete) is only allowed for hidden workspaces.

**Partial UAT (after Lot 0):**
- [x] Document scope and constraints in `BRANCH.md` (this file)
- [x] Identify existing "workspace" concepts in DB/API/UI (avoid duplicate concepts)
- [x] Map existing SSE plumbing and event patterns to reuse

### Lot 1 — Workspace sharing fundamentals (create/hide/delete, roles)
- [x] API: create additional workspace; creator becomes admin
- [x] API: hide a workspace (admin-only; sets `hidden_at` timestamp)
- [x] API: unhide a workspace (admin-only; clears `hidden_at`)
- [x] API: delete a workspace (admin-only; only allowed if workspace is hidden; hard delete with cascade)
- [x] API: remove `shareWithAdmin` field and related logic (schema + code paths)
- [x] DB: add `hidden_at`, drop UNIQUE on `owner_user_id`, create `workspace_memberships` (single migration file) + data migration (owners => admin memberships)
- [x] API: introduce `workspace-access.ts` helpers (roles + default workspace selection)
- [x] API: select current workspace from `workspace_id` query param (localStorage-driven) in auth middleware; block non-settings routes when selected workspace is hidden (409)
- [x] API: `ensureWorkspaceForUser()` now resolves the default workspace from memberships (newest non-hidden), creates workspace + admin membership if none exist
- [x] API: manage workspace members with roles (`viewer`/`editor`/`admin`)
- [x] API: list user's workspaces with membership roles
- [x] UI (Settings/Paramètres): replace workspace selector with table showing (column order):
  - Selected state (checkmark if selected, empty otherwise)
  - Workspace name
  - Role (viewer/editor/admin)
  - Action buttons (hide/unhide, delete if hidden)
  - Row clickable to select workspace (hover: "Click to select workspace")
  - Action buttons: icons only, no text/border (`@lucide/svelte` style)
- [x] UI: remove `shareWithAdmin` toggle
- [x] Enforce role checks in existing mutation endpoints/tools (viewer blocks writes; editor/admin allowed)

**Partial UAT (after Lot 1):**
- [x] **User A creates workspace:**
  - [x] User A goes to Settings/Paramètres
  - [x] User A creates a new workspace "Workspace Alpha"
  - [x] Verify User A is automatically admin of "Workspace Alpha"
  - [x] Verify "Workspace Alpha" appears in User A's workspace list
  - [x] When all workspace of User A are hidden:
    - [x] a message is displayed in workspace to warn the user
    - [x] menus (exec id/param) are grayed, and user can't access to other views (org folder /, usecase ...) than parameters
    - [x] when going to a url, accueil, dossiers, dossiers/[id], org, org/[id], cas-usage/[id] are redirected to parametrs
- [x] **User A adds User B with viewer role:**
  - [x] User A adds User B (by email) to "Workspace Alpha" with role `viewer`
  - [x] User B logs in and switches to "Workspace Alpha"
  - [x] UI: create actions are hidden/disabled (no "plus" buttons) for organizations/folders/use cases
  - [x] UI: User B cannot access creation pages (`/organisations/new`, `/dossier/new`) → redirected with a read-only message
  - [x] UI: inline editors (`EditableInput`) are locked (no typing, no save)
  - [x] UI: delete/trash actions are hidden on lists and detail views (no misleading "success" toast)
  - [x] UI: a lock icon (tooltip) replaces the usual destructive/create actions across the app (organisations, dossiers, cas-usage, matrice, dashboard) for viewer
  - [x] UI: dashboard lock icon is not rendered in print mode (PDF/export)
  - [x] API: if a mutation is still attempted (manual call), it is blocked (403) - UAT result: not directly testable (via forgotten trash button in organisation view)
  - [x] User B can view all objects (read-only works)
- [x] **User A changes User B role to editor:**
  - [x] User A updates User B membership to role `editor` (fix: endpoint supports PUT+PATCH; UI uses PATCH)
  - [x] User B refreshes and tries to edit an organization → succeeds (200)
  - [x] User B tries to delete a folder → succeeds (200)
  - [x] User B tries to manage workspace members → blocked (no access to user list in UI; API 403 covered by api/security tests)
  - [x] User B tries to delete/archive workspace → blocked (no access to delete/archive functions in UI; API 403 covered by api/security tests)
  - [x] User B can update an object (e.g. organization) through chat
- [x] **User A promotes User B to admin:**
  - [x] User A updates User B membership to role `admin`
  - [x] User B refreshes and can now manage members (add/remove/change roles)
  - [x] User B can hide/unhide the workspace (action buttons visible in workspace table)
  - [x] User B can perform final suppression of the workspace (only if hidden, delete button visible)
- [x] **Workspace hide/unhide:**
  - [x] User A (admin) hides "Workspace Alpha"
  - [x] Verify workspace appears as hidden in workspace table
  - [x] Verify unhide button is visible for User A
  - [x] User A unhides "Workspace Alpha"
  - [x] Verify workspace appears as active again
- [x] **Workspace final suppression:**
  - [x] User A hides "Workspace Alpha"
  - [x] User A clicks delete button (only visible when hidden)
  - [x] Verify confirmation dialog appears
  - [x] User A confirms → workspace and all data cascade-deleted
- [x] Limit case
  - [x] When user is removed from its last workspace, user is redirected to parameters view and a warning appear in the workspace card in parameters.
  - [x] Verify no new workspace is auto-created at login in this state.
- [x] **Workspace selector table:**
  - [x] User A opens Settings and sees workspace table
  - [x] Verify table columns order: selected state (checkmark or empty), workspace name, role (viewer/editor/admin), visibility, (trash column without title)
  - [x] Verify admin has the same table layout as viewer/editor (same columns, same row behavior); admin-only actions are disabled for non-admins
  - [x] Verify hover on row shows "Click to select workspace"
  - [x] Verify hover on action buttons does NOT show row message
  - [x] User A clicks a row → workspace selected, checkmark updates
  - [x] User A (admin) renames the selected workspace via `EditableInput` → name updates in table (and persists after refresh)
  - [x] Verify workspace list updates live when another admin renames/hides/unhides a workspace
  - [x] Verify members list updates live when roles are changed or a member is removed
  - [x] Verify action buttons are icons only (no text/border)
  - [x] Verify visibility column shows `eye` when visible and `eye-off` when hidden; hover indicates the action (hide/unhide)
  - [x] Verify trash icon is visible for admins even when workspace is not hidden (disabled + tooltip says hide first)
  - [x] Verify hidden workspaces are not visible to viewer/editor members (only admins see them in the table)
  - [x] Verify: if an admin selects a hidden workspace, all navigation (except /parametres) redirects to /parametres
  - [x] Verify: a persistent banner explains that the workspace must be made visible to access other views
  - **Design note (guard articulation): hidden-workspace redirect vs unsaved-changes**
    - Goal: if `hiddenWorkspaceLock === true`, restrict app navigation to `/parametres` (plus auth routes), and grey-out the other menus.
    - Source of truth: `hiddenWorkspaceLock` derived store (workspace selected + role admin + hiddenAt).
    - Guards involved:
      - `NavigationGuard` (unsaved changes): intercepts clicks / beforeunload to autosave or confirm.
      - `HiddenWorkspaceGuard` (to add in `+layout.svelte`): enforces redirect when hidden workspace is selected.
    - Precedence / behavior:
      - Redirect should win even on direct URL / refresh: when on a forbidden route and `hiddenWorkspaceLock` becomes true, immediately `goto('/parametres')`.
      - Unsaved changes should NOT block the redirect (to avoid being stuck outside `/parametres`):
        - If there are unsaved changes, show a toast/banner: "workspace caché → accès restreint, modifications non sauvegardées ignorées" (best-effort).
        - Optional: call `unsavedChangesStore.reset()` on forced redirect (trade-off: loses drafts; but hidden workspace is already an exceptional state).
      - If user clicks a disabled menu item, prevent navigation (header already greys out; must also handle burger menu).
    - Allowed routes while locked:
      - `/parametres` (and subroutes), `/auth/*`, and public routes (e.g. `/`).
      - Everything else → redirect.
    - Timing:
      - Gate on `workspaceScopeHydrated === true` to avoid redirect flashes before roles/hiddenAt are loaded.
    - Options:
      - Option A (recommended): **redirect immédiat** en `+layout.svelte` + **autosave best-effort non bloquant** (fire-and-forget) si `unsavedChangesStore` contient des changements.
      - Option B: redirect immédiat + **abandon explicite** des changements (`unsavedChangesStore.reset()`) + toast d’explication (plus simple, mais perte de drafts).
- [x] **Workspace isolation:**
  - [x] User A creates "Workspace Beta" (separate from "Workspace Alpha")
  - [x] User A creates an organization in "Workspace Beta"
  - [x] User B (only member of "Workspace Alpha") cannot see "Workspace Beta" organizations
  - [x] User B tries to select "Workspace Beta" in table → access denied (not a member)

### Lot 2 — Object edition locks + unlock workflow (API + SSE + UI)
- [x] Define lock keys (workspaceId + objectType + objectId)
- [x] DB: extend single migration `0018_workspace_collaboration.sql` with `object_locks`
- [x] API: lock endpoints (`/api/v1/locks`) + TTL refresh / conflict (409)
- [x] API: enforce locks on mutations (org/folder/usecase) → `409 OBJECT_LOCKED` with lock payload
- [x] SSE: publish lock snapshots via `/streams/sse` event `lock_update`
- [x] UI: lock indicator + disable editing when locked by another user
- [x] UI: acquire/release lock lifecycle on page entry/exit
- [x] UI: "Request unlock" + "Force unlock" (admin) actions
  - Design note: UI uses a compact lock badge (avatar(s) + lock) with hover tooltip; admin force unlock is a secondary action inside tooltip (no visible button). Request unlock has no message prompt.
  - Design note: presence avatars are backed by `/locks/presence` + SSE `presence_update`; current user is excluded from avatar list but included in the connected count (leave via `/locks/presence/leave`).
- [x] API/UI: finaliser le workflow d’unlock (phase 2)
  - [x] Pas de timeout
  - [x] Pas de refus explicite
  - [x] La demande tombe si le locker quitte la page
  - [x] Accept = transfert atomique du lock au demandeur (signalé via lock_update)
- [x] **Lock lifecycle hardening:**
  - [x] TTL max = 1 minute + refresh UI toutes les 30s
  - [x] Purge des locks au démarrage de l’API
  - [x] Purge des locks si l’utilisateur n’a plus aucun SSE actif
  - [x] Sweep périodique des locks expirés + `lock_update` pour relancer la prise de lock

**Partial UAT (after Lot 2):**
- [x] **Presence (SSE):**
  - [x] User A opens an object view → presence badge shows "1 utilisateur connecté"
  - [x] User B opens the same object view → both users see each other (avatars + count)
  - [x] User A leaves the tab or navigates away → User B sees the avatar disappear
  - [x] Admin (viewer on shared workspace) sees presence and is visible to others
- [x] **Unlock request UX (badge):**
  - [x] User B requests unlock → User A sees a small key on User B avatar
  - [x] User A sees "déverrouiller pour User B" in the hover menu
  - [x] User A releases → lock transfers to User B (User A does not immediately re-lock)
- [x] **User A locks an object:**
  - [x] User A opens a use case detail page (editor/admin role)
  - [x] Verify User A acquires lock automatically
  - [x] Verify UI shows "You are editing" indicator
- [x] **User B sees locked view:**
  - [x] User B (editor/admin) opens the same use case detail page
  - [x] Verify User B sees "Locked by User A" indicator
  - [x] Verify User B's edit controls are disabled
  - [x] Verify User B can still view the object (read-only)
- [x] **User A edits while User B watches:**
  - [x] User A makes an edit (e.g., updates use case name)
  - [x] Verify User B receives SSE update and sees the change in real-time
  - [x] Verify User B's view refreshes automatically
- [x] **User B requests unlock (User A active):**
  - [x] User B clicks "Request unlock" button
  - [x] Verify API refuses if another unlock request is already processing
  - [x] Verify User A receives SSE notification: "User B requests unlock"
  - [x] User A clicks "Accept" → verify lock transfers to User B
  - [x] Verify User A's UI switches to locked view
  - [x] Verify User B's UI switches to editing mode
### Lot 3 — Import/export (workspace, folder, use cases, organizations) — parked (future branch)

### Lot 4 — Comments (table + UI + @mentions + close) — parked (future branch)

### Lot 5 — Tests & Finalization (current branch)
- **Scope**: Lot 3/4 parked; focus on tests + doc finalization for what is already implemented.
- **Docs**:
  - [ ] Update `spec/DATA_MODEL.md` to match `api/src/db/schema.ts`
  - [ ] Generate/update OpenAPI artifacts if needed (`make openapi-*`)
- **API tests (existing categories) — exhaustive list**
  - [x] `api/tests/api` (routes/integration):
    - [x] Role enforcement for orgs/folders/usecases/documents/locks (viewer/editor/admin)
    - [x] Workspace scoping (non-member 404 for all read endpoints)
    - [x] Workspace lifecycle (hide/unhide/delete) admin-only
    - [x] Members CRUD (add/update/remove) admin-only
    - [x] `workspace_id` ignored for bootstrap routes (`/workspaces`, `/me`)
    - [x] Hidden workspace access returns 409 (non-settings routes)
    - [x] SSE events workspace-scoped
    - [x] Documents list/upload/download/delete scoped to workspace_id
    - [x] Locks endpoints return 409 when locked by another user
    - [x] Unlock accept transfers lock (atomic)
    - [x] Presence list respects workspace scope
  - [ ] `api/tests/security`:
    - [x] 403 for viewer mutations
    - [x] 403 for editor member management + workspace lifecycle
    - [x] 404 for non-member workspace access
    - [x] Reject cross-workspace document access by id
    - [x] Concurrent edit lock enforcement (second editor gets 409)
    - [x] Concurrent edit lock enforcement per object type (organization/folder/usecase/matrix)
    - [ ] Lock breaks when locker leaves (no active SSE → lock cleared)
    - [ ] SSE disconnect does not leak locks (cleanup on zero SSE)
  - [ ] `api/tests/unit`:
    - [x] Locks service (acquire/release/request/accept/force, TTL)
    - [x] Presence service (record/leave/list)
    - [x] Workspace scope resolution
    - [ ] Lock cleanup on zero SSE connections
  - [ ] `api/tests/ai`:
    - [x] documents tool enabled only for authorized context
    - [x] documents tool rejects mismatched context
  - [ ] `api/tests/queue`:
    - [x] document summary job updates status correctly (success/failure)
  - [ ] `api/tests/smoke`:
    - [x] DB + API health
  - [ ] `api/tests/limit`:
    - [x] rate limiting does not affect auth when disabled (dev)
- **UI tests (existing categories) — feasible scope**
  - [x] `ui/tests/stores`:
    - [x] workspace scope selection + hydration
    - [x] read-only role derivation
    - [x] streamHub workspace scoping
    - [x] hidden workspace lock activation
    - [x] no-workspace lock activation
  - [ ] `ui/tests/utils`:
    - [x] documents utils use workspace_id for list/download
- **E2E (Playwright) — existing categories + UAT mapping**
  - [ ] `e2e/tests/tenancy-workspaces.spec.ts`:
    - [ ] **User A creates workspace + assigns roles**
      - [ ] User A creates "Workspace Alpha"
      - [ ] User A adds User B as `viewer`
      - [ ] User B switches to "Workspace Alpha"
      - [ ] User A changes User B to `editor`
      - [ ] User A promotes User B to `admin`
    - [ ] **Hidden workspace lock**
      - [ ] User A hides "Workspace Alpha"
      - [ ] User A selects hidden workspace → redirect to /parametres
      - [ ] User B cannot access hidden workspace (not visible)
    - [ ] **No-workspace edge**
      - [ ] User A removes User B from last workspace
      - [ ] User B redirected to /parametres + warning
    - [ ] **User B admin**
      - [ ] User A promotes User B to admin
      - [ ] User B can manage members
      - [ ] User B can hide/unhide workspace
      - [ ] User B can perform final suppression (hidden only)
  - [ ] `e2e/tests/settings.spec.ts`:
    - [ ] **Workspace table UX**
      - [ ] Icons only, hover message on row
      - [ ] Action buttons do not trigger row hover
    - [ ] **User A renames workspace**
      - [ ] Rename via EditableInput → persisted
    - [ ] **Live updates**
      - [ ] User A updates member role → User B sees update
      - [ ] User A hides/unhides workspace → table updates for both
  - [ ] `e2e/tests/access-control.spec.ts`:
    - [ ] **User B viewer**
      - [ ] No create/delete buttons
      - [ ] Cannot access create routes (redirect)
      - [ ] Inline editors locked
    - [ ] **User B editor**
      - [ ] Can edit objects
      - [ ] Cannot manage members
    - [ ] **User B admin**
      - [ ] Can manage members
      - [ ] Can hide/unhide workspace
      - [ ] Can delete hidden workspace
  - [ ] `e2e/tests/organizations-detail.spec.ts` / `usecase-detail.spec.ts`:
    - [ ] **User A locks / User B sees locked view**
      - [ ] User A opens object → acquires lock
      - [ ] User B opens same object → locked view
    - [ ] **Unlock request flow**
      - [ ] User B requests unlock
      - [ ] User A accepts → lock transfers to User B
    - [ ] **Presence**
      - [ ] User A/B avatars appear
      - [ ] Avatar disappears on leave
    - [ ] **Lock breaks on leave**
      - [ ] User A leaves view → lock released
      - [ ] User B can acquire lock
    - [ ] **3 users contention**
      - [ ] User A locks object
      - [ ] User B requests unlock
      - [ ] User C opens same object → sees presence + locked view
      - [ ] Second unlock request rejected (B/C)
      - [ ] User A accepts → lock transfers to requester, others stay locked
  - [ ] `e2e/tests/dossiers-reload-draft.spec.ts`:
    - [ ] **Folder lock/presence**
      - [ ] User A locks folder
      - [ ] User B sees locked view + presence
      - [ ] Unlock request + accept on folder
      - [ ] User A leaves → lock released → User B can lock
  - [ ] `e2e/tests/organizations-detail.spec.ts`:
    - [ ] **Organization lock/presence**
      - [ ] User A locks organization
      - [ ] User B sees locked view
      - [ ] Unlock request + accept on organization
  - [ ] `e2e/tests/usecase-detail.spec.ts`:
    - [ ] **Use case lock/presence**
      - [ ] User A locks use case
      - [ ] User B sees locked view
      - [ ] Unlock request + accept on use case
  - [ ] `e2e/tests/matrix.spec.ts`:
    - [ ] **Matrix lock/presence**
      - [ ] User A locks matrix
      - [ ] User B sees locked view
      - [ ] Unlock request + accept on matrix
      - [ ] User A leaves → lock released → User B can lock
  - [ ] `e2e/tests/dashboard.spec.ts`:
    - [ ] **Dashboard read-only**
      - [ ] Viewer sees lock icon
      - [ ] Print mode hides lock icon
  - [ ] `e2e/tests/organizations.spec.ts` / `e2e/tests/folders.spec.ts` / `e2e/tests/usecase.spec.ts`:
    - [ ] **Read-only UI across views (viewer)**
      - [ ] Organizations list/detail: no create/delete/edit
      - [ ] Folders list/detail: no create/delete/edit
      - [ ] Use cases list/detail: no create/delete/edit
  - [ ] `e2e/tests/documents-ui-actions.spec.ts`:
    - [ ] **Documents scoping**
      - [ ] User A uploads document to org
      - [ ] User B in same workspace sees document
      - [ ] User B in other workspace does not see document
  - [ ] `e2e/tests/workflow.spec.ts`:
    - [ ] Final UAT flow (from `spec/COLLAB.md`)
  - [ ] `e2e/tests/organizations.spec.ts` / `folders.spec.ts`:
    - [ ] **Cross-workspace isolation (A/B)**
      - [ ] User A data not visible to User B
      - [ ] User B data not visible to User A
  - [ ] `e2e/tests/usecase.spec.ts`:
    - [ ] **Role change reactivity**
      - [ ] User A changes User B role
      - [ ] User B view updates without reload
  - [ ] `e2e/tests/streams` (to add if missing):
    - [ ] SSE workspace scoping (no cross-workspace leakage)
- **Gates**:
  - [ ] `make typecheck`
  - [ ] `make lint`
  - [ ] `make test-api`
  - [ ] `make test-ui`
  - [ ] `make test-e2e`
