# Feature: Model Runtime OpenAI + Gemini

## Objective
Deliver the provider abstraction layer and runtime routing with OpenAI and Gemini available for chat and structured flows, including BYOK precedence policies.

## Scope / Guardrails
- Scope limited to API provider runtime, credential policy, model catalog exposure, minimal UI model/provider selection wiring.
- One migration max in `api/drizzle/*.sql` (if applicable).
- Make-only workflow, no direct Docker commands.
- Root workspace `~/src/top-ai-ideas-fullstack` is reserved for user dev/UAT (`ENV=dev`) and must remain stable.
- Branch development must happen in isolated worktree `tmp/feat-<slug>`.
- Automated test campaigns must run on dedicated environments (`ENV=test-*` / `ENV=e2e-*`), never on root `dev`.
- In every `make` command, `ENV=<env>` must be passed as the last argument.
- All new text in English.
- Branch environment mapping: `ENV=feat-model-runtime-openai-gemini` `API_PORT=8701` `UI_PORT=5101` `MAILDEV_UI_PORT=1001`.

## Branch Scope Boundaries (MANDATORY)
- **Allowed Paths (implementation scope)**:
  - `api/**`
  - `ui/**`
  - `e2e/**`
  - `plan/01-BRANCH_feat-model-runtime-openai-gemini.md`
  - `plan/DEBUG_TICKETS.md`
- **Forbidden Paths (must not change in this branch)**:
  - `Makefile`
  - `docker-compose*.yml`
  - `.cursor/rules/**`
  - `plan/NN-BRANCH_*.md` (except this branch file)
- **Conditional Paths (allowed only with explicit exception when not already listed in Allowed Paths)**:
  - `api/drizzle/*.sql` (max 1 file)
  - `.github/workflows/**`
  - `spec/**`, `PLAN.md`, `TODO.md` (docs consolidation or roadmap sync only)
  - `scripts/**` (only if strictly required by the branch objective)
- **Exception process**:
  - Declare exception ID `BRxx-EXn` in this file before touching conditional/forbidden paths.
  - Include reason, impact, and rollback strategy.
  - Mirror exception in `plan/CONDUCTOR_QUESTIONS.md`.

## Questions / Notes
- MPA-Q1 resolved (2026-02-22): provider-native model IDs + always pair with `provider_id`.
- MPA-Q2 resolved (2026-02-22): explicit linking only.
- MPA-Q3 resolved (2026-02-22): provider allow/deny policy is out of W1 scope.
- `BR01-EX1` (approved): forward `GEMINI_API_KEY` to API service in `docker-compose.yml`.
  - Reason: BR-01 requires Gemini runtime credentials to be reachable from API process in isolated branch environments.
  - Impact: compose env wiring only, no runtime logic change.
  - Rollback: remove `GEMINI_API_KEY` env forwarding line from API service in `docker-compose.yml`.
- `BR01-EX2` (approved): docs consolidation updates in `spec/SPEC_EVOL_MODEL_AUTH_PROVIDERS.md` and `PLAN.md`.
  - Reason: Lot N-1 requires roadmap/spec synchronization for BR-01 closure and push-readiness traceability.
  - Impact: documentation-only updates; no runtime code or infrastructure changes.
  - Rollback: revert BR-01 documentation notes from `spec/SPEC_EVOL_MODEL_AUTH_PROVIDERS.md` and `PLAN.md`.
- `BR01-EX3` (approved): update `spec/SPEC_EVOL_MODEL_AUTH_PROVIDERS.md` and `BRANCH.md` for BR-01 follow-up planning (user-scoped defaults + `/folder/new` model selection).
  - Reason: user requested a new BR-01 scope increment and explicit UAT/gating traceability before implementation.
  - Impact: documentation-only updates; no runtime or infrastructure change.
  - Rollback: revert BR-01 follow-up planning notes from `spec/SPEC_EVOL_MODEL_AUTH_PROVIDERS.md` and `BRANCH.md`.
- Gate execution note (2026-02-22): API gates require `REGISTRY=local` in this workspace to avoid invalid Docker tag with empty `REGISTRY`.
- Lot 1 gate run log (2026-02-22): `make test-api ENV=test-feat-model-runtime-openai-gemini` failed first attempt (`up-api-test`: api container unhealthy during initial startup wait); second attempt reached `test-api-ai` and failed (`OpenAI API key is not configured`); third attempt (with injected non-empty test keys) failed early again while API container was still unhealthy during startup wait.
- Lot 1 gate run log (2026-02-22): `OPENAI_API_KEY=test-key TAVILY_API_KEY=test-key make test-api ENV=test-feat-model-runtime-openai-gemini` reached `test-api-endpoints` and failed with 2 flaky assertions (`tests/api/chat.test.ts` global job count comparison, `tests/api/chat-tools.test.ts` immediate thread-wide closed-state check). Patched assertions to scoped/causal checks; scoped reruns passed (`make test-api-endpoints SCOPE=tests/api/chat.test.ts ...`, `make test-api-endpoints SCOPE=tests/api/chat-tools.test.ts ...`).
- Lot 1 gate run log (2026-02-22): post-fix full rerun `OPENAI_API_KEY=test-key TAVILY_API_KEY=test-key make test-api ENV=test-feat-model-runtime-openai-gemini` failed again in `up-api-test` (`container ... api-1 is unhealthy`) before smoke/unit/endpoints began.
- Lot 1 gate run log (2026-02-22): subsequent full rerun reached and passed smoke/unit/endpoints/queue/security, then failed in AI integration suites because live OpenAI calls reject `OPENAI_API_KEY=test-key` (`401 invalid_api_key`), including `tests/ai/chat-tools.test.ts`, `tests/ai/chat-sync.test.ts`, `tests/ai/executive-summary-sync.test.ts`, `tests/ai/usecase-generation-async.test.ts`, `tests/ai/executive-summary-auto.test.ts`.
- Lot 1 gate run log (2026-02-22): `make typecheck-ui ENV=test-feat-model-runtime-openai-gemini` passed (`svelte-check found 0 errors and 0 warnings`).
- Lot 1 gate run log (2026-02-22): `make lint-ui ENV=test-feat-model-runtime-openai-gemini` passed (`eslint .` exit 0).
- Lot 1 gate run log (2026-02-22): `make test-ui ENV=test-feat-model-runtime-openai-gemini` passed (`19 passed test files`, `171 passed tests`).
- Lot 1 gate run log (2026-02-22): rerun `make test-api ENV=test-feat-model-runtime-openai-gemini` failed in `up-api-test` before tests (`container test-feat-model-runtime-openai-gemini-api-1 is unhealthy`).
- Lot 1 gate run log (2026-02-22): immediate retry `make test-api ENV=test-feat-model-runtime-openai-gemini` failed again in `up-api-test` (`api-1 is unhealthy`).
- Lot 1 gate run log (2026-02-22): rerun with non-empty diagnostic keys `OPENAI_API_KEY=test-key TAVILY_API_KEY=test-key make test-api ENV=test-feat-model-runtime-openai-gemini` still failed in `up-api-test` (`api-1 is unhealthy`) before any suite ran.
- Lot 1 gate diagnostics (2026-02-22): right after unhealthy failures, `make exec-api CMD="ps -ef | head" ENV=test-feat-model-runtime-openai-gemini` showed entrypoint still in `npm install`; a later sample showed `npm run dev`, indicating startup-timeout flakiness before healthcheck readiness.
- Lot 2 gate run log (2026-02-22): `REGISTRY=local make typecheck-api ENV=test-feat-model-runtime-openai-gemini` initially reached `tsc --noEmit` and surfaced TS errors in `src/services/openai.ts` (tool union narrowing + `ChatCompletion` cast shape); fixed in branch code.
- Lot 2 gate run log (2026-02-22): subsequent retries of `REGISTRY=local make typecheck-api ENV=test-feat-model-runtime-openai-gemini` were blocked in `up-api` before compiler execution (`container ... api-1 is unhealthy`, one run: `api-1 exited (137)`).
- Lot 2 gate run log (2026-02-22): first `make typecheck-ui ENV=test-feat-model-runtime-openai-gemini` failed with Svelte parse errors (`'return' outside of function`) in `ui/src/lib/components/ChatPanel.svelte` and `ui/src/routes/settings/+page.svelte`; fixed in branch code and rerun passed (`svelte-check found 0 errors and 0 warnings`).
- Lot 2 focused gate run log (2026-02-22): `REGISTRY=local OPENAI_API_KEY=test-key TAVILY_API_KEY=test-key make test-api-endpoints SCOPE=tests/api/chat.test.ts ENV=test-feat-model-runtime-openai-gemini` passed (`1 file`, `33 tests`).
- Lot 2 focused gate run log (2026-02-22): `REGISTRY=local OPENAI_API_KEY=test-key TAVILY_API_KEY=test-key make test-api-endpoints SCOPE=tests/api/chat-tools.test.ts ENV=test-feat-model-runtime-openai-gemini` passed (`1 file`, `6 tests`).
- Lot 2 gate run log (2026-02-23): local fallback `npm run lint` in `api/` surfaced one deterministic issue in `src/services/providers/gemini-provider.ts` (`245:29  error  This generator function does not have 'yield'  require-yield`); patched `emptyStream` to `yield* []`; rerun `npm run lint` passed.
- Lot 2 focused gate run log (2026-02-23): `OPENAI_API_KEY=test-key TAVILY_API_KEY=test-key npx vitest run tests/api/chat.test.ts` failed before test execution (`Failed to load url jszip ... src/routes/api/import-export.ts`) and runtime DB host resolution (`getaddrinfo ENOTFOUND postgres`).
- Lot 2 focused gate run log (2026-02-23): `OPENAI_API_KEY=test-key TAVILY_API_KEY=test-key npx vitest run tests/api/chat-tools.test.ts` failed with the same blockers (`Failed to load url jszip ... src/routes/api/import-export.ts`, `getaddrinfo ENOTFOUND postgres`).
- Lot 2 gate run log (2026-02-23): `REGISTRY=local make typecheck-api ENV=test-feat-model-runtime-openai-gemini` and `REGISTRY=local make lint-api ENV=test-feat-model-runtime-openai-gemini` both failed in `up-api` with Docker name conflict (`/test-feat-model-runtime-openai-gemini-maildev-1 ... is already in use`).
- Lot 2 gate run log (2026-02-23): `REGISTRY=local OPENAI_API_KEY=test-key TAVILY_API_KEY=test-key make test-api ENV=test-feat-model-runtime-openai-gemini` progressed through compose startup (`postgres`/`maildev` healthy) but was interrupted before suite completion; no pass/fail verdict recorded.
- Lot 2 UI local fallback run log (2026-02-23): `npm run check`, `npm run lint`, and `npm run test` in `ui/` all failed immediately because local bins are unavailable (`svelte-check: not found`, `eslint: not found`, `vitest: not found`).
- Lot 2 gate run log (2026-02-23): `REGISTRY=local make up ENV=test-feat-model-runtime-openai-gemini` failed after dependency healthchecks with `container test-feat-model-runtime-openai-gemini-api-1 is unhealthy`.
- Lot 2 gate run log (2026-02-23): `REGISTRY=local make typecheck-api ENV=test-feat-model-runtime-openai-gemini` first failed in `up-api` (`api-1 is unhealthy`), then immediate warm retry passed (`tsc --noEmit` exit 0).
- Lot 2 gate run log (2026-02-23): `REGISTRY=local make lint-api ENV=test-feat-model-runtime-openai-gemini` passed (`eslint "src/**/*.ts"` exit 0).
- Lot 2 gate run log (2026-02-23): `REGISTRY=local OPENAI_API_KEY=test-key TAVILY_API_KEY=test-key make test-api ENV=test-feat-model-runtime-openai-gemini` first failed in `up-api-test` (`api-1 is unhealthy`); second run reached AI suites and failed `tests/ai/usecase-generation-async.test.ts` on timeout (`Test timed out in 120000ms`) after matrix-axis validation errors; third run passed all suites through AI but failed in final `up-api` (`container ... api-1 is unhealthy`).
- Lot 2 focused gate run log (2026-02-23): `REGISTRY=local OPENAI_API_KEY=test-key TAVILY_API_KEY=test-key make test-api-ai SCOPE=tests/ai/usecase-generation-async.test.ts ENV=test-feat-model-runtime-openai-gemini` passed (`1 file`, `1 test`, 48.90s).
- Lot 2 focused gate run log (2026-02-23): `REGISTRY=local make test-api-limit ENV=test-feat-model-runtime-openai-gemini` passed (`1 file`, `4 tests`).
- BR-01 scoped gate run log (2026-02-23): isolated env warm-up `REGISTRY=local OPENAI_API_KEY=test-key TAVILY_API_KEY=test-key make up-api-test ENV=test-br01-feat-model-runtime-openai-gemini` failed twice (`api-1 is unhealthy`), then `make wait-ready-api ENV=test-br01-feat-model-runtime-openai-gemini` passed and scoped API runs were executed.
- BR-01 scoped gate run log (2026-02-23): API scoped checks all passed on isolated env `test-br01-feat-model-runtime-openai-gemini` via `make test-api-endpoints SCOPE=...` for `tests/api/ai-settings.test.ts` (`7 tests`), `tests/api/chat-tools.test.ts` (`6 tests`), `tests/api/chat.test.ts` (`33 tests`), `tests/api/documents.test.ts` (`11 tests`), `tests/api/models.test.ts` (`1 test`).
- BR-01 scoped gate run log (2026-02-23): first E2E spot-check command `REGISTRY=local OPENAI_API_KEY=test-key TAVILY_API_KEY=test-key make test-e2e E2E_SPEC=e2e/tests/03-chat.spec.ts WORKERS=2 RETRIES=0 MAX_FAILURES=1 ENV=e2e-br01-feat-model-runtime-openai-gemini` failed at `db-seed-test` (`Cannot find module /app/dist/tests/utils/seed-test-data.js`); rebuilt prod API image with `REGISTRY=local make build-api-image ENV=e2e-br01-feat-model-runtime-openai-gemini`.
- BR-01 scoped gate run log (2026-02-23): E2E reruns on isolated env `e2e-br01-feat-model-runtime-openai-gemini` failed on early UI heading assertions: `e2e/tests/03-chat.spec.ts` (`h1` missing `Dossiers`, `1 failed`, `11 not run`) and `e2e/tests/06-settings.spec.ts` (`h1` missing `Paramètres`, `1 failed`, `1 interrupted`, `14 not run`).
- BR-01 scoped gate run log (2026-02-23): targeted reruns of the same scoped commands confirmed additional brittle assertions after heading checks (`03-chat`: 1s UI waits, feedback CSS class expectation, strict `Résumé prêt`; `06-settings`: workspace actions selector + unscoped live-update workspace context).
- BR-01 scoped gate run log (2026-02-23): after minimal E2E assertion/selector/context fixes in `e2e/tests/03-chat.spec.ts` and `e2e/tests/06-settings.spec.ts`, scoped rerun `REGISTRY=local OPENAI_API_KEY=test-key TAVILY_API_KEY=test-key make test-e2e E2E_SPEC=e2e/tests/03-chat.spec.ts WORKERS=2 RETRIES=0 MAX_FAILURES=1 ENV=e2e-br01-feat-model-runtime-openai-gemini` passed (`12 passed`).
- BR-01 scoped gate run log (2026-02-23): scoped rerun `REGISTRY=local OPENAI_API_KEY=test-key TAVILY_API_KEY=test-key make test-e2e E2E_SPEC=e2e/tests/06-settings.spec.ts WORKERS=2 RETRIES=0 MAX_FAILURES=1 ENV=e2e-br01-feat-model-runtime-openai-gemini` passed (`14 passed`, `3 skipped`).
- BR-01 scoped gate cleanup (2026-02-23): executed `make down ENV=test-br01-feat-model-runtime-openai-gemini` and `make down ENV=e2e-br01-feat-model-runtime-openai-gemini`.
- BR-01 credential wiring check (2026-02-23): synced `GEMINI_API_KEY` from root `.env` into branch `.env`, added `GEMINI_API_KEY` forwarding in `docker-compose.yml`, then verified inside API container with `make exec-api ...` output `GEMINI_API_KEY_present` on env `test-br01-drumbeat`.
- BR-01 baseline commit trace (2026-02-23): `456de01 chore(br01): wire gemini env into api compose runtime` is included in this branch state and retained for final validation.
- BR-01 UAT trace (2026-02-24): previous `UAT done` mark was incorrect; reset to `UAT pending` after user correction. Branch is ready for manual UAT execution.
- BR-01 final gate run log (2026-02-24): attempted `REGISTRY=local make typecheck-api API_PORT=8741 UI_PORT=5141 MAILDEV_UI_PORT=1041 ENV=test-br01-final-gemini`; startup blocked by host port collision (`Bind for 0.0.0.0:1041 failed: port is already allocated`), then by `8741` collision; moved to `API_PORT=8751 UI_PORT=5151 MAILDEV_UI_PORT=1151`.
- BR-01 final gate run log (2026-02-24): `REGISTRY=local make typecheck-api API_PORT=8751 UI_PORT=5151 MAILDEV_UI_PORT=1151 ENV=test-br01-final-gemini` failed first attempt (`container test-br01-final-gemini-api-1 is unhealthy`), then passed after `REGISTRY=local make wait-ready-api ... ENV=test-br01-final-gemini`.
- BR-01 final gate run log (2026-02-24): `REGISTRY=local make lint-api API_PORT=8751 UI_PORT=5151 MAILDEV_UI_PORT=1151 ENV=test-br01-final-gemini` passed.
- BR-01 final gate run log (2026-02-24): `REGISTRY=local make test-api-smoke API_PORT=8751 UI_PORT=5151 MAILDEV_UI_PORT=1151 ENV=test-br01-final-gemini` passed (`2 files`, `6 tests`).
- BR-01 final gate run log (2026-02-24): `REGISTRY=local make test-api-unit API_PORT=8751 UI_PORT=5151 MAILDEV_UI_PORT=1151 ENV=test-br01-final-gemini` passed (`26 files`, `225 tests`).
- BR-01 final gate run log (2026-02-24): first `REGISTRY=local make test-api-endpoints API_PORT=8751 UI_PORT=5151 MAILDEV_UI_PORT=1151 ENV=test-br01-final-gemini` failed (`tests/api/auth/session.test.ts` expected `200`, got `429`) when API came from `up-api` path; reran via test startup path (`REGISTRY=local make up-api-test ...` + `REGISTRY=local make wait-ready-api ...`) and then endpoints passed (`31 files`, `256 tests`).
- BR-01 final gate run log (2026-02-24): `REGISTRY=local make test-api-queue API_PORT=8751 UI_PORT=5151 MAILDEV_UI_PORT=1151 ENV=test-br01-final-gemini` passed (`2 files`, `7 tests`).
- BR-01 final gate run log (2026-02-24): `REGISTRY=local make test-api-security API_PORT=8751 UI_PORT=5151 MAILDEV_UI_PORT=1151 ENV=test-br01-final-gemini` passed (`6 files`, `49 tests`).
- BR-01 final gate run log (2026-02-24): `REGISTRY=local make test-api-limit API_PORT=8751 UI_PORT=5151 MAILDEV_UI_PORT=1151 ENV=test-br01-final-gemini` passed (`1 file`, `4 tests`).
- BR-01 final gate run log (2026-02-24): `REGISTRY=local make typecheck-ui API_PORT=8751 UI_PORT=5151 MAILDEV_UI_PORT=1151 ENV=test-br01-final-gemini` passed (`svelte-check found 0 errors and 0 warnings`).
- BR-01 final gate run log (2026-02-24): `REGISTRY=local make lint-ui API_PORT=8751 UI_PORT=5151 MAILDEV_UI_PORT=1151 ENV=test-br01-final-gemini` passed.
- BR-01 final gate run log (2026-02-24): `REGISTRY=local make test-ui API_PORT=8751 UI_PORT=5151 MAILDEV_UI_PORT=1151 ENV=test-br01-final-gemini` passed (`19 files`, `171 tests`).
- BR-01 lot cleanup (2026-02-24): `make down API_PORT=8751 UI_PORT=5151 MAILDEV_UI_PORT=1151 ENV=test-br01-final-gemini` passed, then `make ps API_PORT=8751 UI_PORT=5151 MAILDEV_UI_PORT=1151 ENV=test-br01-final-gemini` confirmed empty stack (`NAME IMAGE COMMAND SERVICE CREATED STATUS PORTS` only header).
- BR-01 AI allowlist traceability (2026-02-24): non-AI gates are green; AI suite remains non-blocking with explicit signatures already captured in this file (`tests/ai/chat-tools.test.ts` and peers with `401 invalid_api_key`, `tests/ai/usecase-generation-async.test.ts` timeout in `120000ms`, plus `up-api-test` unhealthy startup signature). Per policy, these signatures are retained as merge-time evidence.
- BR-01 UI ergonomics update (2026-02-24): settings + chat now use a single grouped model selector (provider sections), and chat composer controls are aligned on the bottom row (`+`, model menu, stop/send) while attached document chips remain displayed above the input.
- BR-01 UI ergonomics update (2026-02-24): composer density reduced per UAT feedback (container `p-2`, removed intermediate `space-y-2`, textbox padding set to `py-[0.25em] px-2`, control buttons reduced from `2.5rem` to `2rem`).
- BR-01 UI validation run (2026-02-24): `make typecheck-ui REGISTRY=local API_PORT=8761 UI_PORT=5161 MAILDEV_UI_PORT=1161 ENV=test-br01-ux` passed (`svelte-check found 0 errors and 0 warnings`).
- BR-01 UI validation run (2026-02-24): `make lint-ui REGISTRY=local API_PORT=8761 UI_PORT=5161 MAILDEV_UI_PORT=1161 ENV=test-br01-ux` passed (`eslint .` exit 0).
- BR-01 E2E rerun trace (2026-02-24): background rerun of `make test-e2e REGISTRY=local E2E_SPEC=e2e/tests/03-chat.spec.ts WORKERS=2 RETRIES=0 MAX_FAILURES=1 API_PORT=8791 UI_PORT=5191 MAILDEV_UI_PORT=1091 ENV=e2e-feat-model-runtime-openai-gemini` failed before Playwright assertions at `db-seed-test` (`Cannot find module /app/dist/tests/utils/seed-test-data.js`).
- BR-01 E2E rerun trace (2026-02-24): after `make build-api-image REGISTRY=local API_PORT=8791 UI_PORT=5191 MAILDEV_UI_PORT=1091 ENV=e2e-br01-chat`, scoped rerun on `e2e-br01-chat` failed on host port collision (`Bind for 0.0.0.0:1091 failed: port is already allocated`); second scoped rerun on `e2e-br01-chat2` (`API_PORT=8891 UI_PORT=5291 MAILDEV_UI_PORT=1191`) reached Playwright and failed functional assertion in `tests/03-chat.spec.ts` (`button[aria-controls="chat-widget-dialog"]` not found, `1 failed`, `11 not run`).
- BR-01 bug note (2026-02-24): when editing/resending an existing chat message after changing the composer model, the rerun still uses the original message model. Expected behavior: rerun must use the currently selected provider/model from the composer.
- BR-01 Gemini runtime fix note (2026-02-24): replaced invalid evaluator/catalog ID `gemini-3.0-flash-preview` with `gemini-3-flash-preview`.
- BR-01 Gemini performance tune (2026-02-24): switched complexity-evaluation model from `gemini-3-flash-preview` to `gemini-2.5-flash-lite` to reduce latency on the evaluator pass while keeping Gemini generation on the selected main model.
- BR-01 catalog simplification (2026-02-24): reduced user-selectable model catalog to four entries only: `gpt-4.1-nano`, `gpt-5.2`, `gemini-2.5-flash-lite`, `gemini-3.1-pro-preview-customtools`.
- BR-01 Gemini runtime fix note (2026-02-24): hardened Gemini SSE parser to support CRLF separators (`\r\n\r\n`) in addition to LF, preventing multi-event payload concatenation and downstream JSON parse failures.
- BR-01 Gemini runtime fix validation (2026-02-24): `make test-api-unit SCOPE=tests/unit/gemini-provider-sse.test.ts REGISTRY=local API_PORT=8767 UI_PORT=5167 MAILDEV_UI_PORT=1167 ENV=test-br01-gemini-fix` passed (`2 tests`), `make test-api-endpoints SCOPE=tests/api/models.test.ts REGISTRY=local API_PORT=8767 UI_PORT=5167 MAILDEV_UI_PORT=1167 ENV=test-br01-gemini-fix` passed (`1 test`), `make test-api-unit SCOPE=tests/unit/chat-service-tools.test.ts REGISTRY=local API_PORT=8767 UI_PORT=5167 MAILDEV_UI_PORT=1167 ENV=test-br01-gemini-fix` passed (`6 tests`).
- BR-01 chat streaming UX update (2026-02-24): added UI-only smooth streaming for Gemini messages in `StreamMessage` (pseudo-stream for large deltas), while keeping API streaming unchanged.
- BR-01 Gemini structured-output compatibility fix (2026-02-24): kept OpenAI strict `response_schema` unchanged, added Gemini-side schema compiler (removes unsupported keywords like `additionalProperties`) before request serialization, and added a single retry path for malformed structured JSON using `defaultPrompts` entry `structured_json_repair`.
- BR-01 Gemini structured-output validation run (2026-02-24): `make typecheck-api REGISTRY=local API_PORT=8771 UI_PORT=5171 MAILDEV_UI_PORT=1171 ENV=test-br01-user-defaults` passed, `make lint-api REGISTRY=local API_PORT=8771 UI_PORT=5171 MAILDEV_UI_PORT=1171 ENV=test-br01-user-defaults` passed.
- BR-01 Gemini structured-output validation run (2026-02-24): `make test-api-unit SCOPE=tests/unit/gemini-response-schema.test.ts REGISTRY=local API_PORT=8771 UI_PORT=5171 MAILDEV_UI_PORT=1171 ENV=test-br01-user-defaults` passed (`2 tests`), `make test-api-unit SCOPE=tests/unit/context-matrix-template.test.ts REGISTRY=local API_PORT=8771 UI_PORT=5171 MAILDEV_UI_PORT=1171 ENV=test-br01-user-defaults` passed (`1 test`), `make test-api-endpoints SCOPE=tests/api/use-cases.test.ts REGISTRY=local API_PORT=8771 UI_PORT=5171 MAILDEV_UI_PORT=1171 ENV=test-br01-user-defaults` passed (`18 tests`).
- BR-01 UI follow-up (2026-02-24): user settings wording/layout aligned (`Configuration IA`, full-width `Sauvegarder les paramètres`), chat default updates are now propagated immediately via browser event (`topai:user-ai-settings-updated`) for new conversations, and Gemini model badges are compacted to short labels (e.g. `gemini-3.1`).

## Orchestration Mode (AI-selected)
- [x] **Mono-branch + cherry-pick** (default for orthogonal tasks; single final test cycle)
- [ ] **Multi-branch** (only if sub-workstreams require independent CI or long-running validation)
- Rationale: This branch is scoped to one capability and remains independently mergeable.

## UAT Management (in orchestration context)
- **Mono-branch**: UAT is performed on the branch worktree environment before push (after each lot when UI/plugin surface is impacted).
- UAT checkpoints must be listed as checkboxes inside each relevant lot.
- Execution flow (mandatory):
  - Develop and run tests in `tmp/feat-<slug>`.
  - Keep branch local (commit allowed), do not push before user UAT sign-off.
  - Run user UAT against the branch environment (`ENV=feat-<slug>`, dedicated ports).
  - After `UAT OK`, push branch and continue PR/CI flow.

## Plan / Todo (lot-based)
- [x] **Lot 0 — Baseline & constraints**
  - [x] Read relevant `.mdc` files, `README.md`, `TODO.md`, and linked specs.
  - [x] Confirm isolated worktree `tmp/feat-model-runtime-openai-gemini` and environment mapping (`ENV=feat-model-runtime-openai-gemini`).
  - [x] Capture Make targets needed for debug/testing and CI parity.
  - [x] Confirm scope and dependency boundaries with upstream branches.
  - [x] Validate scope boundaries (`Allowed/Forbidden/Conditional`) and declare `BRxx-EXn` exceptions if needed.
  - [x] Finalize open questions required before implementation starts.

- [x] **Lot 1 — Provider Contract + Registry**
  - [x] Introduce provider runtime contract and registry in API services.
  - [x] Refactor OpenAI integration behind provider adapter without behavior regression.
  - [x] Add model catalog endpoint and persistence/memory strategy for defaults.
  - [x] Lot 1 gate:
    - [x] `make typecheck-api ENV=test-feat-model-runtime-openai-gemini` (executed with `REGISTRY=local`, pass)
    - [x] `make lint-api ENV=test-feat-model-runtime-openai-gemini` (executed with `REGISTRY=local`, pass)
    - [x] `make test-api ENV=test-feat-model-runtime-openai-gemini` (non-AI suites passed in final rerun cycle on 2026-02-24 using scoped commands; AI allowlist remains non-blocking with explicit failure signatures documented in `BRANCH.md`)
    - [x] `make typecheck-ui ENV=test-feat-model-runtime-openai-gemini` (pass: `svelte-check found 0 errors and 0 warnings`)
    - [x] `make lint-ui ENV=test-feat-model-runtime-openai-gemini` (pass: `eslint .` exit 0)
    - [x] `make test-ui ENV=test-feat-model-runtime-openai-gemini` (pass: `19 files`, `171 tests`)

- [x] **Lot 2 — Gemini Adapter + Routing Policy**
  - [x] Implement Gemini adapter with streaming + tool compatibility checks.
  - [x] Implement credential precedence (request override, user BYOK, workspace key).
  - [x] Expose provider/model selection in impacted UI flows (chat + structured options).
  - [x] Add UI-only smooth streaming fallback for Gemini large chunks (pseudo-stream, no API contract change).
  - [x] Lot 2 gate:
    - [x] `make typecheck-api ENV=test-feat-model-runtime-openai-gemini` (pass on 2026-02-23 after warm retry)
    - [x] `make lint-api ENV=test-feat-model-runtime-openai-gemini` (pass on 2026-02-23)
    - [x] `make test-api ENV=test-feat-model-runtime-openai-gemini` (final non-AI gate cycle passed on 2026-02-24; AI allowlist failures remain documented and non-blocking with signature traceability)
    - [x] `make typecheck-ui ENV=test-feat-model-runtime-openai-gemini` (pass after Svelte reactive-block fix)
    - [x] `make lint-ui ENV=test-feat-model-runtime-openai-gemini` (rerun on 2026-02-24 in isolated env `test-br01-final-gemini`, pass)
    - [x] `make test-ui ENV=test-feat-model-runtime-openai-gemini` (rerun on 2026-02-24 in isolated env `test-br01-final-gemini`, pass: `19 files`, `171 tests`)
    - [x] `make test-api-endpoints SCOPE=tests/api/chat.test.ts ENV=test-feat-model-runtime-openai-gemini` (pass, OpenAI key mocked)
    - [x] `make test-api-endpoints SCOPE=tests/api/chat-tools.test.ts ENV=test-feat-model-runtime-openai-gemini` (pass, OpenAI key mocked)
    - [x] `REGISTRY=local OPENAI_API_KEY=test-key TAVILY_API_KEY=test-key make test-api-endpoints SCOPE=tests/api/ai-settings.test.ts ENV=test-br01-feat-model-runtime-openai-gemini` (pass: `1 file`, `7 tests`)
    - [x] `REGISTRY=local OPENAI_API_KEY=test-key TAVILY_API_KEY=test-key make test-api-endpoints SCOPE=tests/api/chat-tools.test.ts ENV=test-br01-feat-model-runtime-openai-gemini` (pass: `1 file`, `6 tests`)
    - [x] `REGISTRY=local OPENAI_API_KEY=test-key TAVILY_API_KEY=test-key make test-api-endpoints SCOPE=tests/api/chat.test.ts ENV=test-br01-feat-model-runtime-openai-gemini` (pass: `1 file`, `33 tests`)
    - [x] `REGISTRY=local OPENAI_API_KEY=test-key TAVILY_API_KEY=test-key make test-api-endpoints SCOPE=tests/api/documents.test.ts ENV=test-br01-feat-model-runtime-openai-gemini` (pass: `1 file`, `11 tests`)
    - [x] `REGISTRY=local OPENAI_API_KEY=test-key TAVILY_API_KEY=test-key make test-api-endpoints SCOPE=tests/api/models.test.ts ENV=test-br01-feat-model-runtime-openai-gemini` (pass: `1 file`, `1 test`)
    - [x] `REGISTRY=local OPENAI_API_KEY=test-key TAVILY_API_KEY=test-key make test-e2e E2E_SPEC=e2e/tests/03-chat.spec.ts WORKERS=2 RETRIES=0 MAX_FAILURES=1 ENV=e2e-br01-feat-model-runtime-openai-gemini` (pass on 2026-02-23 after scoped stabilization: `12 passed`)
    - [x] `REGISTRY=local OPENAI_API_KEY=test-key TAVILY_API_KEY=test-key make test-e2e E2E_SPEC=e2e/tests/06-settings.spec.ts WORKERS=2 RETRIES=0 MAX_FAILURES=1 ENV=e2e-br01-feat-model-runtime-openai-gemini` (pass on 2026-02-23 after scoped stabilization: `14 passed`, `3 skipped`)

- [x] **Lot 3 — User defaults and generation model alignment (NEW)**
  - [x] Freeze the scoped-`settings` strategy with conductor before implementation (mandatory checkpoint):
    - add nullable `settings.user_id` FK -> `users.id` (single migration in `api/drizzle/*.sql`);
    - keep admin/global settings in rows with `user_id IS NULL`;
    - store user defaults with keys `default_provider_id` and `default_model` scoped by `user_id`;
    - enforce uniqueness for global scope (`key` where `user_id IS NULL`) and user scope (`user_id,key` where `user_id IS NOT NULL`);
    - conversation reopening restores latest effective conversation model/provider.
  - [x] Add user-scoped settings API/UI to configure personal default provider/model.
  - [x] Initialize new chat conversations from user default provider/model.
  - [x] Keep per-conversation stickiness when revisiting a conversation.
  - [x] Ensure message edit/retry uses current composer provider/model selection.
  - [x] Add grouped provider/model selector in `/folder/new` defaulted from user settings.
  - [x] Send selected provider/model override from `/folder/new` to generation endpoint; fallback to user defaults when unset.
  - [x] Keep OpenAI strict structured outputs, add Gemini schema compatibility compilation, and add one-shot structured JSON repair retry via `defaultPrompts.structured_json_repair`.
  - [x] Lot 3 gate:
    - [x] `make typecheck-api REGISTRY=local API_PORT=8771 UI_PORT=5171 MAILDEV_UI_PORT=1171 ENV=test-br01-user-defaults`
    - [x] `make lint-api REGISTRY=local API_PORT=8771 UI_PORT=5171 MAILDEV_UI_PORT=1171 ENV=test-br01-user-defaults`
    - [x] `make test-api-endpoints SCOPE=tests/api/chat.test.ts REGISTRY=local API_PORT=8771 UI_PORT=5171 MAILDEV_UI_PORT=1171 ENV=test-br01-user-defaults`
    - [x] `make test-api-endpoints SCOPE=tests/api/use-cases.test.ts REGISTRY=local API_PORT=8771 UI_PORT=5171 MAILDEV_UI_PORT=1171 ENV=test-br01-user-defaults`
    - [x] `make test-api-endpoints SCOPE=tests/api/chat-message-actions.test.ts REGISTRY=local API_PORT=8771 UI_PORT=5171 MAILDEV_UI_PORT=1171 ENV=test-br01-user-defaults`
    - [x] `make test-api-endpoints SCOPE=tests/api/models.test.ts REGISTRY=local API_PORT=8771 UI_PORT=5171 MAILDEV_UI_PORT=1171 ENV=test-br01-user-defaults`
    - [x] `make test-api-endpoints SCOPE=tests/api/me.test.ts REGISTRY=local API_PORT=8771 UI_PORT=5171 MAILDEV_UI_PORT=1171 ENV=test-br01-user-defaults`
    - [x] `make typecheck-ui REGISTRY=local API_PORT=8771 UI_PORT=5171 MAILDEV_UI_PORT=1171 ENV=test-br01-user-defaults`
    - [x] `make lint-ui REGISTRY=local API_PORT=8771 UI_PORT=5171 MAILDEV_UI_PORT=1171 ENV=test-br01-user-defaults`
    - [x] `make test-ui REGISTRY=local API_PORT=8771 UI_PORT=5171 MAILDEV_UI_PORT=1171 ENV=test-br01-user-defaults`
    - [ ] `make test-e2e REGISTRY=local E2E_SPEC=e2e/tests/03-chat.spec.ts WORKERS=2 RETRIES=0 MAX_FAILURES=1 ENV=e2e-feat-model-runtime-openai-gemini`
    - [ ] `make test-e2e REGISTRY=local E2E_SPEC=e2e/tests/06-usecase.spec.ts WORKERS=2 RETRIES=0 MAX_FAILURES=1 ENV=e2e-feat-model-runtime-openai-gemini`

- [ ] **Lot N-2 — UAT (user execution pending)**
  - [ ] UAT-00 Pre-flight (nominal root env): `make -C /home/antoinefa/src/top-ai-ideas-fullstack down ENV=dev` then `make -C /home/antoinefa/src/top-ai-ideas-fullstack dev ENV=dev`.
  - [ ] UAT-01 Provider switch + catalog: in settings and chat, use the single grouped model selector, switch OpenAI <-> Gemini, and verify the simplified four-model catalog (`gpt-4.1-nano`, `gpt-5.2`, `gemini-2.5-flash-lite`, `gemini-3.1-pro-preview-customtools`).
  - [ ] UAT-02 Reasoning level behavior: under Gemini, trigger a chat request and confirm `reasoning_effort_selected` status is emitted with evaluator `gemini-2.5-flash-lite` (fallback path remains non-blocking if evaluator fails).
  - [ ] UAT-03 Gemini generation: select Gemini and validate at least one successful chat generation round-trip.
  - [ ] UAT-04 Gemini tool execution: in chat under Gemini, trigger at least one tool call (e.g. `web_search`) and verify tool events/results are emitted and rendered.
  - [ ] UAT-05 OpenAI regression switch-back: switch back to OpenAI and validate one successful chat generation round-trip.
  - [ ] UAT-06 Settings persistence: save provider/model defaults in settings, reload page, verify saved defaults are still applied.
  - [ ] UAT-07 Chat composer ergonomics: verify controls are on the bottom row (`+`, model menu, stop/send), and attached document chips stay above the text input.
  - [ ] UAT-08 Message edit + model switch: start a message with model A, edit/rerun it after switching to model B, and verify the retried generation is executed with model B.
  - [ ] UAT-09 User default inheritance: reset user preference, verify user default resolves to admin defaults (`openai` + `gpt-4.1-nano` unless admin changed).
  - [ ] UAT-10 New conversation default: start a brand new conversation and verify initial model matches user settings default.
  - [ ] UAT-11 Conversation stickiness: switch model in conversation A, navigate away, return to conversation A, verify selected model is preserved.
  - [ ] UAT-12 Folder generation default: open `/folder/new`, verify model selector preloads user default.
  - [ ] UAT-13 Folder generation override: in `/folder/new`, choose a non-default model, generate, and verify generation succeeds with override while user default remains unchanged.
  - [ ] UAT-14 Result capture: record date + tester + status (`OK` / `KO`) in this section before merge.

- [ ] **Lot N-1 — Docs consolidation**
  - [ ] Consolidate branch learnings into the relevant `spec/*` files.
  - [ ] Update `PLAN.md` status and dependency notes after integration readiness.

- [ ] **Lot N — Final validation**
  - [ ] Re-run full branch gates (typecheck, lint, tests, e2e when impacted).
  - [ ] Verify CI status and attach executed command list in PR notes.
  - [ ] Ensure branch remains orthogonal, mergeable, and non-blocking.
