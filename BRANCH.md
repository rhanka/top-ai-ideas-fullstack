# Feature: Wave 2 - Mono-branch integration on `feat/i18-print` (i18n bilingual + matrix + executive synthesis DOCX)

## Objective
Execute Wave 2 sequentially on a single integration branch (`feat/i18-print`) with partial UAT after coherent lots, while keeping Wave 1 as historical context and deferring full automated tests to Lot N.

## Scope / Guardrails
- Make-only workflow (no direct Docker or npm).
- All new text in English (docs/commits/errors).
- Partial UAT lots are mandatory; full test suites are deferred to Lot N.
- Avoid unrelated refactors; keep changes minimal per lot.

## Orchestration Mode (AI-selected)
- [x] **Mono-branch + sequential lots**
- Rationale: Reduce coordination overhead and run UAT on a single integrated environment.

## References (former Wave 2 branch plans)
- `tmp/feat-i18n-prompts-bilingual/BRANCH.md`
- `tmp/feat-i18n-bilingual-modeling/BRANCH.md`
- `tmp/feat-usecase-matrix-generation/BRANCH.md`
- `tmp/feat-print-exec-synthesis-multipage/BRANCH.md`

## UAT Management
- Before each UAT lot: run the relevant gates (`make typecheck-*`, `make lint-*`).
- Keep UAT checklists inside each lot as `[ ]` items. Do not tick UAT items before the user executes them.
- Wave 2 items are intentionally **all unchecked** (execution restarts from Wave 2 baseline).

## Plan / Todo (lot-based)

- [x] **Lot 0 — Baseline and rules**
  - [x] Read `.cursor/rules/MASTER.mdc` and `.cursor/rules/workflow.mdc`.
  - [x] Read relevant scope rules (`architecture.mdc`, `testing.mdc`, `data.mdc`, `security.mdc`).
  - [x] Confirm current branch is `feat/i18-print` and aligned with `origin/main`.
  - [x] Confirm commit workflow is enforced: selective staging + `make commit MSG="..."` only.

- [x] **Lot 1 — Wave 1 (historical, already completed)**
  - [x] **Environment** (Wave 1 UAT performed in tmp workspaces):
    - `tmp/feat-print-docx-usecase-onepage` → `ENV=feat-print-docx-usecase-onepage`
    - `tmp/feat-i18n-core-and-tech-keys` → `ENV=feat-i18n-core-and-tech-keys`
    - `tmp/feat-usecase-constraints` → `ENV=feat-usecase-constraints`
  - [x] **feat/print-docx-usecase-onepage**
    - [x] Implement DOCX export endpoint/service based on `dolanmiu/docx`.
    - [x] Integrate one-page DOCX template and UI download action from use case detail.
    - [x] Stabilize markdown rendering, loop expansion, style preservation, spacing, links, stars/crosses.
    - [x] UAT: Download DOCX from use case detail (File menu).
    - [!] UAT: Ctrl+P flow (deferred; validate when implemented).
  - [x] **feat/i18n-core-and-tech-keys**
    - [x] Add FR/EN locale keys and wire header/layout labels to i18n.
    - [x] Rename routes and technical keys to English conventions.
    - [x] Update API import/export prefixes and E2E route references.
    - [x] UAT: Header labels show FR/EN and language switch works.
    - [x] UAT: Navigate to renamed routes (usecase, folders, folder, organizations, matrix, settings).
  - [x] **feat/usecase-constraints**
    - [x] Add `constraints` in API validation/types and AI schema/prompt.
    - [x] Add constraints in UI store/detail and print layout (2x2 grid).
    - [x] UAT: Use case detail shows 2x2 grid with Constraints (edit + print preview).
    - [x] UAT: Chat IA update bullet list fields live in UI (benefits, constraints, ...).
  - [x] **Wave 1 integration merge on `feat/i18-print`**
    - [x] Merge `feat/i18n-core-and-tech-keys`.
    - [x] Merge `feat/usecase-constraints`.
    - [x] Merge `feat/print-docx-usecase-onepage`.

- [x] **Lot 1.5 — Integration UAT (post-merge, Wave 1, completed)**
  - [x] Applied integration fixes:
    - [x] Compact reference links in template via `{{$ref.link}}` (title linked to URL).
    - [x] Bottom background image anchoring fixed (page-fixed, full-width, bottom-aligned).
  - [x] UAT on integration environment: `feat/i18-print`.
    - [x] Retest route and navigation consistency:
      - [x] Open `/usecase`, `/folders`, `/folder/new`, `/organizations`, `/matrix`, `/settings`.
    - [x] Retest use case detail UI (constraints + editing):
      - [x] Validate 2x2 grid (Benefits | Constraints / Success Metrics | Risks).
      - [x] Validate live updates from chat for list fields (including constraints).
    - [x] Retest print/docx flow:
      - [x] Download DOCX from Use Case detail File menu.
      - [x] Validate DOCX content rendering: markdown emphasis, lists, links, stars/crosses, matrix tables.
      - [x] Confirm no extra blank line above matrix iteration tables.

- [ ] **Lot 2 — Wave 2 (mono-branch execution on `feat/i18-print`)**

  - [ ] **Lot 2.0 — Wave 2 baseline and gating**
    - [ ] Confirm `feat/i18-print` is aligned with `origin/main`.
    - [ ] Confirm Make-only workflow and commit workflow are enforced.

  - [ ] Cross-cutting UAT complements:
    - [ ] Use case AI generation must populate `Constraints` (non-empty, no marker-only placeholders).

  - [ ] **Lot 2.1 — Bilingual foundation (model + prompts)**
    - [ ] **Bilingual modeling**
      - [ ] Confirm object families in scope (use case, organization, folder, prompts).
      - [ ] Define bilingual field structure and master-language rules.
      - [ ] Implement API validation/types updates for bilingual fields.
      - [ ] Implement UI typing/store updates for bilingual payloads.
      - [ ] Implement payload normalization + backward compatibility for legacy string-only records.
    - [x] **Bilingual exhaustive translations (inventory + implementation)**
      - [x] Inventory (file-by-file):
        - [x] Generate a complete file list for the codebase scopes:
          - [x] UI: `ui/src/**`
          - [x] API: `api/src/**`
          - [x] E2E: `e2e/tests/**` (labels/selectors that assume FR strings)
        - [x] Commands (run from repo root):
          - [x] `rg --files ui/src api/src e2e/tests > /tmp/wave2-i18n-filelist.txt`
        - [x] Optional: focus only on likely user-visible strings:
            - [x] `rg -n \"(\\$_\\(|\\bt\\(|\\$t\\b|i18n|locale|lang)\" ui/src api/src | sort > /tmp/wave2-i18n-hotspots.txt` (includes Svelte `{$_('...')}` usage)
            - [x] `rg -n \"[\\\"']([^\\\"']{3,})[\\\"']\" ui/src | head -n 50 > /tmp/wave2-i18n-strings-sample.txt` (spot-check: hardcoded strings sample)
            - [x] `rg -n \">[^<{\\\\n][^<]{2,}<\" ui/src/routes ui/src/lib/components | head -n 200 > /tmp/wave2-i18n-textnodes-sample.txt` (spot-check: raw text nodes sample)
        - [x] Walk the list and identify every user-visible string that must be translated or moved to i18n keys (fully exhaustive, including shared components):
          - [x] UI routes/views (navigation, page titles, buttons, empty states, dialogs, toasts, form labels, table headers)
          - [x] UI components/shared text
          - [x] API user-facing error messages (only if surfaced directly to users) (inventory scan done; implementation deferred to bilingual prompts/later lots)
          - [x] Emails/templates (if present) (none found in `api/src/**`)
        - [x] Record findings in this section (date + short bullet list of missing keys + the files where they occur).
      - [x] Inventory log (append-only):
        - [x] 2026-02-10: Inventory started. Filelist: `/tmp/wave2-i18n-filelist.txt` (210 files). Findings:
          - [x] Hotspots: `/tmp/wave2-i18n-hotspots.txt` (95 lines, updated regex includes `$_(`).
          - [x] Samples generated:
            - [x] `/tmp/wave2-i18n-strings-sample.txt` (50 lines)
            - [x] `/tmp/wave2-i18n-textnodes-sample.txt` (200 lines)
          - [x] Preliminary findings (cleared by implementation below):
            - [x] Hardcoded FR strings across key views and shared components (dashboard, matrix, folders, organizations, settings, auth, shared UI).
        - [x] 2026-02-10: Implementation progress snapshot (pre-UAT):
          - [x] i18n applied to key routes/components: auth pages, dashboard (ROI config + back cover), matrix dialogs/tooltips, folders list/new/detail, organizations list/detail, settings (admin panel + system info), use case detail/export, and shared components (ChatWidget/ChatPanel, ImportExportDialog, FileMenu, StreamMessage, QueueMonitor, LockPresenceBadge, DocumentsBlock, etc).
          - [x] Locale dictionaries extended (FR/EN) with new namespaces: `adminUsers`, `workspaceSettings`, `unsavedChanges`, plus additions to `common`, `folders`, `organizations`, `usecase`, `dashboard`, `settings`, `matrix`.
      - [x] Implementation:
        - [x] Add missing i18n keys (FR/EN) for all identified strings (up to the next Partial UAT checkpoint).
        - [x] Replace hardcoded strings with i18n lookups consistently (up to the next Partial UAT checkpoint).
        - [x] Ensure technical keys remain stable and English-only (no i18n key renames without migration plan).
      - [x] Gates:
        - [x] `make typecheck-ui` + `make lint-ui`
        - [x] `make typecheck-api` + `make lint-api`
      - [x] Partial UAT (user-driven):
        - [x] Exhaustive UI translation sweep (complete all relevant views; extend this list during the inventory):
          - [x] Home
          - [x] Dashboard
          - [x] Use cases list (`/usecase`)
          - [x] Use case detail (`/usecase/:id`)
          - [x] Folders list (`/folders`)
          - [x] Folder new (`/folder/new`)
          - [x] Folder detail (`/folders/:id`)
          - [x] Organizations list (`/organizations`)
          - [x] Organization new (`/organizations/new`)
          - [x] Organization detail (`/organizations/:id`)
          - [x] Matrix (`/matrix`)
          - [x] Settings (`/settings`)
          - [x] Auth pages (`/auth/login`, `/auth/register`, `/auth/devices`, `/auth/magic-link/verify`)
        - [x] Locale switching sweep:
          - [x] Switch FR→EN without reload and confirm all visible labels update.
          - [x] Switch EN→FR without reload and confirm all visible labels update.
      - [x] Use case AI generation (constraints must not be empty):
        - [x] Generate a new use case via AI and confirm `Constraints` is populated (non-empty, no marker-only placeholders).

  - [ ] **Lot 2.2 — Bilingual prompts (FR/EN variants + selection + fallback)**
    - [ ] Inventory all prompts in scope (admin-managed + hardcoded defaults) and decide which require bilingual variants.
    - [ ] Define prompt bilingual structure and fallback contract (per prompt):
      - [ ] If `en` missing, fallback to `fr`.
      - [ ] If `fr` missing, fallback to `en`.
      - [ ] If both missing, error with a user-actionable message (admin-only).
    - [ ] Update API prompt storage/IO:
      - [ ] Ensure prompts are persisted in DB (`settings` key `prompts`) and returned projected by locale.
      - [ ] Ensure prompt updates are non-destructive across locales (editing EN does not wipe FR).
    - [ ] Update UI prompt editor:
      - [ ] Allow editing FR and EN content explicitly (tabs or side-by-side).
      - [ ] Keep variables extraction working for both locales.
    - [ ] Wire prompt selection for generation flows (use-case list/detail, executive summary, org enrich, etc):
      - [ ] Choose prompt variant based on current UI locale (Accept-Language).
      - [ ] Ensure the generated output language follows the selected prompt.
    - [ ] Gates:
      - [ ] `make typecheck-api` + `make lint-api`
      - [ ] `make typecheck-ui` + `make lint-ui`
    - [ ] Partial UAT (user-driven):
      - [ ] Prompt admin workflow:
        - [ ] In FR, edit a prompt, save, refresh, confirm FR variant persisted.
        - [ ] In EN, edit the same prompt, save, refresh, confirm EN variant persisted (FR still present).
      - [ ] Generation language:
        - [ ] In FR UI, generate use cases and confirm narrative is French.
        - [ ] In EN UI, generate use cases and confirm narrative is English.
      - [ ] Fallback behavior:
        - [ ] Remove one locale variant for a prompt and confirm fallback works without breaking generation.

  - [ ] **Lot 2.3 — Matrix generation per organization/folder**
    - [ ] Implement generation flow for organization-level matrix template.
    - [ ] Implement folder generation option for matrix reuse vs folder-specific generation.
    - [ ] Persist and expose template selection in API/UI.
    - [ ] Gates:
      - [ ] `make typecheck-api` + `make lint-api`
      - [ ] `make typecheck-ui` + `make lint-ui`
    - [ ] Partial UAT (user-driven):
      - [ ] Generate a first folder for an organization and verify matrix template is created/stored at org level.
      - [ ] Generate a second folder with default option and verify stored org matrix is reused.
      - [ ] Generate folder with "specific matrix" option and verify it differs from org default.
      - [ ] Verify matrix selection/options are visible and persisted in folder generation UI.

  - [ ] **Lot 2.4 — Executive synthesis multipage DOCX (template-driven)**
    - [ ] **Lot 2.4.0 — Intake lock and contract freeze**
      - [ ] User input bundle (single intake):
        - [ ] Provide `executive-synthesis.docx` master template.
        - [ ] Provide annex intent (append use cases: yes/no; new page per use case: yes/no).
        - [ ] Provide dashboard intent (include dashboard image: yes/no).
        - [ ] Provide one reference UAT dataset (folder id with executive summary + multiple use cases).
      - [ ] Extract template marker inventory from the provided DOCX (all `{{...}}` placeholders).
      - [ ] Freeze endpoint I/O contract (request/response schema) based on the template markers.
      - [ ] Freeze annex/dashboard composition intents.
    - [ ] **Lot 2.4.1 — Unified endpoint + template registry skeleton**
      - [ ] Introduce unified generation endpoint for DOCX (`templateId`, `entityType`, `entityId`, `options`).
      - [ ] Implement template registry strategy (`templateId -> validator/provider/renderer`).
      - [ ] Keep backward compatibility for existing one-page route if currently used by UI.
      - [ ] Gate: `make typecheck-api` + `make lint-api`
      - [ ] Partial UAT:
        - [ ] Call unified endpoint for one-page use case and verify output parity with current behavior.
        - [ ] Validate error messages for invalid `templateId` / invalid payload.
    - [ ] **Lot 2.4.2 — Master synthesis template composition (no hardcoding)**
      - [ ] Wire `executive-synthesis.docx` master template.
      - [ ] Implement marker-driven chapter rendering (no hardcoded chapter sequencing in service code).
      - [ ] Implement template-controlled annex insertion at the template marker (e.g. `{{ANNEX_USECASES}}`).
      - [ ] Ensure references rendering uses the marker contract.
      - [ ] Gate: `make typecheck-api` + `make lint-api`
      - [ ] Partial UAT:
        - [ ] Download synthesis DOCX and verify section order follows template marker placement.
        - [ ] Verify annex starts exactly at template-defined separator/location.
        - [ ] Verify links/references rendering is preserved.
    - [ ] **Lot 2.4.3 — Dashboard bitmap injection**
      - [ ] Accept dashboard bitmap in endpoint `options` (according to the frozen contract).
      - [ ] Insert image at template marker (e.g. `{{DASHBOARD_IMAGE}}`) with deterministic sizing.
      - [ ] Implement fallback behavior when image is missing/invalid.
      - [ ] Gate: `make typecheck-api` + `make lint-api`
      - [ ] Partial UAT:
        - [ ] Verify dashboard image is present at expected location and remains readable.
        - [ ] Verify fallback rendering when bitmap is omitted.
    - [ ] **Lot 2.4.4 — Integration hardening (API only)**
      - [ ] Finalize provider/normalization for executive summary + annex data.
      - [ ] Ensure use-case one-page DOCX export remains stable and unaffected.
      - [ ] Gate: `make typecheck-api` + `make lint-api`
      - [ ] Partial UAT:
        - [ ] One-page export regression check from use case detail.
        - [ ] Synthesis generation with/without references and with/without dashboard image.

- [ ] **Lot N — Final validation**
  - [ ] Consolidate deferred test backlog from Wave 1 and Wave 2 scopes.
  - [ ] Deferred tests (by scope, by file):
    - [ ] API (Wave 1 carry-over):
      - [ ] `api/tests/api/import-export.test.ts` (i18n/export prefixes)
      - [ ] `api/tests/api/docx.test.ts` (one-page DOCX generation and template contract)
    - [ ] API (Wave 2):
      - [ ] `api/tests/api/ai-settings.test.ts` (bilingual prompt selection + fallback)
      - [ ] `api/tests/api/use-cases.test.ts` (bilingual payload normalization + backward compatibility)
      - [ ] `api/tests/api/organizations.test.ts` (bilingual organization payload consumption, if impacted)
      - [ ] `api/tests/api/folders.test.ts` (matrix selection persistence + executive summary payload)
      - [ ] `api/tests/api/matrix.test.ts` (matrix generation per org/folder, if separate suite exists)
      - [ ] `api/tests/api/docx.test.ts` (extend: executive synthesis generation via unified endpoint)
    - [ ] UI (Wave 1):
      - [ ] None explicitly required by Wave 1 scopes
    - [ ] UI (Wave 2):
      - [ ] `ui/tests/i18n.spec.ts` (bilingual edit + locale switching behavior, if tests exist)
      - [ ] `ui/tests/folders.spec.ts` (folder generation matrix option/selection, if tests exist)
    - [ ] E2E (Wave 1 carry-over):
      - [ ] i18n/route regression pack:
        - [ ] `e2e/tests/00-access-control.spec.ts`
        - [ ] `e2e/tests/00-ai-generation.spec.ts`
        - [ ] `e2e/tests/01-admin-users.spec.ts`
        - [ ] `e2e/tests/01-app.spec.ts`
        - [ ] `e2e/tests/01-organizations-detail.spec.ts`
        - [ ] `e2e/tests/02-organizations.spec.ts`
        - [ ] `e2e/tests/03-chat.spec.ts`
        - [ ] `e2e/tests/03-chat-mobile-docked-nav.spec.ts`
        - [ ] `e2e/tests/04-dossiers-reload-draft.spec.ts`
        - [ ] `e2e/tests/04-documents-summary.spec.ts`
        - [ ] `e2e/tests/04-documents-ui-actions.spec.ts`
        - [ ] `e2e/tests/04-tenancy-workspaces.spec.ts`
        - [ ] `e2e/tests/05-error-handling.spec.ts`
        - [ ] `e2e/tests/05-folders.spec.ts`
        - [ ] `e2e/tests/05-i18n.spec.ts`
        - [ ] `e2e/tests/05-usecase-detail.spec.ts`
        - [ ] `e2e/tests/06-settings.spec.ts`
        - [ ] `e2e/tests/06-streams.spec.ts`
        - [ ] `e2e/tests/06-usecase.spec.ts`
        - [ ] `e2e/tests/07-import-export.spec.ts`
        - [ ] `e2e/tests/07-matrix.spec.ts`
        - [ ] `e2e/tests/07-workflow.spec.ts`
        - [ ] `e2e/tests/07_comment_assistant.spec.ts`
      - [ ] `e2e/tests/05-usecase-detail.spec.ts` (DOCX download assertions)
      - [ ] `e2e/tests/05-usecase-detail.spec.ts` (constraints live update via chat/SSE)
      - [ ] Ctrl+P docx->pdf->print flow (when implemented)
    - [ ] E2E (Wave 2):
      - [ ] `e2e/tests/03-chat.spec.ts` (FR/EN generation parity and fallback)
      - [ ] `e2e/tests/07-matrix.spec.ts` (folder generation matrix reuse vs specific)
      - [ ] `e2e/tests/executive-summary.spec.ts` (if exists: synthesis download contract)
  - [ ] `make test-api`
  - [ ] `make test-ui`
  - [ ] `make build-api build-ui-image`
  - [ ] `make clean test-e2e`
  - [ ] Final gate: CI green for `feat/i18-print` and merge-ready.
