# Feature: Chatbot Lot B2 ‚Äî Chat UX actions and composer

## Objective
Implement Chatbot Lot B2 items from `TODO.md` (lines 66‚Äì88): user feedback (üëç/üëé), message-level actions (edit/retry/copy), assistant response copy, and improved chat input (single-line + menu, multi-line growth, future rich text).

## Existing Analysis
- UI chat entry point is `ui/src/lib/components/ChatPanel.svelte`; user messages are plain bubbles with no actions; assistant messages are rendered by `StreamMessage.svelte`.
- Chat input is a `textarea` with Enter-to-send and Shift+Enter line breaks; no single-line mode or action menu.
- Streaming and assistant content handling are centralized in `StreamMessage.svelte` (reasoning, tools, content).
- API exposes `/api/v1/chat/messages` and session endpoints only; no message edit/retry/feedback endpoints yet.
- DB schema includes `chat_messages` without feedback or edit history fields.

## Scope / Guardrails
- Scope limited to Chatbot Lot B2 items only.
- Keep changes minimal; no unrelated refactors.
- All code/comments/docs in English; user communication in French.
- Single data model evolution only. If an extra DB patch is required, reset data using `make db-restore BACKUP_FILE=prod-2026-01-25T17-18-10.dump`.
- Each committable lot must pass `make typecheck` and `make lint`.
- Final tests (after user UAT): `make test-api`, `make test-ui`, `make clean test-e2e`.

## Plan / Todo (linear, test-driven)
- [x] **Data model (single change)**:
    - [x] Decide storage: new table vs columns in `chat_messages`.
    - [x] Update `api/src/db/schema.ts` + add one migration in `api/drizzle/`.
    - [x] Update `spec/DATA_MODEL.md` immediately after migration.
    - [ ] Validate DB reset strategy ready (only if extra patch required).
- [x] **Lot 1 Feedback**:
    - [x] Add API endpoint to set feedback on assistant message (üëç/üëé, toggle).
    - [x] Ensure feedback is returned by `/chat/sessions/:id/messages`.
    - [x] UI: add feedback buttons under assistant message (hover or always visible).
    - [x] UI: persist feedback state on reload (from API).
    - [x] `make typecheck` + `make lint`
    - [x] UAT lot 1
        - [x] Test: afficher les boutons üëç/üëé sur r√©ponses assistant.
        - [x] Test: soumettre üëç puis recharger ‚Äî √©tat persiste.
        - [x] Test: soumettre üëé puis recharger ‚Äî √©tat persiste.
        - [x] Test: changer üëç‚Üíüëé ‚Äî √©tat mis √† jour.
- [x] **Lot 2 Message actions**:
    - [x] Add API endpoint(s) for edit/retry on user messages with history safety.
    - [x] Ensure retry removes subsequent assistant/user messages and re-queues.
    - [x] UI: add hover action icons under user messages (edit/retry/copy).
    - [x] UI: add hover action icon under assistant messages (copy).
    - [x] `make typecheck` + `make lint`
    - [x] UAT lot 2
        - [x] Test: hover sur message utilisateur ‚Üí ic√¥nes visibles.
        - [x] Test: modifier un message utilisateur (√©dition) ‚Üí message mis √† jour.
        - [x] Test: retry d‚Äôun message utilisateur ‚Üí suite supprim√©e et nouveau stream.
        - [x] Test: copie d‚Äôun message utilisateur ‚Üí clipboard OK.
        - [x] Test: copie d‚Äôune r√©ponse assistant ‚Üí clipboard OK.
- [x] **Lot 3 Composer**:
    - [x] Implement single-line mode UI (centered text vertically).
    - [x] Add left ‚Äú+‚Äù menu placeholder (no actions wired yet).
    - [x] Implement autosize for multi-line (cap at 30% of chat box height).
    - [x] Fix autosize + scrollbar behavior (UAT feedback).
    - [x] `make typecheck` + `make lint`
    - [x] UAT lot 3
        - [x] Test: mode monoligne (entr√©e centr√©e verticalement).
        - [x] Test: bouton + visible (menu placeholder).
        - [x] Test: multi‚Äëligne auto‚Äëresize ‚â§ 30% hauteur box.
- [x] **Lot 4A Rich text input + copy/paste**:
    - [x] Switch composer to `EditableInput` (rich text paste support).
    - [x] Use `EditableInput` for user message edit (Lot 2) to support rich text.
    - [x] Ensure copy action preserves rich text when possible (fallback to plain text).
    - [x] `make typecheck` + `make lint`
    - [x] UAT lot 4A
        - [x] Test: collage rich text dans le composer (styles conserv√©s).
        - [x] Test: √©dition d‚Äôun message utilisateur en rich text.
        - [x] Test: copier/coller d‚Äôun message conserve le rich text (ou fallback propre).
- [ ] **Lot 4B Chat session documents (upload + r√©sum√© + doc tool)**:
    - [x] Decide API strategy: reuse `/documents` with `context_type=chat_session` or add `/chat/sessions/:id/documents`.
    - [x] Enforce session access checks on upload/list/delete (user owns session or workspace access).
    - [x] Add document upload to chat session (paperclip in the ‚Äú+‚Äù menu).
    - [x] Generate automatic summary (short/long) for attached docs (reuse `document_summary` job).
    - [x] Expose session docs to the `documents` tool (allowed contexts include session).
    - [x] Evolution: allow `documents.get_content` for short docs even if summary not ready; keep `get_summary` blocked; keep both blocked for long docs (threshold unchanged).
    - [x] `make typecheck` + `make lint`
    - [!] UAT lot 4B
        - [x] Test: upload document via trombone dans le chat.
        - [x] Test: r√©sum√© auto cr√©√© (court/long selon taille).
        - [x] Test: doc tool utilise les docs attach√©s √† la session.
        - [x] Test: acc√®s interdit si session hors workspace
        - [ ] Test: suppression doc chat_session en viewer (actuellement 403).
- [ ] **Lot 4Bbis Prompt + session UX cleanup**:
    - [x] Centralize chat system prompt in `default_prompts` (single base + context block injection).
    - [x] Add explicit document availability block (session + focus-derived contexts).
    - [x] Add mini prompt for conversation automation.
    - [x] Replace hardcoded session titles tied to context with titles by AI (model: gpt-4.1-nano).
    - [x] Add a dedicated default prompt for AI session titles.
    - [x] `make typecheck` + `make lint`
    - [x] UAT lot 4Bbis
        - [x] Test: session title is generated by AI (no raw context ids).
        - [x] Test: prompt uses session docs + focus context by default.
        - [x] Test: historical context can be referenced when needed.
        - [x] Test: update tool still works (with editor role)
        - [x] Test: update tools is blocked (with viewer role)
- [ ] **Lot 4C Composer menu content (tools/context)**:
    - [x] List tools and contexts in the ‚Äú+‚Äù menu (checkable) (in addition of the trombone for doc upload)
    - [x] Add multi-context mode: context additions when switching views (last added has priority).
    - [x] Allow toggling tools/contexts from the menu.
    - [x] `make typecheck` + `make lint`
    - [x] UAT lot 4C
        - [x] Test: menu ‚Äú+‚Äù affiche tools + contextes.
        - [x] Test: toggle tool/context ON/OFF persiste pour la session.
        - [ ] Test: multi‚Äëcontexte: changement de vue ajoute le contexte, priorit√© au dernier.
- [ ] **Docs (spec updates)**:
    - [ ] Update `spec/DATA_MODEL.md` right after migration.
    - [ ] Update `spec/SPEC_CHATBOT.md` after Lot 2 (Lot B2 coverage).
    - [ ] Update `spec/JSON_STREAMING.md` only if streaming payload/UI changed.
    - [ ] Update `spec/SPEC.md` after Lot 4 if user-visible behavior changed.
    - [ ] Merge `spec/SPEC_CHATBOT_TOOLS_EVOL.md` into `spec/SPEC_CHATBOT.md` and `spec/TOOLS.md`.
- [ ] Add i18n strings and UX copy where needed (FR/EN).
- [ ] Tests to update/add (by type + file):
    - [ ] **API tests**:
        - [ ] Add new tests: `api/tests/chat/feedback.test.ts` (feedback create/update/toggle).
        - [ ] Add new tests: `api/tests/chat/message-actions.test.ts` (edit/retry flows, read-only guard).
        - [ ] Update existing: `api/tests/chat/chat-routes.test.ts` (messages include feedback state).
        - [ ] Add new tests: `api/tests/chat/session-docs.test.ts` (upload + summary + doc tool access + delete as viewer).
        - [ ] Update existing: `api/tests/unit/documents-tool-service.test.ts` (get_content before ready for short docs; get_summary blocked).
    - [ ] **UI tests**:
        - [ ] Add/extend: `ui/tests/chat-panel.spec.ts` (hover icons, copy, edit UI state).
        - [ ] Add/extend: `ui/tests/stream-message.spec.ts` (assistant copy action).
        - [ ] Add/extend: `ui/tests/chat-composer.spec.ts` (single-line + autosize behavior).
        - [ ] Add/extend: `ui/tests/chat-composer-menu.spec.ts` (menu content, toggles, multi-context).
        - [ ] Add/extend: `ui/tests/chat-richtext.spec.ts` (EditableInput, paste, edit flow).
        - [ ] Add/extend: `ui/tests/chat-docs.spec.ts` (upload, summary badge, menu list).
    - [ ] **E2E tests**:
        - [ ] Update: `e2e/tests/03-chat.spec.ts` (feedback, edit, retry, copy).
        - [ ] Update: `e2e/tests/03-chat.spec.ts` (menu tools/context toggles, rich text copy/paste).
        - [ ] Update: `e2e/tests/06-streams.spec.ts` (ensure stream remains stable after retry).
        - [ ] Update: `e2e/tests/03-chat.spec.ts` (document upload + summary + doc tool usage).
- [ ] Run final test suite.
    - [ ] `make test-api` + `make test-ui` + `make clean test-e2e`
- [ ] Verify GitHub Actions CI for the branch.

## Commits & Progress
- [x] **Commit 1** (f470d54): Single migration + data model spec
- [x] **Commit 2** (c02a3b2): Feedback API endpoints
- [x] **Commit 3** (88d2bb7): Feedback UI (UAT-1)
- [x] **Commit 4** (6a28f92): Message actions API (edit/retry)
- [x] **Commit 5** (023875c): UI actions (edit/retry/copy) + assistant copy (UAT-2)
- [x] **Commit 6** (32d9ee4): Composer improvements (UAT-3)
- [ ] **Commit 7**: Test additions + doc updates (specs)

## Status
- **Progress**: Lot 3 implementation done (UAT pending)
- **Current**: UAT lot 3 ready for user testing
- **Next**: Lot 4A/4B planning + implementation, then specs/tests updates
