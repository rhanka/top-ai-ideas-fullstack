# Feature: Collaboration Part 2 — Import/Export + Comments

## Objective
Deliver Collaboration Part 2 from `TODO.md` (import/export + comments) with a single data model evolution, clear UAT lots, and complete test coverage across API/UI/E2E.

## Existing Analysis
- Collaboration Part 1 is already implemented (workspaces, locks, SSE presence).
- `spec/COLLAB.md` already defines comment and import/export behavior and UAT flows.
- Comments are not implemented (no CRUD endpoints, no UI indicator, no data model table).
- Import/Export formats are defined but must move to generic `.zip` with JSON payloads.
- One migration is allowed for the entire branch.

## Scope / Guardrails
- Scope limited to Collaboration Part 2 items only.
- Single data model evolution only; if another patch is needed, reset with `make db-restore BACKUP_FILE=prod-2026-01-25T17-18-10.dump`.
- Docker-only; all commands via `make`.
- All code and Markdown in English; user communication in French.
- Each committable lot must pass `make typecheck` and `make lint`.
- Final tests (after user UAT): `make test-api`, `make test-ui`, `make clean test-e2e`.

## Test Structure (current baseline)
- API unit/integration tests: `api/tests/**` (Vitest).
- UI unit tests: `ui/tests/**` (Vitest).
- E2E tests: `e2e/tests/**` (Playwright).
- UI helper mocks: `ui/tests/mocks/**`.
- E2E helpers: `e2e/helpers/**` and `e2e/tests/helpers/**`.

## Plan / Todo (detailed, lot-based)
- [x] **Lot 0 — Analysis and touchpoints**
    - [x] Review `spec/COLLAB.md` and extract comment + import/export requirements.
    - [x] Review `spec/DATA_MODEL.md` for current schema constraints and tenancy rules.
    - [x] Map API touchpoints:
        - [x] Routes to extend/create (comments, export, import).
        - [x] Services/helpers to reuse (documents storage, workspace scope, auth/roles).
        - [x] SSE events to emit or extend (if comment updates are streamed).
    - [x] Map UI touchpoints:
        - [x] Pages/sections needing comment indicators (use case, folder, organization).
        - [x] Comment panel and composer integration points.
        - [x] Import/Export entry points in UI (menus, settings, or object actions).
    - [x] Confirm data ownership rules:
        - [x] Workspace scoping for comments and archives.
        - [x] Role enforcement (viewer/editor/admin) for mutations.
    - [x] Identify existing export tooling:
        - [x] Any existing ZIP helpers or document export logic.
        - [x] Any existing metadata/versioning for migrations in archives.
    - [x] Output of Lot 0 (documented in BRANCH.md as notes or checklist):
        - [x] List of endpoints to add/update.
        - [x] List of UI components/pages to update.
        - [x] Decision on SSE usage for comments.
        - [x] Create new spec `spec/SPEC_COLLAB_IMPORT_EXPORT_COMMENTS.md` (initial draft).
        - [x] Notes captured:
            - [x] API endpoints (to add/update):
                - [x] New `api/src/routes/api/comments.ts` + register in `api/src/routes/api/index.ts`.
                - [x] Workspace member list for @mentions: new read-only endpoint (e.g. `GET /workspaces/:id/members/mentions`).
                - [x] Import/Export endpoints (generic):
                    - [x] `POST /exports` with `{ scope, scope_id?, include_comments, include_documents }`.
                    - [x] `POST /imports` with `{ target_workspace_id?, mode }` + ZIP upload.
                    - [x] Extend scope to include `matrix`.
            - [x] API helpers/services to reuse:
                - [x] `workspace-access.ts` + `workspace-rbac.ts` for role enforcement.
                - [x] `storage-s3.ts` for document blobs (export/import archives).
                - [x] `documents.ts` upload pattern (multipart form data).
                - [x] `stream-service.ts` / `streams.ts` for SSE event shape.
            - [x] UI touchpoints:
                - [x] Use case detail: `ui/src/routes/cas-usage/[id]/+page.svelte` + `UseCaseDetail.svelte`.
                - [x] Folder detail: `ui/src/routes/dossiers/[id]/+page.svelte`.
                - [x] Organization detail: `ui/src/routes/organisations/[id]/+page.svelte` + `OrganizationForm.svelte`.
                - [x] Workspace settings entry point for import/export: `WorkspaceSettingsPanel.svelte` (Settings page).
            - [x] SSE decision:
                - [x] Add `comment_update` SSE events scoped by context (object type + id) for live badge updates.
            - [x] Export tooling status:
                - [x] No existing ZIP helper; use a new archive helper with storage-s3 for document blobs.
                - [x] Add `manifest.json` with schema/migration version + file hashes (integrity).
                - [x] Export as generic `.zip` with JSON files inside (no custom extension).
                - [x] Import behavior: if `target_workspace_id` missing, API creates a new workspace and maps ids.
                - [x] If `target_workspace_id` exists, merge into it; if unknown or not admin-owned, refuse.

- [x] **Lot 1 — Data model (single change)**
    - [x] Finalize the `comments` table fields and indexes (one-level replies, workspace scope).
    - [x] Update `api/src/db/schema.ts`.
    - [x] Add exactly one migration in `api/drizzle/`.
    - [x] Update `spec/DATA_MODEL.md` right after migration.
    - [x] Confirm no further schema changes will be needed.
    - [x] `make typecheck` + `make lint`
    - [x] UAT lot 1 (user-run)
        - [x] Verify no user-facing changes yet (schema only).

- [x] **Lot 2 — Comments API**
    - [x] Add comment CRUD endpoints (create, list, reply, update, close).
    - [x] Enforce workspace scoping and role rules (viewer read-only).
    - [x] Implement @mention assignment (autocomplete source via workspace members).
    - [x] Implement close rules (only last assigned user can close).
    - [x] Return comment counts for sections if needed by UI.
    - [x] `make typecheck` + `make lint`

- [x] **Lot 3 — Comments UI**
    - [x] Add comment indicators on section headers/cards.
    - [x] Add comment panel listing + one-level replies.
    - [x] Add @mention autocomplete in composer.
    - [x] Add close/reopen flow (respect role + last assignee).
    - [x] `make typecheck` + `make lint`

- [x] **Lot 3bis — Chat UI tabs + comments**
    - [x] Replace header select with tabs: Commentaires / Chat IA / Jobs IA.
    - [x] Move session selector into a chat-only menu icon.
    - [x] Reorder header actions (resize just left of close).
    - [x] Make `ChatPanel` configurable (`ai` vs `comments`).
    - [x] Comments tab uses chat-style conversation UI (avatars, copy, edit last).
    - [x] List comment conversations in menu with comment count.
    - [x] `make typecheck` + `make lint`
    - [ ] UAT lot 3 + 3bis (user-run)
        - [x] Switch tabs without chat reload.
        - [x] Open comment menu and switch conversations.
        - [x] Verify comments tab shows section label (Description / Général).
        - [x] Type `@` and ensure autocomplete is restricted to workspace members.
        - [x] Assign a comment to another user and verify assignee changes.
        - [x] Add multiple comments across sections.
        - [x] Verify header badges display counts and update live.
        - [x] Click on header badge open last comment corresponding to the section
        - [x] New comment thread auto-selects after creation.
        - [x] No tab "blink" when sending a new comment.
        - [x] Automatic scroll to last message
        - [x] Comment composer UI matches Chat IA (no extra wrapper).
        - [x] Comments tab shows + and trash actions (same order as Chat IA).
        - [x] Only comments for the current view/section are shown.
        - [x] User can modify its last message (if no one commented after)
        - [x] Empty state copy: "Sélectionne une conversation pour commencer ou écris
         un commentaire".
        - [x] Subheader ("Description - Assigné à ") must always be visible when scrolling in conversation
        - [x] Viewer can't comment / input is grayed
        - [x] Admin, Editor, Commenter roles can comment
        - [x] Date of comment are displayed
        - [x] Resolve comment with a check button in the top header of chatwidget
        - [x] Close comment once resolved and skip to next comment
        - [x] Remove comment from menu once resolved (when menu is in resolved message masking mode)
        - [x] Display resolved comments through menu (still strikethrough)
        - [x] Enable to repoen resolved comment
        - [x] Resolved comments are not counted in the badge
        - [x] Background of conversation of a resolved message is grayed
        - [x] When displaying a closed message we see the date of the resolution
        - [x] Only the initial creator of the conversation or an admin of the object can resolve a message
        - [x] Only the initial creator of the conversation or an admin of the object can delete a message


- [ ] **Lot 4 — Import/Export API**
    - [x] Add dependency for ZIP + SHA-256 helpers (API container only).
    - [x] Create `api/src/routes/api/import-export.ts` with:
        - [x] `POST /exports` (JSON body, scope-based).
        - [x] `POST /imports` (multipart ZIP upload).
    - [x] Register routes in `api/src/routes/api/index.ts`.
    - [x] Export implementation:
        - [x] Collect data by scope (workspace/folder/usecase/organization/matrix).
        - [x] Optional comments/documents inclusion.
        - [x] Build `manifest.json` + `meta.json`.
        - [x] Zip JSON files + document blobs following S3 layout.
        - [x] Stream ZIP response with correct headers.
    - [x] Import implementation:
        - [x] Validate ZIP structure + `manifest.json` + hashes.
        - [x] Enforce workspace rules (new workspace vs existing target).
        - [x] Remap all IDs; never trust UI-provided IDs.
        - [x] Insert records in dependency order (workspace → orgs/folders/usecases → comments → documents).
        - [x] Store documents in S3 using new workspace/context IDs.
    - [x] Permissions enforcement:
        - [x] Export workspace: admin only.
        - [x] Export objects: admin/editor only.
        - [x] Import into new workspace: authenticated user.
        - [x] Import into existing workspace: admin only.
        - [x] Import objects into existing workspace: admin/editor only.
    - [x] `make typecheck` + `make lint`

- [x] **Lot 5 — Import/Export UI**
    - [x] **UI components (menu standards)**
        - [x] Create a shared menu wrapper component (popover container + placement + outside click).
        - [x] Create a shared menu trigger button using `circle-chevron-down` icon.
        - [x] Create a standard “File menu” component (uses wrapper + trigger).
        - [x] File menu item order = Office “File” menu order: New → Import → Export → Print → Delete.
        - [x] Ensure lock actions remain outside File menu.
        - [x] Reuse existing icon set/button styles (no new styling, no custom icons).
    - [x] **Refactor existing menus to wrapper**
        - [x] Chat “+” menu uses wrapper (popup upwards).
        - [x] Comment conversation menu uses wrapper (popup downwards).
    - [x] **Object-level actions**
        - [x] Integrate File menu into object headers (Organization, Folder, Use Case, Organization list).
        - [x] Map “New” to existing creation flows (Folder/Use Case/Organization where relevant).
        - [x] “Print” uses existing print flows (if available) or disabled with tooltip.
    - [x] **Workspace settings actions**
        - [x] Add File menu in the Workspace section of Settings.
        - [x] Items: New workspace, Import workspace, Export workspace.
        - [x] Import includes choice: new workspace vs current workspace.
    - [x] **Export UI**
        - [x] Modal/drawer matching existing patterns (icons, button styles, spacing).
        - [x] Scope selector (workspace / folder / use case / organization / matrix).
        - [x] Optional scope id selector where applicable.
        - [x] Toggles: include comments, include documents.
        - [x] Primary action triggers `POST /api/v1/exports` and downloads ZIP.
        - [x] Error handling uses existing toast pattern.
    - [x] **Import UI (reworked)**
        - [x] Modal/drawer matching existing patterns (icons, button styles, spacing).
        - [x] File picker for ZIP.
        - [x] Preview ZIP contents with object list (name/title, not id).
        - [x] Allow selecting object types to import (checkboxes).
        - [x] Allow selecting target workspace + target object (default to current view).
        - [x] For `/dossiers/[id]`, import use cases into current folder (ignore folder metadata).
        - [x] Comments/documents options applied to selected objects.
        - [x] Primary action uploads to `POST /api/v1/imports`.
        - [x] Success state shows created/target workspace id.
        - [x] Error handling uses existing toast pattern.
    - [x] `make typecheck` + `make lint`
    - [x] UAT lot 5 (user-run)
        - [x] Menus Chat history is ok (click on old conversation etc)
        - [x] Menus Chat tools is ok (activate context & tools ok)
        - [x] Menu/Comments: when clicking hide/view resolved commenct, the menu shall not close
        - [x] Export workspace
        - [x] Export organisation
        - [x] Export dossier
        - [x] Export cas d'usage
        - [x] Export matrice
        - [x] Import workspace
        - [x] Import dossier dans dossiers (courant)
        - [x] Import dossier dans dossiers (nouveau workspace + )
        - [x] Import cas d'usage dans dossier (courant)
        - [x] Import cas d'usage dans dossier (nouveau dossier)
        - [x] Import cas d'usage dans dossier (dossier d'import)
        - [x] Import d'objet sans documents
        - [x] Import d'objet sans commentaire
        - [x] Un éditeur ne peut pas exporter le workspace
        - [x] Viewer/commenter cannot export.
        - [x] Viewer/commenter cannot import.

- [ ] **Lot 5bis - comment tool**
    - [x] Add `context-comments.ts` to mirror context wiring patterns.
    - [x] Define tool contract (batch-capable, action mode with confirmation).
    - [x] Scope rules (mimic existing tool expansion):
        - [x] usecase strict; folder = current + children; org = current + children.
    - [x] Role rules:
        - [x] Resolve allowed for thread creator (commenter/editor) and admin.
    - [x] Add tool definitions in `api/src/services/tools.ts` (comments analyze + resolve).
    - [x] Add ToolService methods (list threads, resolve, add AI trace note).
    - [x] Wire tool execution in `api/src/services/chat-service.ts` with scope checks.
    - [x] Add `context-comments.ts` prompts and hook into context builder.
    - [x] UI: add Chat tool option + response formatting + validation loop.
    - [x] Implement tool execution + confirmation flow (plan → user confirm → apply).
    - [x] Add trace note when AI is used (visible to collaborators).
    - [x] Add `comments.tool_call_id` (reuse migration 0020) and expose in API/UI.
    - [x] Show AI badge for comments with `tool_call_id` and assistant chat messages.
    - [x] Fix AI trace note visibility in UI (ensure note is rendered in thread).
    - [x] UI: Chat markdown response with explicit confirmation options (Yes/No or fixed list).
    - [x] `make typecheck` + `make lint`
    - [x] UAT lot 5bis (user-run)
        - [x] Enable/Disable “Commentaires (résolution)” in Chat tools menu.
        - [x] Ask for a proposal (mode=suggest) in a context (usecase)
        - [x] Verify proposal is a structured markdown list + explicit “Confirmer/Annuler”.
        - [x] Reply with a non-confirmation (e.g., “peut-être”) and ensure the assistant re-prompts.
        - [x] Reply “Confirmer” and verify actions are applied (close/reassign/note).
        - [x] Verify AI badge on comment messages created by the tool.
        - [x] Verify AI badge on closure messages.
        - [x] Ensure viewers cannot resolve (tool refuses or no changes applied).
        - [x] Ensure thread creator (commenter/editor) can resolve.
        - [x] Ensure admin can resolve any thread.

- [ ] **Lot 5ter - fixes from UATs**
    - [x] Déplacer l'icone File/menu en haut à droite du cadre du workspace dans paramètre
    - [x] Dans workspace, le menu "+" nouveau devrait pointer vers un modal et l'input "Créer" y être déplacé
    - [x] Retirer le "Insufficient permissions" présent en tant que viewer sur certaines vues (ça n'a pas d'utilité)
    - [x] In comment input, when using @ to attribue a comment, after clicking, the input on Editableinput is lost (the focus should be put again there)
    - [x] In dossiers/[id] view, when title is multiline, the button "organization" should be vertically aligned with the "Files/menu" button and the center of the title
    - [x] Fix bounding box (should be squared like other icons) of comment header badge
    - [x] Fix blink in parameters view when adding user in workspace or change role of user
    - [x] When ChatWidget is in docker mode, the scroll bar of the main view should be on the left of the ChatWidget, not on the right. Moreover, the scroll bar should have the same style (slim) than all bars

- [ ] **Lot 6 — Docs (spec updates)**
    - [x] Complete `spec/SPEC_COLLAB_IMPORT_EXPORT_COMMENTS.md`.
    - [x] Merge/align into `spec/SPEC.md`and `spec/COLLAB.md` and `spec/TOOLS.md`
    (global source of truth)
    - [x] Update `spec/DATA_MODEL.md` after schema is finalized.
    - [x] Update `spec/TOOLS.md` with final comment_assistant tools behaviors and UAT notes.
    - [x] Update `spec/COLLAB.md` with final API/UI behaviors and UAT notes.
    - [x] Update `spec/SPEC.md` if new endpoints/screens are introduced.
    - [x] Verify doc consistency with `TODO.md` scope.

- [ ] **Lot 7 — Tests + Final validation**
    - [ ] API tests:
        - [x] `api/tests/api/import-export.test.ts`: add `include[]` (organization/folder options + list exports).
        - [x] `api/tests/api/import-export.test.ts`: add `imports/preview`, `selected_types`, and `target_folder_create/target_folder_source_id`.
        - [x] New `tests/api/import-export.test.ts`: export/import scopes, manifest integrity, id remap.
        - [x] Update `tests/security/collaboration-security.test.ts`: role/tenancy for import/export.
        - [x] Update `tests/api/workspaces.test.ts`: workspace import/export permission gates.
        - [x] Regression: `tests/api/organizations.test.ts`, `tests/api/folders.test.ts`, `tests/api/use-cases.test.ts` (export/import visibility).
        - [x] `api/tests/api/comments.test.ts`: cover `tool_call_id` round-trip (list/create) and thread status rules.
        - [x] `api/tests/api/comments.test.ts`: add local helpers (create org/folder/usecase/comment) to mirror existing API test style.
        - [x] `api/tests/api/chat-tools.test.ts` (new): `comment_assistant` suggest/resolve flow + confirmation gate.
        - [x] `api/tests/api/chat-tools.test.ts` (new): permission matrix (viewer blocked; creator/editor allowed; admin allowed).
        - [x] `api/tests/api/chat-tools.test.ts` (new): context scoping (usecase strict; folder/org expand).
        - [x] `api/tests/api/import-export.test.ts`: export/import includes `tool_call_id` in comments.
        - [x] `make test-api` full api test validation gate
    - [ ] UI tests:
        - [ ] (manual UAT) workspace create modal via “+” menu (no automated test update).
        - [ ] `ui/tests/components/ImportExportDialog.test.ts` (new): import preview + type selection + target workspace/folder order.
        - [ ] `ui/tests/routes/organisations.test.ts` (new or existing): export-all organizations dialog + include folders option.
        - [ ] `ui/tests/routes/dossiers.test.ts` (new or existing): export-all folders dialog + include organizations option.
        - [ ] Update `tests/stores/useCases.test.ts`: comment count indicators and store updates.
        - [ ] Update `tests/stores/folders.test.ts`: comment badge propagation (if needed).
        - [ ] Update `tests/utils/api.test.ts`: client helpers for comments/export endpoints.
        - [ ] Update `tests/stores/workspaceScope.test.ts`: @mention autocomplete scoped by workspace members.
    - [ ] E2E tests:
        - [ ] `e2e/tests/05-folders.spec.ts`: export-all folders from list + include organizations toggle.
        - [ ] `e2e/tests/06-organizations.spec.ts`: export-all organizations from list + include folders toggle.
        - [ ] `e2e/tests/07-matrix.spec.ts` (new): matrix export menu + download.
        - [ ] `e2e/tests/09-import-export.spec.ts` (new): import preview, type selection, create folder, switch workspace.
        - [ ] Update `05-usecase-detail.spec.ts`: comment create/reply/close + header badge.
        - [ ] Update E2E seed (`api/tests/utils/seed-test-data.ts`) to include comment threads + `tool_call_id`.
        - [ ] Update `04-tenancy-workspaces.spec.ts`: @mention autocomplete scope + isolation.
        - [ ] Update `08-workflow.spec.ts` (or new `09-import-export.spec.ts`): export/import round-trip (generic ZIP + target workspace).
        - [ ] Update `00-access-control.spec.ts`: viewer/editor/admin comment permissions.
    - [ ] Import/Export UI tests (from Lot 5)
        - [ ] UI unit (Vitest)
            - [ ] `ui/tests/utils/api.test.ts`: new export/import helpers (blob + form data).
            - [ ] `ui/tests/stores/workspaceScope.test.ts`: workspace list used by import target selector.
            - [ ] `ui/tests/stores/useCases.test.ts`: menu-triggered export state (if store helper added).
            - [ ] `ui/tests/stores/folders.test.ts`: menu-triggered export state (if store helper added).
            - [ ] `ui/tests/stores/organizations.test.ts`: menu-triggered export state (if store helper added).
        - [ ] E2E (Playwright)
            - [ ] `e2e/tests/06-settings.spec.ts`: workspace import/export menu + dialog flow.
            - [ ] `e2e/tests/05-usecase-detail.spec.ts`: use case export menu + download.
            - [ ] `e2e/tests/05-folders.spec.ts`: folder export menu + download.
            - [ ] `e2e/tests/06-organizations.spec.ts`: organization export menu + download.
    - [ ] Run gates: `make typecheck` + `make lint`.
    - [ ] Final tests: `make test-api`, `make test-ui`, `make clean test-e2e`.

## Data Model (single evolution)
- Add `comments` table (workspace-scoped, one-level replies).
- Keep all schema changes within **one migration** only.
- Update `spec/DATA_MODEL.md` immediately after migration.

## Specs to Complete (spec/*)
- `spec/COLLAB.md`: update with final API/UI behaviors + UAT validation notes.
- `spec/DATA_MODEL.md`: align with final schema.
- `spec/SPEC.md`: update if new screens/endpoints need documentation.
- `spec/SPEC_COLLAB_IMPORT_EXPORT_COMMENTS.md`: align UI flows + permissions + payloads.
- `spec/TOOLS.md` and `spec/JSON_STREAMING.md`: only if import/export tooling affects logging/streaming.

## Documentation Timing
- After data model + API stabilized: update `spec/DATA_MODEL.md`.
- After UI behavior finalized: update `spec/COLLAB.md`.
- Before final tests: ensure `spec/SPEC.md` references new endpoints.

