services:
  api:
    image: ${REGISTRY}/${API_IMAGE_NAME:-top-ai-ideas-api}:${API_VERSION:-latest}
    build:
      context: ./api
      dockerfile: Dockerfile
      target: ${TARGET:-development}
    environment:
      - NODE_ENV=${TARGET:-development}
      - DATABASE_URL=${DATABASE_URL:-postgres://app:app@postgres:5432/app}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://localhost:${UI_PORT:-5173},http://127.0.0.1:${UI_PORT:-5173},http://ui:5173,https://*.sent-tech.ca,chrome-extension://*}
      - ADMIN_EMAIL=${ADMIN_EMAIL:-admin@example.com}
      - DISABLE_RATE_LIMIT=${DISABLE_RATE_LIMIT}
      - DISABLE_AUTH=${DISABLE_AUTH:-0}
      - MAIL_HOST=${MAIL_HOST:-maildev}
      - MAIL_PORT=${MAIL_PORT:-1025}
      - MAIL_SECURE=${MAIL_SECURE:-false}
      - MAIL_USERNAME=${MAIL_USERNAME}
      - MAIL_PASSWORD=${MAIL_PASSWORD}
      - MAIL_FROM=${MAIL_FROM:-no-reply@top-ai-ideas.local}
      # Chat tracing (dev: enabled by default, can be overridden)
      - CHAT_TRACE_ENABLED=${CHAT_TRACE_ENABLED:-true}
      - CHAT_TRACE_RETENTION_DAYS=${CHAT_TRACE_RETENTION_DAYS:-7}
    ports:
      - "${API_PORT:-8787}:8787"
    depends_on:
      postgres:
        condition: service_healthy
      maildev:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8787/api/v1/health >/dev/null 2>&1 || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 10
    tty: true

  ui:
    image: ${REGISTRY}/${UI_IMAGE_NAME:-top-ai-ideas-ui}:${UI_VERSION:-latest}
    build:
      context: ./ui
      dockerfile: Dockerfile
      target: ${TARGET:-development}
    environment:
      - NODE_ENV=development
      - VITE_API_BASE_URL=${VITE_API_BASE_URL:-http://localhost:${API_PORT:-8787}/api/v1}
      - VITE_EXTENSION_PROFILE=${VITE_EXTENSION_PROFILE:-uat}
      - VITE_EXTENSION_API_BASE_URL=${VITE_EXTENSION_API_BASE_URL:-http://localhost:${API_PORT:-8787}/api/v1}
      - VITE_EXTENSION_APP_BASE_URL=${VITE_EXTENSION_APP_BASE_URL:-http://localhost:${UI_PORT:-5173}}
      - VITE_EXTENSION_WS_BASE_URL=${VITE_EXTENSION_WS_BASE_URL:-}
    ports:
      - "${UI_PORT:-5173}:5173"
    tty: true

  # sqlite/litestream removed after migration to Postgres

  postgres:
    image: postgres:17-alpine
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-app}
      - POSTGRES_USER=${POSTGRES_USER:-app}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-app}
    # Internal only; no host port publish needed
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 10
    volumes:
      - pg_data:/var/lib/postgresql/data

  maildev:
    image: maildev/maildev:2.0.5
    ports:
      - "${MAILDEV_UI_PORT:-1080}:1080"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:1080 >/dev/null 2>&1 || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 10

volumes:
  pg_data:
