services:
  api:
    volumes:
      - ./api:/app
      - api_node_modules:/app/node_modules
    command: sh -c "npm install && npm run db:migrate && npm run dev"
    environment:
      # Chat tracing (dev: enabled by default)
      - CHAT_TRACE_ENABLED=${CHAT_TRACE_ENABLED:-true}
      - CHAT_TRACE_RETENTION_DAYS=${CHAT_TRACE_RETENTION_DAYS:-7}
      # Document storage (dev): MinIO by default (override DOC_STORAGE_* to use Scaleway S3)
      - DOC_STORAGE_ENDPOINT=${DOC_STORAGE_ENDPOINT:-http://minio:9000}
      - DOC_STORAGE_REGION=${DOC_STORAGE_REGION:-fr-par-1}
      - DOC_STORAGE_BUCKET=${DOC_STORAGE_BUCKET:-top-ai-ideas-dev}
      # IMPORTANT: avoid leaking real Scaleway creds from host env into dev MinIO.
      - DOC_STORAGE_ACCESS_KEY=${DOC_STORAGE_ACCESS_KEY:-minioadmin}
      - DOC_STORAGE_SECRET_KEY=${DOC_STORAGE_SECRET_KEY:-minioadmin}

  ui:
    volumes:
      - ./ui:/app
      - ui_node_modules:/app/node_modules
    environment:
      - VITE_API_BASE_URL=${VITE_API_BASE_URL:-http://localhost:8787/api/v1}

  postgres:
    volumes:
      - ./data/backup:/backups

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
    ports:
      - "9001:9001"
    volumes:
      - minio_data:/data

  minio-init:
    image: minio/mc:latest
    profiles: ["init"]
    depends_on:
      minio:
        condition: service_started
    entrypoint: ["/bin/sh", "-c"]
    command: >
      until mc alias set local http://minio:9000 ${MINIO_ROOT_USER:-minioadmin} ${MINIO_ROOT_PASSWORD:-minioadmin}; do
        echo "waiting for minio..." && sleep 1;
      done;
      mc mb --ignore-existing local/${DOC_STORAGE_BUCKET:-top-ai-ideas-dev} || true;
      mc anonymous set none local/${DOC_STORAGE_BUCKET:-top-ai-ideas-dev} || true;
      exit 0
    restart: "no"

volumes:
  api_node_modules:
  ui_node_modules:
  minio_data:
