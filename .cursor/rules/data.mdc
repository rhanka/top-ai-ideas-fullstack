---
description: Database management and migration directives
alwaysApply: true
tags: [database, migrations, drizzle]
---

# DATABASE MANAGEMENT

## Architecture Overview
- **Database**: PostgreSQL 17 (Docker volume: `pg_data`)
- **ORM**: Drizzle ORM with TypeScript (`drizzle-orm/node-postgres`)
- **Migration Tool**: Drizzle Kit
- **Backup**: PostgreSQL native backup tools (pg_dump)
- **Schema Location**: `api/src/db/schema.ts`
- **Migration Files**: `api/drizzle/` directory
- **Connection**: `DATABASE_URL` environment variable (postgres://user:pass@host:5432/db)

## Database Schema Structure

### Core Tables
- `companies` - Company profiles and metadata
- `folders` - Project folders with matrix configuration
- `use_cases` - AI use cases with scoring data
- `settings` - Application configuration and prompts
- `business_config` - Business sectors and processes
- `sessions` - User authentication sessions
- `job_queue` - Async job processing queue

### Data model (diagrammes)
- Le modèle de données (ERD Mermaid) est documenté dans `spec/DATA_MODEL.md` (source de vérité alignée sur `api/src/db/schema.ts`).
- Si le schéma Drizzle change (`api/src/db/schema.ts` + migrations), mettre à jour `spec/DATA_MODEL.md`.

### Schema Conventions
- **Primary Keys**: UUID strings (uuid type)
- **Timestamps**: ISO strings with `CURRENT_TIMESTAMP` default
- **JSON Fields**: PostgreSQL JSONB type for efficient querying
- **Foreign Keys**: Proper references with cascade deletes
- **Naming**: snake_case for columns, camelCase for TypeScript

## Migration Workflow

### Development Workflow
1. **Modify Schema**: Update `api/src/db/schema.ts`
2. **Generate Migration**: `make db-generate`
3. **Review Migration**: Check generated SQL in `api/drizzle/`
4. **Apply Migration**: `make db-migrate`
5. **Test Changes**: Run tests to ensure compatibility

### Migration Commands (via Make)
- `make db-generate` - Generate new migration files from schema changes
- `make db-migrate` - Apply pending migrations to database
- `make db-reset` - Reset database (drop + recreate + migrate)
- `make db-init` - Initialize database with all migrations
- `make db-status` - Check database status and table structure
- `make db-seed` - Populate database with sample data

### Production Migration Strategy
1. **Backup First**: `make db-backup` before any migration
2. **Test Migration**: Apply to staging environment first
3. **Rollback Plan**: Keep backup for quick restoration
4. **Monitor**: Check application health after migration
5. **Verify**: `make db-status` to confirm schema changes

## Schema Evolution Rules

### Safe Changes (No Migration Required)
- Adding new nullable columns
- Adding new tables
- Adding new indexes
- Adding new constraints on new data

### Breaking Changes (Require Migration)
- Renaming columns or tables
- Changing column types
- Dropping columns or tables
- Adding NOT NULL constraints to existing columns
- Changing primary keys

### Migration Best Practices
- **Atomic Changes**: One logical change per migration
- **Backward Compatibility**: Maintain compatibility during transitions
- **Data Migration**: Include data transformation in migration scripts
- **Validation**: Add checks to ensure data integrity
- **Documentation**: Document breaking changes in migration files
- **Single migration per branch**: Only one `api/drizzle/*.sql` file per branch; if multiple evolutions happen, patch down to a single final migration before completion.

## Backup and Recovery

### PostgreSQL Backup Configuration
- **Backup Tool**: `pg_dump` (PostgreSQL native)
- **Target**: File-based backups (can be stored on S3)
- **Frequency**: Manual or scheduled via cron/jobs
- **Retention**: Configurable backup retention

### Backup Commands
- `make db-backup` - Create manual backup file using pg_dump
- `make db-restore [BACKUP_FILE=filename]` - Restore from backup using pg_restore
- **Automatic**: Can be scheduled via cron or external backup service

### Recovery Procedures
1. **Stop Application**: Prevent data corruption
2. **Restore Backup**: `make db-restore BACKUP_FILE=backup.sql`
3. **Verify Schema**: `make db-status`
4. **Run Tests**: Ensure application functionality
5. **Restart Application**: Resume normal operations

## Data Integrity and Validation

### Schema Validation
- **Type Safety**: Drizzle provides TypeScript types
- **Runtime Validation**: Zod schemas for API endpoints
- **Migration Checks**: Drizzle validates migration compatibility

### Data Quality Rules
- **Required Fields**: Enforce NOT NULL constraints
- **Foreign Keys**: Maintain referential integrity
- **JSON Validation**: Validate JSON structure in application layer
- **Business Rules**: Implement in application logic, not database

## Development Guidelines

### Local Development
- **Database Location**: Docker volume `pg_data` (PostgreSQL container)
- **Reset Often**: Use `make db-reset` for clean state
- **Seed Data**: Use `make db-seed` for test data
- **Volume Mount**: Docker Compose manages PostgreSQL volume

### Testing Strategy
- **Test Database**: Separate database for tests (via `DATABASE_URL` override)
- **Migration Tests**: Test migrations in isolation
- **Data Validation**: Test schema changes with sample data
- **Rollback Tests**: Verify rollback procedures

### Performance Considerations
- **Indexes**: Add indexes for frequently queried columns
- **JSON Fields**: PostgreSQL JSONB provides efficient querying and indexing
- **Connection Pooling**: Use connection pooling (node-postgres pool)
- **Query Optimization**: Monitor slow queries and optimize with EXPLAIN ANALYZE

## Troubleshooting

### Common Issues
- **Migration Conflicts**: Resolve by regenerating migrations
- **Schema Drift**: Use `make db-status` to check consistency
- **Backup Failures**: Check PostgreSQL permissions and disk space
- **Connection Issues**: Verify DATABASE_URL format and PostgreSQL service health
- **Lock Issues**: PostgreSQL handles concurrent access with MVCC (Multi-Version Concurrency Control)

### Debug Commands
- `make db-status` - Check database structure and migrations
- `make logs-db` - View database container logs
- `make sh-api` - Access API container for manual inspection

## Integration with Workflow

### Feature Development
1. **Schema Changes**: Document in BRANCH.md
2. **Migration Testing**: Test migrations before committing
3. **Backup Strategy**: Backup before major schema changes
4. **Validation**: Ensure tests pass with new schema

### CI/CD Integration
- **Migration Validation**: CI runs migrations on test database
- **Schema Consistency**: Verify schema matches migrations
- **Backup Verification**: Ensure backup/restore procedures work
- **Test Data**: Populate test database with seed data
