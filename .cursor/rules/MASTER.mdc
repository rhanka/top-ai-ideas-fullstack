# MASTER RULES - Consolidated AI Development Rules

## Discuss with developer
When starting a discussion, the focus should be to pick the next `TODO.md` item (unless instructed otherwise) after reading all instructions. Create a branch and a `BRANCH.md` plan for the work (see workflow below).

## Overview
This file consolidates all development rules into a single source of truth for AI assistants. All other `.mdc` files provide detailed specifications for specific domains.

## Core Architecture Principles
As a very first thing, when you work on features, you must acknowledge that you will only work through `make` and that all execution is containerized.

## Make Responsibilities (MANDATORY commands)
- **Install Libs**: `make install-<ui/api> ${NPM_LIB}` to install a lib (`make install-<ui/api>-dev ${NPM_LIB}` for dev mode)
- **Build & Quality**: `make build`, `make typecheck`, `make lint`, `make format`
- **Testing**: `make test`, `make test-e2e`, `make test-smoke`, `make test-vitest-*`
- **Database Management**: `make db-init`, `make db-migrate`, `make db-backup`, `make db-restore`, `make db-seed`
- **Development**: `make dev`, `make down`, `make logs`
- **Documentation**: `make openapi-json`, `make openapi-html`
- **Deployment**: `make docker-build`, `make deploy-ui`, `make deploy-api`

### Docker-First Architecture (MANDATORY)
- **NO native npm/python on developer machine** - Docker containers only
- **ALL development commands MUST go through Make** - no exceptions
- **Make commands execute in Docker** - consistent environment across all developers
- **Dependencies managed in containers** - never install npm/python globally
- **Clean workspace** - no node_modules, no .venv, no global packages
- **Same commands work locally and in CI** - no drift allowed
- **NO git add .** - commits are atomic and controlled
- **NO direct Docker commands** - use Make targets only

### Compose Isolation (MANDATORY)
- Use `ENV=<branch-slug>` as the short alias; `COMPOSE_PROJECT_NAME` is derived from `ENV` in `Makefile`.
- Before starting services, verify required host ports are free or already owned by the same Compose project.
- If a port is taken by another Compose project, pick a new port and set:
  - `API_PORT`, `UI_PORT`, `MAILDEV_UI_PORT`
- Keep `VITE_API_BASE_URL` aligned with `API_PORT`.
- Default ports are defined in `Makefile` and can be overridden via environment variables.
- Example usage (apply to all Make commands):
  - `ENV=feat-refactor-mdc API_PORT=8788 UI_PORT=5174 MAILDEV_UI_PORT=1081 make dev`
  - `ENV=feat-refactor-mdc make ps`
  - `ENV=feat-refactor-mdc make exec-api CMD="node -v"`

## Debug & Inspection Commands (MANDATORY)
- **State**: `make ps`, `make ps-all`
- **Logs**: `make logs`, `make logs-<service>` (e.g., `make logs-ui`, `make logs-api`)
- **Database**: `make db-query QUERY="SELECT ..."` and `make db-status`
- **Shell/Exec**: `make sh-ui`, `make sh-api`, `make exec-ui CMD="..."`, `make exec-api CMD="..."`

## Development Workflow (MANDATORY)

1. Read this file (MASTER.mdc) for rules overview
2. Read `README.md` for project context and high level specifications
3. Read `TODO.md` for **Now** items
4. Follow `workflow.mdc` process, including `testing.mdc` and `security.mdc`

## Guide Maintenance

### Update Workflow (MANDATORY)
1. **Rules change** → Update `.mdc` file FIRST (source of truth)
2. **Documentation** → Update `.md` file SECOND
3. **Verify consistency** → Run `make check`

### Branch Docs for Complex Work
- Use `BRANCH_TEMPLATE.md` when creating `BRANCH.md`.
- For complex branches, create `spec/BRANCH_SPEC_EVOL.md` early, then consolidate into existing specs and delete it before final validation.

## Security & Compliance

### Human Approval Required (⚠ approval)
- Destructive DB/system actions
- Production deployments
- Security-sensitive changes

### Default Behaviors
- **Dry-run by default** for critical operations
- **Full journaling** of all actions
- **Least privilege** access model

## Language Policy
- All code, comments, commit messages, PR titles/descriptions, API schemas and server errors MUST be in **English**
- All Markdown and MDC files MUST be in **English**

### Code & Rules
- **ALL code, comments, rules in English**
- **API schemas in English**
- **Error messages in English**
- **Discuss with user in French (or English if he requires)**

### UI Localization
- **UI supports FR (to be EN)**
- **i18n coverage enforced** by CI (to be)
- **Keys must be stable** across locales

## File Structure

### `.mdc` Files (AI Rules)
- `architecture.mdc` - Core architecture principles + UI framework + Language policy
- `workflow.mdc` - Development process + conventions + maintenance workflow
- `testing.mdc` - Testing strategy + E2E testing + implementation guide
- `security.mdc` - Security practices
- `data.mdc` - Data model and migration directives

### Documentation Files (User Guides)
- `README.md` - Project overview and setup
- `TODO.md` - Current priorities and items
