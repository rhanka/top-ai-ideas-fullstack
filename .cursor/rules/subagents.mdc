---
description: Sub-agent onboarding and execution contract
alwaysApply: true
tags: [orchestration, subagent, workflow]
---

# SUBAGENTS

## Goal
Provide a minimal and repeatable contract so each sub-agent can deliver one orthogonal lot safely.

## Mandatory Read Order
1. `.cursor/rules/workflow.mdc`
2. `.cursor/rules/MASTER.mdc`
3. `.cursor/rules/subagents.mdc`
4. Scope-relevant rules: `architecture.mdc`, `testing.mdc`, `security.mdc`, `data.mdc`, `components.mdc`, `design-system.mdc`, `conductor.mdc`
5. `README.md` and `TODO.md`
6. `PLAN.md` (mandatory when present, especially for branch dependencies/waves/status)
7. Relevant `spec/*.md` files for the current scope
8. Branch execution file (`BRANCH.md`, `tmp/<branch-slug>/BRANCH.md`, or `plan/NN-BRANCH_*.md`)
9. `plan/BRANCH_TEMPLATE.md` (mandatory reference when creating/updating `BRANCH.md`)

## Required Launch Packet (from conductor)
- Branch id, branch name, and working directory.
- Exact scope (lot, files in scope, files out of scope).
- Allowed Paths / Forbidden Paths / Conditional Paths.
- `PLAN.md` context for the branch (dependencies, wave, status).
- Relevant SPEC references to enforce.
- Explicit branch design instruction (`Instruction specifique`) for this run.
- Environment mapping (`ENV`, `API_PORT`, `UI_PORT`, `MAILDEV_UI_PORT`).
- Port ownership check result (ports are free or already owned by same branch env).
- Expected outputs (artifacts, tests, checkboxes to update).
- Stop conditions requiring conductor decision.
- Scope exception format (`BRxx-EXn`) if conditional/forbidden path changes are requested.
- Commit policy (`make commit`, selective `git add`, never `git add .`).

## Execution Rules
- Use Make targets only (no direct Docker commands).
- Keep `ENV=<env>` as the last argument in all Make commands.
- At end of each completed lot, stop the branch environment with `make down ENV=<branch-env>`, unless conductor explicitly requests to keep it up for immediate UAT.
- Edit only files matching `Allowed Paths`.
- Do not change `Forbidden Paths`.
- Treat `Conditional Paths` as blocked until `BRxx-EXn` is approved, unless they are explicitly listed in `Allowed Paths`.
- Change only files in scope.
- Keep all code/comments/docs in English.
- Do not commit or push unless explicitly requested in the launch packet.
- Do not silently resolve ambiguities; raise a structured question.
- Planning mode depth rule (mandatory for first `BRANCH.md` iteration):
  - produce a detailed lot-by-lot plan (not high-level placeholders);
  - list API/UI/E2E tests at file granularity (existing + new + updated files);
  - include detailed UAT checklist by impacted surface (`web app`, `chrome plugin`, `vscode plugin`);
  - use `Feedback Loop` items for blockers/clarifications directly in `BRANCH.md`.

## Port Safety Rules
- Never start services on ports that belong to another active branch environment.
- If a mapped port is occupied by another compose project, stop and request a new mapping from conductor.
- Keep `ENV` explicit and consistent in all Make commands.

## Reporting Contract
Return a short structured brief:
1. `Done`: concrete changes with file paths.
2. `Checks`: commands executed and outcomes.
3. `Feedback Loop`: IDs/status (`blocked`, `attention`, `clarification`, `acknowledge`, `refuse`), options, recommendation.
4. `Risks`: regressions, dependencies, or follow-up actions.
5. `Scope adherence`: any `BRxx-EXn` used or `none`.
6. `Read set`: `.mdc` files + SPEC files actually read.

Question discipline:
- escalate only after collecting technical evidence and attempted focused checks;
- batch questions once per lot unless a new hard blocker appears.

## Restart / Relaunch Protocol
When interrupted or relaunched:
1. run `git status --short`;
2. read the current branch execution file;
3. review unresolved `Feedback Loop` blockers first;
4. resume from the first unchecked item of the active lot;
5. preserve prior decisions unless the conductor explicitly overrides them;
6. report only the delta since last run.

## Branch Closure Handoff
Before branch closure, provide:
1. final lot checkbox status (including tests/UAT checkpoints);
2. final `Feedback Loop` status list (or explicit `none`);
3. cleanup status for branch environment (must run `make down ENV=<branch-env>` then `make ps ENV=<branch-env>` and report no remaining services; skip only if conductor explicitly asks to keep env up for immediate UAT);
4. explicit note of any residual risk to merge;
5. confirmation that all blocking feedback items are resolved as `acknowledge`/`refuse`/`deferred`/`cancelled` before merge;
6. for UAT branches/worktrees, confirmation of commit-identical SHA with source branch.
